<!-- js.html -->
<script>
// === Global Variables ===
let chartInstance = null;
let projectProgressChart = null;
let staffPerformanceChart = null;
let allProjects = [];
let allTasks = [];
let allStaff = [];
let allNotifications = [];
let currentSection = 'overview';
let currentUser = null; // Store current logged in user
let isAuthenticated = false;

// === Sync System Variables ===
let syncIntervals = {
    notifications: null,
    data: null
};
let lastSyncTime = null;
let isSyncing = false;
let userIsInteracting = false;
let interactionTimeout = null;

// === Sync Configuration ===
const SYNC_CONFIG = {
    NOTIFICATION_INTERVAL: 120000,  // 2 minutes (tƒÉng t·ª´ 30s)
    DATA_INTERVAL: 300000,         // 5 minutes (tƒÉng t·ª´ 1 minute)  
    USER_INTERACTION_DELAY: 5000, // 5 seconds after user stops interacting
    SYNC_RETRY_DELAY: 10000       // 10 seconds retry delay
};

// === Gantt Chart Variables ===
let currentGanttDate = new Date();
let expandedProjects = new Set(); // L∆∞u ID c·ªßa c√°c d·ª± √°n ƒëang x·ªï

// === Constants matching backend ===
const COL = {
    P_ID: "M√£ d·ª± √°n", P_NAME: "T√™n d·ª± √°n", P_DESC: "M√¥ t·∫£ d·ª± √°n",
    P_MANAGER: "Qu·∫£n l√Ω d·ª± √°n", P_START: "Ng√†y b·∫Øt ƒë·∫ßu", P_END: "Ng√†y k·∫øt th√∫c",
    P_STATUS: "Tr·∫°ng th√°i d·ª± √°n", P_IS_PUBLIC: "D·ª± √°n chung",
    T_ID: "M√£ nhi·ªám v·ª•", T_PID: "M√£ d·ª± √°n", T_NAME: "T√™n nhi·ªám v·ª•",
    T_DESC: "M√¥ t·∫£ nhi·ªám v·ª•", T_ASSIGNEE: "Ng∆∞·ªùi th·ª±c hi·ªán", T_STATUS: "Tr·∫°ng th√°i",
    T_PRIORITY: "∆Øu ti√™n", T_START: "Ng√†y b·∫Øt ƒë·∫ßu", T_DUE: "H·∫°n ch√≥t",
    T_COMPLETION: "Ti·∫øn ƒë·ªô (%)", T_REPORT_DATE: "Ng√†y b√°o c√°o", T_TARGET: "M·ª•c ti√™u", T_RESULT_LINKS: "Link k·∫øt qu·∫£", T_OUTPUT: "K·∫øt qu·∫£ ƒë·∫ßu ra", T_NOTES: "Ghi ch√∫",
    S_ID: "M√£ NV", S_NAME: "H·ªç t√™n", S_EMAIL: "Email", S_POS: "Ch·ª©c v·ª•",
    S_ROLE: "Ph√¢n quy·ªÅn", S_PASSWORD: "M·∫≠t kh·∫©u",
    A_TIME: "Th·ªùi gian", A_ACTION: "H√†nh ƒë·ªông", A_USER: "Ng∆∞·ªùi th·ª±c hi·ªán", A_DETAILS: "Chi ti·∫øt",
    N_ID: "M√£ th√¥ng b√°o", N_TIME: "Th·ªùi gian", N_USER: "Ng∆∞·ªùi nh·∫≠n", N_CONTENT: "N·ªôi dung"  // ‚Üê TH√äM N_USER
};

// === Initialization ===
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    checkAuthenticationAndInitialize();
});

function initializeApp() {
    // showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
    
    google.script.run
        .withSuccessHandler(function(data) {
            // hideLoading();
            if (data.error) {
                showToast(data.error, 'error');
                return;
            }
            
            // Store data globally
            allProjects = data.projects || [];
            allTasks = data.tasks || [];
            allStaff = data.staff || [];
            
            // Render all sections
            renderStats(data.summaryStats);
            renderProjectTaskTree();
            renderPriorityTasks();
            renderProjects();
            renderTasks();
            renderStaff();
            renderChart(data.chartData);
            renderProjectProgressChart();
            renderStaffPerformanceChart();
            renderActivity(data.recentActivities);
            renderNotifications(data.notifications);
            
            // Populate dropdowns
            populateDropdowns();
            
            showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng!', 'success');
        })
        .withFailureHandler(function(error) {
            // hideLoading();
            showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        })
        .getInitialData();
}

function checkAuthenticationAndInitialize() {
    // Hide sidebar by default until user logs in
    document.body.classList.add('sidebar-collapsed');
    const toggleBtn = document.getElementById('sidebar-toggle');
    if (toggleBtn) {
        const icon = toggleBtn.querySelector('i');
        if (icon) icon.className = 'fas fa-bars text-gray-600';
    }
    
    showLoading('ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p...');
    
    google.script.run
        .withSuccessHandler(function(response) {
            hideLoading();
            
            if (response.requireLogin) {
                // User not logged in, show login modal
                showLoginModal();
            } else if (response.success) {
                // User is logged in, initialize app
                handleSuccessfulLogin(response);
            } else {
                // Error occurred
                showToast(response.error || 'L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p', 'error');
                showLoginModal();
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            showToast('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            showLoginModal();
        })
        .getInitialDataWithAuth();
}

function showLoginModal() {
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.classList.remove('opacity-0', 'invisible');
        loginModal.querySelector('.bg-white\\/90').classList.remove('scale-95');
        loginModal.querySelector('.bg-white\\/90').classList.add('scale-100');
        
        // Focus on email input
        setTimeout(() => {
            document.getElementById('login-email')?.focus();
        }, 300);
    }
}

function hideLoginModal() {
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.querySelector('.bg-white\\/90').classList.remove('scale-100');
        loginModal.querySelector('.bg-white\\/90').classList.add('scale-95');
        
        setTimeout(() => {
            loginModal.classList.add('opacity-0', 'invisible');
        }, 200);
    }
}

function handleLogin(email, password) {
    if (!email || !password) {
        showLoginError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u');
        return;
    }

    setLoginLoading(true);
    
    google.script.run
        .withSuccessHandler(function(response) {
            setLoginLoading(false);
            
            if (response.success) {
                hideLoginModal();
                hideLoginError();
                
                // Get user data and initialize
                google.script.run
                    .withSuccessHandler(function(dataResponse) {
                        if (dataResponse.success) {
                            handleSuccessfulLogin(dataResponse);
                            showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                        } else {
                            showToast(dataResponse.error || 'L·ªói khi t·∫£i d·ªØ li·ªáu', 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
                    })
                    .getDataForUser();
                    
            } else {
                showLoginError(response.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
            }
        })
        .withFailureHandler(function(error) {
            setLoginLoading(false);
            showLoginError('L·ªói k·∫øt n·ªëi: ' + error.message);
        })
        .authenticateUser(email, password);
}

function handleSuccessfulLogin(dataResponse) {
    currentUser = dataResponse.user;
    isAuthenticated = true;
    
    // Store data globally
    allProjects = dataResponse.projects || [];
    allTasks = dataResponse.tasks || [];
    allStaff = dataResponse.staff || [];
    
    // Update UI based on user role
    updateUIForUser(currentUser);
    
    // Render all sections
    renderStats(dataResponse.summaryStats);
    renderProjectTaskTree();
    renderPriorityTasks();
    renderProjects();
    renderTasks();
    renderStaff();
    renderChart(dataResponse.chartData);
    renderProjectProgressChart();
    renderStaffPerformanceChart();
    renderActivity(dataResponse.recentActivities);
    renderNotifications(dataResponse.notifications);
    
    // Populate dropdowns
    populateDropdowns();

    // Th√™m thi·∫øt l·∫≠p cho Gantt chart
    setupGanttEventListeners();
    if (currentSection === 'gantt') {
      renderGanttChart();
    }
    
    // Initialize Smart Sync System
    startSyncSystemForUser();
}

function updateUIForUser(user) {
  const isAdminUser = isAdmin();
  const isManagerUser = user.role && user.role.toLowerCase().includes('qu·∫£n l√Ω');
  
  // Show sidebar when user logs in successfully
  const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  if (!sidebarCollapsed) {
    document.body.classList.remove('sidebar-collapsed');
    const toggleBtn = document.getElementById('sidebar-toggle');
    if (toggleBtn) {
      const icon = toggleBtn.querySelector('i');
      if (icon) icon.className = 'fas fa-times text-gray-600';
    }
  }
  
  // Update user info in sidebar
  document.getElementById('user-info').classList.remove('hidden');
  document.getElementById('login-prompt').classList.add('hidden');
  
  const userName = document.getElementById('user-name');
  const userRole = document.getElementById('user-role');
  
  if (userName && userRole) {
    userName.textContent = user.name;
    userRole.textContent = user.role;
  }
  
  // THAY ƒê·ªîI: Ki·ªÉm tra xem nh√¢n vi√™n c√≥ ph·∫£i l√† ng∆∞·ªùi ph·ª• tr√°ch d·ª± √°n n√†o kh√¥ng
  const isProjectManager = allProjects.some(project => project[COL.P_MANAGER] === user.name);
  
  // Hide/show navigation items based on role
  const projectsNav = document.getElementById('projects-nav');
  const staffNav = document.getElementById('staff-nav');
  
  if (isAdminUser) {
    // Show all nav items for admin
    if (projectsNav) projectsNav.style.display = 'flex';
    if (staffNav) staffNav.style.display = 'flex';
    showAdminButtons();
  } 
  else if (isManagerUser) {
    // Show projects nav for managers, hide staff nav
    if (projectsNav) projectsNav.style.display = 'flex';
    if (staffNav) staffNav.style.display = 'none';
    hideAdminButtons();
  } 
  else {
    // THAY ƒê·ªîI: Hi·ªÉn th·ªã tab D·ª± √°n cho nh√¢n vi√™n ph·ª• tr√°ch d·ª± √°n
    if (projectsNav) {
      projectsNav.style.display = isProjectManager ? 'flex' : 'none';
    }
    if (staffNav) staffNav.style.display = 'none';
    hideAdminButtons();
  }

  // Hi·ªÉn th·ªã button th√™m th√¥ng b√°o cho t·∫•t c·∫£ ng∆∞·ªùi d√πng ƒë√£ x√°c th·ª±c
  const addNotificationBtn = document.getElementById('add-notification-btn');
  if (addNotificationBtn) addNotificationBtn.classList.remove('hidden'); // Show for all authenticated users
  
  // Update page title to show current user
  updatePageTitle();
}

function hideAdminButtons() {
  // Hide admin-only buttons 
  const adminButtons = [
    'add-staff-btn',
    'quick-add-staff',
    'clear-activity-btn'
  ];
  
  adminButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.style.display = 'none';
    }
  });
  
  // THAY ƒê·ªîI: Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ ph·∫£i l√† ng∆∞·ªùi ph·ª• tr√°ch d·ª± √°n n√†o kh√¥ng
  const isProjectManager = allProjects.some(project => project[COL.P_MANAGER] === currentUser.name);
  
  // Hi·ªÉn th·ªã/·∫©n project buttons based on permissions
  const projectButtons = [
    'add-project-btn',
    'add-project-standalone',
    'quick-add-project'
  ];
  
  projectButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      if (isManager() || isProjectManager) {
        button.style.display = ''; // Hi·ªÉn th·ªã n·∫øu l√† qu·∫£n l√Ω ho·∫∑c ng∆∞·ªùi ph·ª• tr√°ch d·ª± √°n
      } else {
        button.style.display = 'none'; // ·∫®n n·∫øu kh√¥ng ph·∫£i
      }
    }
  });
  
  // Ki·ªÉm tra v√† ·∫©n/hi·ªán task buttons based on permissions
  const taskButtons = [
    'add-task-btn',
    'add-task-standalone',
    'quick-add-task'
  ];
  
  taskButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      if (canUserCreateTask()) {
        button.style.display = ''; // Hi·ªÉn th·ªã
      } else {
        button.style.display = 'none'; // ·∫®n
      }
    }
  });
  
  // Hide admin action buttons in cards
  document.addEventListener('DOMContentLoaded', function() {
    hideActionButtons();
  });
}

function showAdminButtons() {
  // Show admin-only buttons
  const adminButtons = [
    'add-project-btn',
    'add-project-standalone', 
    'add-task-btn',
    'add-task-standalone',
    'add-staff-btn',
    'quick-add-project',
    'quick-add-task',
    'quick-add-staff',
    'clear-activity-btn'
  ];
  
  adminButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.style.display = '';
    }
  });
}

function hideActionButtons() {
  const actionButtons = document.querySelectorAll('.edit-btn, .delete-btn');
  actionButtons.forEach(button => {
    const type = button.dataset.type;
    const id = button.dataset.id;
    
    if (isAdmin()) {
      // Admin c√≥ quy·ªÅn ƒë·ªëi v·ªõi t·∫•t c·∫£
      return;
    }
    
    if (isManager()) {
      // Qu·∫£n l√Ω c√≥ th·ªÉ thao t√°c v·ªõi project v√† task, nh∆∞ng kh√¥ng v·ªõi staff
      if (type === 'staff') {
        button.style.display = 'none';
      }
    } 
    else if (type === 'project' || type === 'staff') {
      // Nh√¢n vi√™n th∆∞·ªùng kh√¥ng th·ªÉ s·ª≠a/x√≥a d·ª± √°n v√† nh√¢n vi√™n
      button.style.display = 'none';
    } 
    else if (type === 'task') {
      // Ki·ªÉm tra n·∫øu task thu·ªôc d·ª± √°n m√† ng∆∞·ªùi d√πng qu·∫£n l√Ω
      const task = allTasks.find(t => t[COL.T_ID] === id);
      if (task) {
        const projectId = task[COL.T_PID];
        const project = allProjects.find(p => p[COL.P_ID] === projectId);
        
        // Hi·ªÉn th·ªã n√∫t n·∫øu ng∆∞·ªùi d√πng l√† ng∆∞·ªùi qu·∫£n l√Ω d·ª± √°n ho·∫∑c ng∆∞·ªùi ƒë∆∞·ª£c giao
        if (project && project[COL.P_MANAGER] === currentUser.name) {
          return; // Hi·ªÉn th·ªã n√∫t
        }
        
        // ·∫®n n√∫t n·∫øu ng∆∞·ªùi d√πng kh√¥ng ph·∫£i ng∆∞·ªùi ƒë∆∞·ª£c giao
        if (task[COL.T_ASSIGNEE] !== currentUser.name) {
          button.style.display = 'none';
        }
      }
    }
  });
}

function handleLogout() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        // showLoading('ƒêang ƒëƒÉng xu·∫•t...');
        
        google.script.run
            .withSuccessHandler(function(response) {
                // hideLoading();
                
                // Reset application state
                currentUser = null;
                isAuthenticated = false;
                allProjects = [];
                allTasks = [];
                allStaff = [];
                
                // Stop sync system
                stopSyncSystemForUser();
                
                // Reset UI
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('login-prompt').classList.remove('hidden');
                
                // Clear all sections
                clearAllSections();
                
                // Show login modal
                showLoginModal();
                
                showToast('ƒêƒÉng xu·∫•t th√†nh c√¥ng', 'success');
            })
            .withFailureHandler(function(error) {
                // hideLoading();
                showToast('L·ªói khi ƒëƒÉng xu·∫•t: ' + error.message, 'error');
            })
            .logout();
    }
}

function setLoginLoading(isLoading) {
    const submitBtn = document.getElementById('login-submit-btn');
    const btnText = document.getElementById('login-btn-text');
    
    if (isLoading) {
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        btnText.textContent = '';
    } else {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        btnText.textContent = 'ƒêƒÉng nh·∫≠p';
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('login-error');
    const errorMessage = document.getElementById('login-error-message');
    
    if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
    }
}

function clearAllSections() {
    // Clear all section content
    const sectionsToSelect = [
        '#projects-pending',
        '#projects-active', 
        '#projects-completed',
        '#tasks-by-project', 
        '#staff-grid',
        '#project-task-tree',
        '#priority-tasks',
        '#recent-activity'
    ];
    
    sectionsToSelect.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.innerHTML = '<div class="loading-card">Vui l√≤ng ƒëƒÉng nh·∫≠p</div>';
        }
    });
    
    // Clear stats
    const statsElements = [
        'total-projects', 'completed-projects', 'project-completion-rate',
        'total-tasks', 'completed-tasks', 'task-completion-rate',
        'active-tasks', 'pending-tasks',
        'overdue-tasks', 'overdue-total-tasks', 'overdue-rate'
    ];
    
    statsElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '-';
        }
    });
}

function updatePageTitle() {
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        const sectionTitles = {
            'overview': 'T·ªïng quan',
            'projects': 'Qu·∫£n l√Ω D·ª± √°n', 
            'tasks': 'Qu·∫£n l√Ω Nhi·ªám v·ª•',
            'staff': 'Qu·∫£n l√Ω Nh√¢n vi√™n'
        };
        
        const baseTitle = sectionTitles[currentSection] || 'Dashboard';
        pageTitle.textContent = baseTitle;
    }
}

function isAdmin() {
    return currentUser && currentUser.role && currentUser.role.toLowerCase().includes('admin');
}

function isManager() {
  return currentUser && currentUser.role && currentUser.role.toLowerCase().includes('qu·∫£n l√Ω');
}


function hideLoginError() {
    const errorDiv = document.getElementById('login-error');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
}

// === Event Listeners ===
function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            if (section !== 'activity' && isAuthenticated) {
                switchSection(section);
            }
        });
    });

    // Mobile menu
    document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);
    document.getElementById('mobile-overlay').addEventListener('click', closeMobileMenu);
    
    // Sidebar toggle
    document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);

    // Authentication buttons
    document.getElementById('login-btn')?.addEventListener('click', showLoginModal);
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
    
    // Login form
    document.getElementById('login-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        handleLogin(email, password);
    });

    // Quick add buttons - only work if user is authenticated and has permission
    document.getElementById('quick-add-project')?.addEventListener('click', () => {
      // Thay ƒë·ªïi ƒëi·ªÅu ki·ªán t·ª´ isAdmin() th√†nh isAdmin() || isManager()
      if (isAuthenticated && (isAdmin() || isManager())) openModal('project');
    });
    document.getElementById('quick-add-task')?.addEventListener('click', () => {
        if (isAuthenticated && isAdmin()) openModal('task');
    });
    document.getElementById('quick-add-staff')?.addEventListener('click', () => {
        if (isAuthenticated && isAdmin()) openModal('staff');
    });

    // Add buttons
    document.getElementById('add-project-btn')?.addEventListener('click', () => {
      // Thay ƒë·ªïi ƒëi·ªÅu ki·ªán t·ª´ isAdmin() th√†nh isAdmin() || isManager()
      if (isAuthenticated && (isAdmin() || isManager())) openModal('project');
    });
    document.getElementById('add-project-standalone')?.addEventListener('click', () => {
      // Thay ƒë·ªïi ƒëi·ªÅu ki·ªán t·ª´ isAdmin() th√†nh isAdmin() || isManager()
      if (isAuthenticated && (isAdmin() || isManager())) openModal('project');
    });
    document.getElementById('add-task-btn')?.addEventListener('click', () => {
        if (isAuthenticated && canUserCreateTask()) openModal('task');
    });
    document.getElementById('add-task-standalone')?.addEventListener('click', () => {
        if (isAuthenticated && canUserCreateTask()) openModal('task');
    });

    // V√† d√≤ng n√†y:
    document.getElementById('quick-add-task')?.addEventListener('click', () => {
        if (isAuthenticated && canUserCreateTask()) openModal('task');
    });

    // Th√™m event listener cho n√∫t th√™m th√¥ng b√°o - T·∫•t c·∫£ user c√≥ th·ªÉ g·ª≠i
    document.getElementById('add-notification-btn')?.addEventListener('click', () => {
      if (isAuthenticated) openModal('notification'); // Allow all authenticated users
    });

    // Search
    document.getElementById('search-input')?.addEventListener('input', handleSearch);
    document.getElementById('project-task-search')?.addEventListener('input', handleProjectTaskSearch);

    // Notifications
    document.getElementById('notification-btn')?.addEventListener('click', toggleNotifications);
    document.getElementById('clear-notifications')?.addEventListener('click', clearNotifications);

    // Clear activity button (admin only)
    document.getElementById('clear-activity-btn')?.addEventListener('click', clearActivity);

    // Sync button
    document.getElementById('sync-btn')?.addEventListener('click', handleManualSync);

    // User interaction detection for smart sync
    setupUserInteractionDetection();

    // Global click handler for action buttons
    document.addEventListener('click', function(e) {
        if (!isAuthenticated) return;
        
        if (e.target.matches('.edit-btn') || e.target.closest('.edit-btn')) {
            const btn = e.target.matches('.edit-btn') ? e.target : e.target.closest('.edit-btn');
            const type = btn.dataset.type;
            const id = btn.dataset.id;
            
            // Check permissions
            if (canUserEditResource(type, id)) {
                openEditModal(type, id);
            } else {
                showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a m·ª•c n√†y', 'error');
            }
        }
        
        // Task card click handler - open edit modal
        if (e.target.matches('.task-card-clickable') || e.target.closest('.task-card-clickable')) {
            // Don't trigger if clicking on buttons
            if (e.target.matches('.action-btn') || e.target.closest('.action-btn')) {
                return;
            }
            
            const card = e.target.matches('.task-card-clickable') ? e.target : e.target.closest('.task-card-clickable');
            const type = card.dataset.type;
            const id = card.dataset.id;
            
            // Check permissions
            if (canUserEditResource(type, id)) {
                openEditModal(type, id);
            } else {
                showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a m·ª•c n√†y', 'error');
            }
        }
        
        if (e.target.matches('.delete-btn') || e.target.closest('.delete-btn')) {
            const btn = e.target.matches('.delete-btn') ? e.target : e.target.closest('.delete-btn');
            const type = btn.dataset.type;
            const id = btn.dataset.id;
            const name = btn.dataset.name || id;
            
            // Check permissions
            if (canUserDeleteResource(type, id)) {
                confirmDelete(type, id, name);
            } else {
                showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a m·ª•c n√†y', 'error');
            }
        }

        // TH√äM: X·ª≠ l√Ω click v√†o project card
        if (e.target.closest('.clickable-project-card') && !e.target.closest('.action-btn') && !e.target.closest('.kanban-action-btn')) {
            const card = e.target.closest('.clickable-project-card');
            const projectId = card.dataset.id;
            
            if (projectId) {
                // Get project data
                const project = allProjects.find(p => p[COL.P_ID] === projectId);
                const projectName = project ? project[COL.P_NAME] : 'Unknown Project';
                showProjectDetailsModal(projectId, projectName);
            }
        }

        // TH√äM: X·ª≠ l√Ω click v√†o task card
        if (e.target.closest('.clickable-task-card') && !e.target.closest('.action-btn')) {
            const card = e.target.closest('.clickable-task-card');
            const taskId = card.dataset.id;
            
            if (taskId) {
                // M·ªü modal ch·ªânh s·ª≠a task tr·ª±c ti·∫øp
                openEditModal('task', taskId);
            }
        }

        // Project expand/collapse
        if (e.target.matches('.project-expand-btn') || e.target.closest('.project-expand-btn')) {
            const btn = e.target.matches('.project-expand-btn') ? e.target : e.target.closest('.project-expand-btn');
            toggleProjectTasks(btn);
        }

        // Hide Gantt search when clicking outside
        const ganttSearchBtn = document.getElementById('gantt-search-btn');
        const ganttSearchInput = document.getElementById('gantt-search');
        if (ganttSearchBtn && ganttSearchInput && currentSection === 'gantt') {
            if (!ganttSearchBtn.contains(e.target) && !ganttSearchInput.contains(e.target)) {
                ganttSearchInput.classList.add('hidden');
            }
        }
    });

    // Th√™m ph·∫ßn Gantt chart listeners
    setupGanttEventListeners();
}

function showProjectDetailsModal(projectId, projectName) {
    // L·ªçc c√°c nhi·ªám v·ª• thu·ªôc d·ª± √°n n√†y
    const projectTasks = allTasks.filter(task => task[COL.T_PID] === projectId);
    
    // T√≠nh s·ªë li·ªáu th·ªëng k√™
    const totalTasks = projectTasks.length;
    const completedTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length;
    const inProgressTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ƒëang')).length;
    const pendingTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ch∆∞a')).length;
    const overdueTasks = projectTasks.filter(task => isTaskOverdue(task[COL.T_DUE]) && !(task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length;
    const projectProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    // S·∫Øp x·∫øp nhi·ªám v·ª• theo tr·∫°ng th√°i
    projectTasks.sort((a, b) => {
        const statusA = (a[COL.T_STATUS] || '').toLowerCase();
        const statusB = (b[COL.T_STATUS] || '').toLowerCase();
        
        // S·∫Øp x·∫øp theo th·ª© t·ª±: Ho√†n th√†nh -> ƒêang th·ª±c hi·ªán -> Ch∆∞a b·∫Øt ƒë·∫ßu -> Kh√°c
        if (statusA.includes('ho√†n th√†nh') && !statusB.includes('ho√†n th√†nh')) return 1;
        if (!statusA.includes('ho√†n th√†nh') && statusB.includes('ho√†n th√†nh')) return -1;
        if (statusA.includes('ƒëang') && statusB.includes('ch∆∞a')) return -1;
        if (statusA.includes('ch∆∞a') && statusB.includes('ƒëang')) return 1;
        
        return 0;
    });
    
    // T·∫°o HTML cho modal
    const modalHTML = `
        <div id="project-details-modal" class="modal">
            <div class="modal-content max-w-4xl">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Chi ti·∫øt d·ª± √°n: ${projectName}</h3>
                    <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                        ƒê√≥ng
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="glass-card p-4 text-center">
                            <h4 class="text-lg font-semibold text-gray-700">${totalTasks}</h4>
                            <p class="text-sm text-gray-500">T·ªïng nhi·ªám v·ª•</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-green-50">
                            <h4 class="text-lg font-semibold text-green-600">${completedTasks}</h4>
                            <p class="text-sm text-gray-500">Ho√†n th√†nh</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-blue-50">
                            <h4 class="text-lg font-semibold text-blue-600">${inProgressTasks}</h4>
                            <p class="text-sm text-gray-500">ƒêang th·ª±c hi·ªán</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-red-50">
                            <h4 class="text-lg font-semibold text-red-600">${overdueTasks}</h4>
                            <p class="text-sm text-gray-500">Qu√° h·∫°n</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-700">Ti·∫øn ƒë·ªô d·ª± √°n</h4>
                            <span class="text-sm font-semibold">${projectProgress}%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full">
                            <div class="h-full bg-gray-300 rounded-full" style="width: ${projectProgress}%"></div>
                        </div>
                    </div>
                </div>
                
                <h4 class="font-semibold text-gray-900 mb-4">Danh s√°ch nhi·ªám v·ª• (${totalTasks})</h4>
                
                <div class="max-h-96 overflow-y-auto">
                    ${totalTasks > 0 ? 
                        `<div class="space-y-3">
                            ${projectTasks.map(task => createTaskListItem(task)).join('')}
                        </div>` : 
                        `<div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2 opacity-30 font-bold">Nhi·ªám v·ª•</div>
                            <p>Ch∆∞a c√≥ nhi·ªám v·ª• n√†o trong d·ª± √°n n√†y</p>
                        </div>`
                    }
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" class="btn-primary close-modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    `;
    
    // Th√™m modal v√†o DOM
    document.getElementById('modals-container').innerHTML = modalHTML;
    
    // Hi·ªÉn th·ªã modal
    const modal = document.getElementById('project-details-modal');
    modal.classList.add('active');
    
    // Setup close handler
    const closeButtons = modal.querySelectorAll('.close-modal');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal('project-details-modal');
        });
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal('project-details-modal');
        }
    });
}

// H√†m t·∫°o item cho danh s√°ch nhi·ªám v·ª• trong modal
function createTaskListItem(task) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Ch∆∞a c√≥ t√™n';
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Ch∆∞a g√°n';
    const taskStatus = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    const taskPriority = task[COL.T_PRIORITY] || 'Trung b√¨nh';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    const isOverdue = isTaskOverdue(task[COL.T_DUE]) && !(taskStatus.toLowerCase().includes('ho√†n th√†nh'));
    
    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    
    return `
        <div class="glass-card p-4 hover:shadow-md transition-shadow ${isOverdue ? 'border-l-4 border-red-500' : ''}">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h5 class="font-medium text-gray-900">${taskName} <span class="text-gray-500 text-xs">(${taskId})</span></h5>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                        ${isOverdue ? '<span class="status-badge status-overdue">Qu√° h·∫°n</span>' : ''}
                    </div>
                </div>
                
                <div class="ml-4 flex flex-col items-end">
                    <div class="flex items-center text-sm text-gray-600 mb-1">
                        
                        <span>${taskAssignee}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        
                        <span>${taskDueDate}</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                    <span>Ti·∫øn ƒë·ªô</span>
                    <span>${taskCompletion}%</span>
                </div>
                <div class="h-1.5 bg-gray-200 rounded-full">
                    <div class="h-full ${taskStatus.toLowerCase().includes('ho√†n th√†nh') ? 'bg-green-500' : 'bg-blue-500'} rounded-full" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
        </div>
    `;
}

function canUserEditResource(type, id) {
  if (isAdmin()) return true;
  
  if (isManager()) {
    // Managers can edit projects and any tasks
    if (type === 'project') {
      return true;
    }
    
    if (type === 'task') {
      // Manager c√≥ th·ªÉ s·ª≠a t·∫•t c·∫£ c√°c task
      return true;
    }
  }
  
  // TH√äM: Ng∆∞·ªùi d√πng th∆∞·ªùng c√≥ th·ªÉ s·ª≠a d·ª± √°n h·ªç ph·ª• tr√°ch
  if (type === 'project') {
    const project = allProjects.find(p => p[COL.P_ID] === id);
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    return false;
  }
  
  // Ng∆∞·ªùi d√πng th∆∞·ªùng c√≥ th·ªÉ s·ª≠a task trong d·ª± √°n m√† h·ªç qu·∫£n l√Ω
  if (type === 'task') {
    const task = allTasks.find(t => t[COL.T_ID] === id);
    if (!task) return false;
    
    // Ki·ªÉm tra n·∫øu task thu·ªôc v·ªÅ d·ª± √°n m√† ng∆∞·ªùi d√πng l√† qu·∫£n l√Ω
    const projectId = task[COL.T_PID];
    const project = allProjects.find(p => p[COL.P_ID] === projectId);
    
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    
    // Ho·∫∑c task ƒë∆∞·ª£c giao cho ng∆∞·ªùi d√πng n√†y
    return task[COL.T_ASSIGNEE] === currentUser.name;
  }
  
  return false;
}

function canUserDeleteResource(type, id) {
  if (isAdmin()) return true;
  
  if (isManager()) {
    // Managers can delete projects and any tasks
    if (type === 'project') {
      return true;
    }
    
    if (type === 'task') {
      // Manager c√≥ th·ªÉ x√≥a t·∫•t c·∫£ c√°c task
      return true;
    }
  }
  
  // TH√äM: Ng∆∞·ªùi d√πng th∆∞·ªùng c√≥ th·ªÉ x√≥a d·ª± √°n h·ªç ph·ª• tr√°ch
  if (type === 'project') {
    const project = allProjects.find(p => p[COL.P_ID] === id);
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    return false;
  }
  
  // Ng∆∞·ªùi d√πng th∆∞·ªùng c√≥ th·ªÉ x√≥a task trong d·ª± √°n m√† h·ªç qu·∫£n l√Ω
  if (type === 'task') {
    const task = allTasks.find(t => t[COL.T_ID] === id);
    if (!task) return false;
    
    // Ki·ªÉm tra n·∫øu task thu·ªôc v·ªÅ d·ª± √°n m√† ng∆∞·ªùi d√πng l√† qu·∫£n l√Ω
    const projectId = task[COL.T_PID];
    const project = allProjects.find(p => p[COL.P_ID] === projectId);
    
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    
    // Ho·∫∑c task ƒë∆∞·ª£c giao cho ng∆∞·ªùi d√πng n√†y
    return task[COL.T_ASSIGNEE] === currentUser.name;
  }
  
  return false;
}


// === Navigation ===
function switchSection(sectionName) {
  // Cleanup any active sortable instances when switching sections
  destroyAllSortableInstances();
  
  // Update active nav link
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

  // Update page title
  const titles = {
    'overview': 'T·ªïng Quan',
    'projects': 'Qu·∫£n l√Ω D·ª± √°n',
    'tasks': 'Qu·∫£n l√Ω Nhi·ªám v·ª•',
    'staff': 'Qu·∫£n l√Ω Nh√¢n vi√™n',
    'gantt': 'S∆° ƒë·ªì Gantt'  // Th√™m ti√™u ƒë·ªÅ cho tab Gantt
  };
  document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';

  // Show/hide sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(`${sectionName}-section`).classList.add('active');

  currentSection = sectionName;
  
  // N·∫øu chuy·ªÉn sang tab Gantt, render bi·ªÉu ƒë·ªì
  if (sectionName === 'gantt') {
    // Th√™m timeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr∆∞·ªõc khi thi·∫øt l·∫≠p event listeners
    setTimeout(() => {
      renderGanttChart();
      // setupGanttEventListeners() ƒë√£ ƒë∆∞·ª£c g·ªçi trong renderGanttChart() n√™n kh√¥ng c·∫ßn g·ªçi l·∫°i ·ªü ƒë√¢y
    }, 10);
  }
  
  // Close mobile menu if open
  closeMobileMenu();
}

function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    sidebar.classList.add('open');
    overlay.classList.remove('hidden');
    setTimeout(() => overlay.classList.remove('opacity-0'), 10);
}

function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    sidebar.classList.remove('open');
    overlay.classList.add('opacity-0');
    setTimeout(() => overlay.classList.add('hidden'), 300);
}

function toggleSidebar() {
    const body = document.body;
    const toggleBtn = document.getElementById('sidebar-toggle');
    const icon = toggleBtn.querySelector('i');
    
    body.classList.toggle('sidebar-collapsed');
    
    // Always use bars icon
    icon.className = 'fas fa-bars text-gray-600';
    
    // Save state to localStorage
    localStorage.setItem('sidebarCollapsed', body.classList.contains('sidebar-collapsed'));
}

// === Data Rendering ===
function renderStats(stats) {
    if (!stats) return;
    
    // Get user-specific data based on permissions
    let userProjects = [];
    let userTasks = [];
    
    if (isAdmin()) {
        // Admin sees all data
        userProjects = allProjects;
        userTasks = allTasks;
    } else {
        // Manager/Staff sees only their allowed projects and tasks
        userProjects = getUserAllowedProjects();
        const userProjectIds = userProjects.map(p => p[COL.P_ID]);
        userTasks = allTasks.filter(task => {
            const projectId = task[COL.T_PROJECT_ID];
            const assignee = task[COL.T_ASSIGNEE];
            return userProjectIds.includes(projectId) || assignee === currentUser.name;
        });
    }
    
    // T√≠nh to√°n d·ªØ li·ªáu cho projects (user-specific)
    const totalProjects = userProjects.length;
    const completedProjects = userProjects.filter(project => {
        const status = (project[COL.P_STATUS] || '').toLowerCase();
        return status.includes('ho√†n th√†nh');
    }).length;
    const projectCompletionRate = totalProjects > 0 ? Math.round((completedProjects / totalProjects) * 100) : 0;
    
    // T√≠nh to√°n d·ªØ li·ªáu cho tasks (user-specific)
    const totalTasks = userTasks.length;
    const completedTasks = userTasks.filter(task => {
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        return status.includes('ho√†n th√†nh');
    }).length;
    const taskCompletionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    // T√≠nh to√°n d·ª± √°n ƒëang l√†m (user-specific)
    const pendingTasks = userTasks.filter(task => {
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        return status === 'ch∆∞a b·∫Øt ƒë·∫ßu';
    }).length;

    const ongoingTasks = userTasks.filter(task => {
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        return status.includes('ƒëang');
    }).length;

    const pausedTasks = 0; // B·ªè tr·∫°ng th√°i 'T·∫°m d·ª´ng'

    const activeTasks = ongoingTasks + pendingTasks;
    
    // T√≠nh to√°n nhi·ªám v·ª• qu√° h·∫°n (user-specific)
    const overdueTasks = userTasks.filter(task => {
        const deadline = task[COL.T_DEADLINE];
        if (!deadline) return false;
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        if (status.includes('ho√†n th√†nh')) return false;
        return new Date(deadline) < new Date();
    }).length;
    const overdueRate = totalTasks > 0 ? Math.round((overdueTasks / totalTasks) * 100) : 0;
    
    // C·∫≠p nh·∫≠t DOM
    document.getElementById('total-projects').textContent = totalProjects;
    document.getElementById('completed-projects').textContent = completedProjects;
    document.getElementById('project-completion-rate').textContent = `${projectCompletionRate}%`;
    
    document.getElementById('total-tasks').textContent = totalTasks;
    document.getElementById('completed-tasks').textContent = completedTasks;
    document.getElementById('task-completion-rate').textContent = `${taskCompletionRate}%`;
    
    document.getElementById('active-tasks').textContent = activeTasks;
    document.getElementById('pending-tasks').textContent = pendingTasks;
    
    document.getElementById('overdue-tasks').textContent = overdueTasks;
    document.getElementById('overdue-total-tasks').textContent = totalTasks;
    document.getElementById('overdue-rate').textContent = `${overdueRate}%`;
}

// === Compact Project Task Tree ===
function renderProjectTaskTree() {
  const container = document.getElementById('project-task-tree');
  if (!container) return;
  
  // Ch·ªâ l·∫•y c√°c d·ª± √°n m√† ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem
  const userProjects = getUserAllowedProjects();
  
  if (!userProjects || userProjects.length === 0) {
    container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ d·ª± √°n n√†o</div>';
    return;
  }
  
  const projectsWithTasks = userProjects.map(project => {
    // Ch·ªâ l·∫•y c√°c nhi·ªám v·ª• thu·ªôc d·ª± √°n n√†y m√† ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem
    let projectTasks = allTasks.filter(task => task[COL.T_PID] === project[COL.P_ID]);
    
    // N·∫øu kh√¥ng ph·∫£i admin, l·ªçc th√™m c√°c nhi·ªám v·ª•
    if (!isAdmin()) {
      if (isManager()) {
        // Qu·∫£n l√Ω th·∫•y c√°c nhi·ªám v·ª• c·ªßa d·ª± √°n h·ªç qu·∫£n l√Ω v√† nhi·ªám v·ª• c·ªßa h·ªç
        if (project[COL.P_MANAGER] !== currentUser.name) {
          // N·∫øu kh√¥ng ph·∫£i d·ª± √°n qu·∫£n l√Ω, ch·ªâ th·∫•y nhi·ªám v·ª• c·ªßa m√¨nh
          projectTasks = projectTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
        }
      } else {
        // Ng∆∞·ªùi d√πng th∆∞·ªùng ch·ªâ th·∫•y nhi·ªám v·ª• c·ªßa m√¨nh v√† nhi·ªám v·ª• c·ªßa d·ª± √°n h·ªç qu·∫£n l√Ω
        projectTasks = projectTasks.filter(task => {
          if (task[COL.T_ASSIGNEE] === currentUser.name) {
            return true;
          }
          if (project[COL.P_MANAGER] === currentUser.name) {
            return true;
          }
          return false;
        });
      }
    }
    
    return { ...project, tasks: projectTasks };
  });
  
  container.innerHTML = projectsWithTasks.map(project => createCompactProjectItem(project)).join('');
}

function createCompactProjectItem(project) {
    const projectId = project[COL.P_ID] || 'N/A';
    const projectName = `${project[COL.P_NAME] || 'Ch∆∞a c√≥ t√™n'} (${projectId})`;
    const projectDesc = project[COL.P_DESC] || 'Kh√¥ng c√≥ m√¥ t·∫£';
    const projectStatus = project[COL.P_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    const projectManager = project[COL.P_MANAGER] || 'Ch∆∞a g√°n';
    const tasks = project.tasks || [];
    
    const statusClass = getStatusClass(projectStatus);
    const completedTasks = tasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length;
    const totalTasks = tasks.length;
    const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    return `
        <div class="project-tree-item" data-id="${projectId}">
            <div class="project-header">
                <button class="expand-icon project-expand-btn" data-project="${projectId}">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="project-info">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="project-title">
                                ${projectName}
                                ${isPublicProject(project) ? '<span class="ml-2 text-blue-600" title="D·ª± √°n chung - T·∫•t c·∫£ nh√¢n vi√™n c√≥ th·ªÉ th√™m nhi·ªám v·ª•">üåê</span>' : ''}
                            </h4>
                            <p class="project-description">${projectDesc}</p>
                            <div class="project-meta">
                              <span class="status-badge ${statusClass}">${projectStatus}</span>
                              <span class="flex items-center text-xs">
                                  ${projectManager}
                              </span>
                              <span class="flex items-center text-xs ml-2">
                                  B·∫Øt ƒë·∫ßu: ${formatDateForDisplay(project[COL.P_START])}
                              </span>
                              <span class="flex items-center text-xs ml-2">
                                  K·∫øt th√∫c: ${formatDateForDisplay(project[COL.P_END])}
                              </span>
                          </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Ch·ªânh s·ª≠a">
                                S·ª≠a
                            </button>
                            <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="X√≥a">
                                X√≥a
                            </button>
                        </div>
                    </div>
                    <div class="project-stats">
                        <span class="text-sm text-gray-600">${completedTasks}/${totalTasks} nhi·ªám v·ª•</span>
                        <span class="text-sm font-medium text-gray-700">${progressPercent}%</span>
                    </div>
                    <div class="project-progress">
                        <div class="project-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
            </div>
            
            <div class="project-tasks" id="tasks-${projectId}">
                ${tasks.length > 0 ? tasks.map(task => createCompactTaskItem(task)).join('') : '<div class="text-gray-500 text-sm py-3">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>'}
            </div>
        </div>
    `;
}

function createCompactTaskItem(task) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Ch∆∞a c√≥ t√™n';
    const taskDesc = task[COL.T_DESC] || ''; // Th√™m d√≤ng n√†y
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Ch∆∞a g√°n';
    const taskStatus = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    const taskPriority = task[COL.T_PRIORITY] || 'Trung b√¨nh';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    
    // THAY ƒê·ªîI: Th√™m th√¥ng tin d·ª± √°n v√†o task item
    const taskProjectId = task[COL.T_PID] || 'N/A';
    const project = allProjects.find(p => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : '';
    
    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    
    return `
        <div class="task-tree-item task-connection task-card-clickable" data-id="${taskId}" data-type="task">
            <div class="task-info">
                <div class="task-details">
                    <h5 class="task-title">${taskName}</h5>
                    ${taskDesc ? `<p class="text-xs text-gray-600 mb-1">${taskDesc}</p>` : ''}
                    <div class="task-meta">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                    </div>
                    <div class="task-assignee">
                        
                        <span>${taskAssignee}</span>
                        <span class="mx-2">‚Ä¢</span>
                        
                        <span>${taskDueDate}</span>
                    </div>
                    
                    ${task[COL.T_RESULT_LINKS] ? `
                    <div class="mt-1 text-xs">
                        <span class="font-medium">Links:</span> ${formatTaskLinks(task[COL.T_RESULT_LINKS])}
                    </div>
                    ` : ''}
                    
                </div>
                <div class="flex items-center space-x-3">
                    <div class="task-progress">
                        <span class="task-progress-text">${taskCompletion}%</span>
                        <div class="task-progress-bar">
                            <div class="task-progress-fill ${taskCompletion === 100 ? 'completed' : ''}" style="width: ${taskCompletion}%"></div>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                             <button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="X√≥a">
                                 X√≥a
                             </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function toggleProjectTasks(btn) {
    const projectId = btn.dataset.project;
    const tasksContainer = document.getElementById(`tasks-${projectId}`);
    
    if (tasksContainer.classList.contains('expanded')) {
        // ƒê√≥ng d·ª± √°n hi·ªán t·∫°i
        tasksContainer.classList.remove('expanded');
        btn.classList.remove('expanded');
    } else {
        // ƒê√≥ng t·∫•t c·∫£ c√°c d·ª± √°n kh√°c tr∆∞·ªõc
        const allExpandedProjects = document.querySelectorAll('.project-tasks.expanded');
        const allExpandedBtns = document.querySelectorAll('.project-expand-btn.expanded');
        
        allExpandedProjects.forEach(container => {
            container.classList.remove('expanded');
        });
        
        allExpandedBtns.forEach(expandBtn => {
            expandBtn.classList.remove('expanded');
        });
        
        // Sau ƒë√≥ m·ªü d·ª± √°n hi·ªán t·∫°i
        tasksContainer.classList.add('expanded');
        btn.classList.add('expanded');
    }
}

function renderPriorityTasks() {
  const container = document.getElementById('priority-tasks');
  if (!container) return;
  
  // L·ªçc c√°c nhi·ªám v·ª• ∆∞u ti√™n cao m√† ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem
  let userTasks = [];
  
  if (isAdmin()) {
    userTasks = allTasks;
  } else {
    const userProjects = getUserAllowedProjects();
    const userProjectIds = userProjects.map(p => p[COL.P_ID]);
    
    userTasks = allTasks.filter(task => {
      // Nhi·ªám v·ª• ƒë∆∞·ª£c giao cho ng∆∞·ªùi d√πng
      if (task[COL.T_ASSIGNEE] === currentUser.name) {
        return true;
      }
      
      // Nhi·ªám v·ª• thu·ªôc d·ª± √°n m√† ng∆∞·ªùi d√πng qu·∫£n l√Ω
      const projectId = task[COL.T_PID];
      const project = allProjects.find(p => p[COL.P_ID] === projectId);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      
      return false;
    });
  }
  
  const highPriorityTasks = userTasks.filter(task => {
    const priority = (task[COL.T_PRIORITY] || '').toLowerCase();
    const status = (task[COL.T_STATUS] || '').toLowerCase();
    return priority.includes('cao') && !status.includes('ho√†n th√†nh');
  });
  
  if (highPriorityTasks.length === 0) {
    container.innerHTML = '<div class="col-span-full loading-card">Kh√¥ng c√≥ nhi·ªám v·ª• ∆∞u ti√™n cao</div>';
    return;
  }
  
  // Show up to 8 tasks (4 per column) to fit the height better
  container.innerHTML = highPriorityTasks.slice(0, 8).map(task => createPriorityTaskCard(task)).join('');
}

function createPriorityTaskCard(task) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Ch∆∞a c√≥ t√™n';
    const taskDesc = task[COL.T_DESC] || ''; // Th√™m m√¥ t·∫£
    const taskProjectId = task[COL.T_PID] || 'N/A';
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Ch∆∞a g√°n';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    
    // T√¨m t√™n d·ª± √°n t·ª´ m√£ d·ª± √°n
    const project = allProjects.find(p => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : '';
    const projectDisplay = projectName ? `${projectName} (${taskProjectId})` : taskProjectId;
    
    const isOverdue = isTaskOverdue(task[COL.T_DUE]);
    
    return `
        <div class="priority-task-card" data-id="${taskId}">
            <div class="mb-3">
                <div class="flex items-start justify-between mb-1">
                    <h5 class="font-medium text-gray-900 text-sm leading-tight">${taskName}</h5>
                    ${isOverdue ? '<span class="status-badge status-overdue text-xs">Qu√° h·∫°n</span>' : ''}
                </div>
                ${taskDesc ? `<p class="text-xs text-gray-600 mb-2 leading-relaxed">${taskDesc}</p>` : ''}
                <div class="text-xs text-gray-600 space-y-1">
                    <div>D·ª± √°n: ${projectDisplay}</div>
                    <div>Ng∆∞·ªùi th·ª±c hi·ªán: ${taskAssignee}</div>
                    <div>H·∫°n: ${taskDueDate}</div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-medium text-gray-700 min-w-[30px]">${taskCompletion}%</span>
                <div class="flex-1 h-1.5 bg-gray-200 rounded-full">
                    <div class="h-full bg-gray-300 rounded-full" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
        </div>
    `;
}

function renderProjects() {
  // Check current view mode and render accordingly
  if (currentProjectView === 'kanban') {
    renderProjectsKanban();
    return;
  }
  
  // Call list view rendering
  renderProjectsList();
}

function renderProjectsList() {
  // Ch·ªâ l·∫•y c√°c d·ª± √°n m√† ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem
  const userProjects = getUserAllowedProjects();
  
  if (!userProjects || userProjects.length === 0) {
    // Clear all containers
    ['projects-pending', 'projects-active', 'projects-completed'].forEach(id => {
      const container = document.getElementById(id);
      if (container) container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ d·ª± √°n n√†o</div>';
    });
    return;
  }
  
  // Group projects by status
  const groupedProjects = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': [],
    'ƒêang th·ª±c hi·ªán': [],
    'Ho√†n th√†nh': []
  };
  
  userProjects.forEach(project => {
    const status = project[COL.P_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    if (groupedProjects[status]) {
      groupedProjects[status].push(project);
    }
  });
  
  // Render each group
  const containers = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': 'projects-pending',
    'ƒêang th·ª±c hi·ªán': 'projects-active', 
    'Ho√†n th√†nh': 'projects-completed'
  };
  
  // Update headers with counts
  const statusLabels = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': 'Ch∆∞a b·∫Øt ƒë·∫ßu',
    'ƒêang th·ª±c hi·ªán': 'ƒêang th·ª±c hi·ªán', 
    'Ho√†n th√†nh': 'Ho√†n th√†nh'
  };
  
  Object.keys(containers).forEach(status => {
    const container = document.getElementById(containers[status]);
    if (!container) return;
    
    // Update header with count
    const headerElement = container.parentElement.querySelector('h3');
    if (headerElement) {
      const count = groupedProjects[status] ? groupedProjects[status].length : 0;
      headerElement.textContent = `${statusLabels[status]} (${count})`;
    }
    
    const projects = groupedProjects[status] || [];
    if (projects.length === 0) {
      container.innerHTML = '<div class="text-gray-500 text-center py-8 border-2 border-dashed border-gray-200 rounded-lg">Ch∆∞a c√≥ d·ª± √°n n√†o</div>';
    } else {
      container.innerHTML = projects.map(project => createProjectCard(project, true)).join('');
    }
  });
}

function createProjectCard(project, isDetailed = false) {
    const projectId = project[COL.P_ID] || 'N/A';
    const projectName = project[COL.P_NAME] || 'Ch∆∞a c√≥ t√™n';
    const projectDesc = project[COL.P_DESC] || '';
    const projectManager = project[COL.P_MANAGER] || 'Ch∆∞a g√°n';
    const projectStatus = project[COL.P_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    const startDate = formatDateForDisplay(project[COL.P_START]);
    const endDate = formatDateForDisplay(project[COL.P_END]);
    
    const statusClass = getStatusClass(projectStatus);
    const publicBadge = isPublicProject(project) ? `<span class="status-badge bg-blue-100 text-blue-800 ml-2">üåê D·ª± √°n chung</span>` : '';
    
    return `
        <div class="project-card clickable-project-card cursor-pointer" data-id="${projectId}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 mb-1">${projectName}</h4>
                    ${projectDesc ? `<p class="text-sm text-gray-600 mb-2">${projectDesc}</p>` : ''}
                    <div class="flex items-center flex-wrap">
                        <span class="status-badge ${statusClass}">${projectStatus}</span>
                        ${publicBadge}
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Ch·ªânh s·ª≠a">
                        S·ª≠a
                    </button>
                    <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="X√≥a">
                        X√≥a
                    </button>
                </div>
            </div>
            
            ${isDetailed ? `
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex items-center">
                        <span>Qu·∫£n l√Ω: ${projectManager}</span>
                    </div>
                    ${startDate || endDate ? `
                    <div class="flex items-center justify-between">
                        ${startDate ? `<span>B·∫Øt ƒë·∫ßu: ${startDate}</span>` : (endDate ? `<span>K·∫øt th√∫c: ${endDate}</span>` : '<span></span>')}
                        ${startDate && endDate ? `<span>K·∫øt th√∫c: ${endDate}</span>` : '<span></span>'}
                    </div>
                    ` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function renderTasks() {
  // Check current view mode and render accordingly
  if (currentTaskView === 'kanban') {
    renderTasksKanban();
    return;
  }
  
  // Original list view rendering
  const container = document.getElementById('tasks-by-project');
  if (!container) return;
  
  // L·ªçc c√°c nhi·ªám v·ª• m√† ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem
  let userTasks = [];
  
  if (isAdmin()) {
    userTasks = allTasks;
  } else {
    const userProjects = getUserAllowedProjects();
    const userProjectIds = userProjects.map(p => p[COL.P_ID]);
    
    userTasks = allTasks.filter(task => {
      // Nhi·ªám v·ª• ƒë∆∞·ª£c giao cho ng∆∞·ªùi d√πng
      if (task[COL.T_ASSIGNEE] === currentUser.name) {
        return true;
      }
      
      // Nhi·ªám v·ª• thu·ªôc d·ª± √°n m√† ng∆∞·ªùi d√πng qu·∫£n l√Ω
      const projectId = task[COL.T_PID];
      const project = allProjects.find(p => p[COL.P_ID] === projectId);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      
      return false;
    });
  }
  
  if (!userTasks || userTasks.length === 0) {
    container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>';
    return;
  }
  
  // Group tasks by status
  const tasksByStatus = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': [],
    'ƒêang th·ª±c hi·ªán': [],
    'Ho√†n th√†nh': []
  };
  
  userTasks.forEach(task => {
    const status = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    if (tasksByStatus[status]) {
      tasksByStatus[status].push(task);
    }
  });
  
  // Sort tasks within each status group by project name for better organization
  Object.keys(tasksByStatus).forEach(status => {
    tasksByStatus[status].sort((a, b) => {
      const projectA = allProjects.find(p => p[COL.P_ID] === a[COL.T_PID]);
      const projectB = allProjects.find(p => p[COL.P_ID] === b[COL.T_PID]);
      const nameA = projectA ? projectA[COL.P_NAME] : '';
      const nameB = projectB ? projectB[COL.P_NAME] : '';
      return nameA.localeCompare(nameB);
    });
  });
  
  // Render grouped tasks by status
  let html = '';
  Object.keys(tasksByStatus).forEach(status => {
    const tasks = tasksByStatus[status];
    html += `
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">${status} (${tasks.length})</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
          ${tasks.length > 0 
            ? tasks.map(task => createTaskCard(task, true)).join('')
            : '<div class="text-gray-500 text-center py-8 col-span-full border-2 border-dashed border-gray-200 rounded-lg">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>'
          }
        </div>
      </div>
    `;
  });
  
  if (html === '') {
    container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>';
  } else {
    container.innerHTML = html;
  }
}

function renderTasksList() {
  const container = document.getElementById('tasks-by-project');
  if (!container) return;
  
  // L·ªçc c√°c nhi·ªám v·ª• m√† ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem
  let userTasks = [];
  
  if (isAdmin()) {
    userTasks = allTasks;
  } else {
    const userProjects = getUserAllowedProjects();
    const userProjectIds = userProjects.map(p => p[COL.P_ID]);
    
    userTasks = allTasks.filter(task => {
      // Nhi·ªám v·ª• ƒë∆∞·ª£c giao cho ng∆∞·ªùi d√πng
      if (task[COL.T_ASSIGNEE] === currentUser.name) {
        return true;
      }
      
      // Nhi·ªám v·ª• thu·ªôc d·ª± √°n m√† ng∆∞·ªùi d√πng qu·∫£n l√Ω
      const projectId = task[COL.T_PID];
      const project = allProjects.find(p => p[COL.P_ID] === projectId);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      
      return false;
    });
  }
  
  if (!userTasks || userTasks.length === 0) {
    container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>';
    return;
  }
  
  // Group tasks by status
  const tasksByStatus = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': [],
    'ƒêang th·ª±c hi·ªán': [],
    'Ho√†n th√†nh': []
  };
  
  userTasks.forEach(task => {
    const status = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    if (tasksByStatus[status]) {
      tasksByStatus[status].push(task);
    }
  });
  
  // Sort tasks within each status group by project name for better organization
  Object.keys(tasksByStatus).forEach(status => {
    tasksByStatus[status].sort((a, b) => {
      const projectA = allProjects.find(p => p[COL.P_ID] === a[COL.T_PID]);
      const projectB = allProjects.find(p => p[COL.P_ID] === b[COL.T_PID]);
      const nameA = projectA ? projectA[COL.P_NAME] : '';
      const nameB = projectB ? projectB[COL.P_NAME] : '';
      return nameA.localeCompare(nameB);
    });
  });
  
  // Render grouped tasks by status
  let html = '';
  Object.keys(tasksByStatus).forEach(status => {
    const tasks = tasksByStatus[status];
    html += `
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">${status} (${tasks.length})</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
          ${tasks.length > 0 
            ? tasks.map(task => createTaskCard(task, true)).join('')
            : '<div class="text-gray-500 text-center py-8 col-span-full border-2 border-dashed border-gray-200 rounded-lg">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>'
          }
        </div>
      </div>
    `;
  });
  
  if (html === '') {
    container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>';
  } else {
    container.innerHTML = html;
  }
}

function createTaskCard(task, isDetailed = false) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Ch∆∞a c√≥ t√™n';
    const taskDesc = task[COL.T_DESC] || ''; // Th√™m d√≤ng n√†y
    const taskProjectId = task[COL.T_PID] || 'N/A';
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Ch∆∞a g√°n';
    const taskStatus = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    const taskPriority = task[COL.T_PRIORITY] || 'Trung b√¨nh';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);

        // Th√™m c√°c bi·∫øn m·ªõi ƒë·ªÉ l·∫•y gi√° tr·ªã t·ª´ task
    const taskReportDate = formatDateForDisplay(task[COL.T_REPORT_DATE]);
    const taskTarget = task[COL.T_TARGET] || '';
    const taskResultLinks = task[COL.T_RESULT_LINKS] || '';
    const taskOutput = task[COL.T_OUTPUT] || '';
    
    // THAY ƒê·ªîI: T√¨m t√™n d·ª± √°n t·ª´ m√£ d·ª± √°n
    const project = allProjects.find(p => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : '';
    // T·∫°o text hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß: "T√™n d·ª± √°n (M√£ d·ª± √°n)"
    const projectDisplay = projectName ? `${projectName} (${taskProjectId})` : taskProjectId;
    
    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    
    return `
        <div class="task-card clickable-task-card cursor-pointer" data-id="${taskId}">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 mb-1">${taskName}</h4>
                    ${taskDesc ? `<p class="text-sm text-gray-600 mb-2">${taskDesc}</p>` : ''}
                    <p class="text-sm text-gray-600 mb-2">D·ª± √°n: ${projectDisplay}</p>
                    <div class="flex items-center space-x-2">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                     <button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="X√≥a">
                         X√≥a
                     </button>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-1">
                    <span>Ti·∫øn ƒë·ªô</span>
                    <span>${taskCompletion}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
            
            ${isDetailed ? `
                <div class="space-y-2 text-sm text-gray-600">
                  <div class="flex items-center justify-between">
                      <span>Giao cho: ${taskAssignee}</span>
                      <span>H·∫°n: ${taskDueDate}</span>
                  </div>
                  
                  ${taskReportDate ? `
                  <div class="flex items-center">
                      <span>Ng√†y b√°o c√°o: ${taskReportDate}</span>
                  </div>
                  ` : ''}
                  
                  ${taskTarget ? `
                  <div class="flex items-start">
                      <div>
                          <span class="font-medium">M·ª•c ti√™u:</span>
                          <p class="text-xs text-gray-600 mt-1">${taskTarget}</p>
                      </div>
                  </div>
                  ` : ''}
                  
                  ${taskResultLinks ? `
                  <div class="flex items-start">
                      <div>
                          <span class="font-medium">Link k·∫øt qu·∫£:</span>
                          <div class="text-xs text-blue-600 mt-1">${formatTaskLinks(taskResultLinks)}</div>
                      </div>
                  </div>
                  ` : ''}
                  
                  ${taskOutput ? `
                  <div class="flex items-start">
                      <div>
                          <span class="font-medium">K·∫øt qu·∫£ ƒë·∫ßu ra:</span>
                          <p class="text-xs text-gray-600 mt-1">${taskOutput}</p>
                      </div>
                  </div>
                  ` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function renderStaff() {
    const container = document.getElementById('staff-grid');
    if (!container) return;
    
    if (!allStaff || allStaff.length === 0) {
        container.innerHTML = '<div class="loading-card">Ch∆∞a c√≥ nh√¢n vi√™n n√†o</div>';
        return;
    }
    
    // Nh√≥m staff theo ph√¢n quy·ªÅn
    const groupedStaff = {
        'Admin': [],
        'Qu·∫£n l√Ω': [],
        'Nh√¢n vi√™n': []
    };
    
    allStaff.forEach(staff => {
        const role = staff[COL.S_ROLE] || 'Nh√¢n vi√™n';
        if (groupedStaff[role]) {
            groupedStaff[role].push(staff);
        } else {
            groupedStaff['Nh√¢n vi√™n'].push(staff);
        }
    });
    
    let html = '';
    
    // Render t·ª´ng nh√≥m
    Object.keys(groupedStaff).forEach(role => {
        if (groupedStaff[role].length > 0) {
            let roleClass = 'text-gray-800';
            if (role === 'Admin') roleClass = 'text-red-600';
            else if (role === 'Qu·∫£n l√Ω') roleClass = 'text-blue-600';
            else if (role === 'Nh√¢n vi√™n') roleClass = 'text-green-600';
            
            html += `
                <div class="col-span-full mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-sm font-medium ${roleClass}">${role}</span>
                        <span class="text-sm text-gray-500">(${groupedStaff[role].length} ng∆∞·ªùi)</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${groupedStaff[role].map(staff => createStaffCard(staff)).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

function createStaffCard(staff) {
  const staffId = staff[COL.S_ID] || 'N/A';
  const staffName = staff[COL.S_NAME] || 'Ch∆∞a c√≥ t√™n';
  const staffEmail = staff[COL.S_EMAIL] || '';
  const staffPosition = staff[COL.S_POS] || 'Ch∆∞a c√≥ ch·ª©c v·ª•';
  const staffRole = staff[COL.S_ROLE] || 'Nh√¢n vi√™n';
  
  const initials = staffName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  let roleClass = 'user-role-user';
  
  if (staffRole.toLowerCase().includes('admin')) {
    roleClass = 'user-role-admin';
  } else if (staffRole.toLowerCase().includes('qu·∫£n l√Ω')) {
    roleClass = 'user-role-manager';
  }
  
  return `
      <div class="staff-card" data-id="${staffId}">
          <div class="flex justify-between items-start mb-4">
              <div class="flex-1"></div>
              <div class="flex space-x-2">
                  <button class="action-btn action-btn-edit edit-btn" data-type="staff" data-id="${staffId}" title="Ch·ªânh s·ª≠a">
                      S·ª≠a
                  </button>
                  <button class="action-btn action-btn-delete delete-btn" data-type="staff" data-id="${staffId}" data-name="${staffName}" title="X√≥a">
                      X√≥a
                  </button>
              </div>
          </div>
          <div class="space-y-2 text-left">
              <div>
                  <span class="text-sm font-medium text-gray-700">H·ªç t√™n:</span>
                  <span class="text-sm text-gray-900 ml-1">${staffName}</span>
              </div>
              <div>
                  <span class="text-sm font-medium text-gray-700">Email:</span>
                  <span class="text-sm text-gray-900 ml-1">${staffEmail}</span>
              </div>
              <div>
                  <span class="text-sm font-medium text-gray-700">Ch·ª©c v·ª•:</span>
                  <span class="text-sm text-gray-900 ml-1">${staffPosition}</span>
              </div>
          </div>
      </div>
  `;
}

function renderChart(chartData) {
    const ctx = document.getElementById('status-chart');
    const message = document.getElementById('chart-message');
    
    if (!ctx) return;
    
    // Destroy existing chart
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
        message.textContent = chartData?.message || 'Kh√¥ng c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì';
        message.classList.remove('hidden');
        return;
    }
    
    message.classList.add('hidden');
    
    const colors = [
        'rgba(59, 130, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(139, 92, 246, 0.8)'
    ];
    
    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.data,
                backgroundColor: colors.slice(0, chartData.labels.length),
                borderColor: colors.slice(0, chartData.labels.length).map(c => c.replace('0.8', '1')),
                borderWidth: 2,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,           // GI·∫¢M t·ª´ 20 xu·ªëng 15
                        usePointStyle: true,
                        font: {
                            size: 10             // GI·∫¢M t·ª´ 12 xu·ªëng 10
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutCubic'
            }
        }
    });
}

function renderProjectProgressChart() {
    const ctx = document.getElementById('project-progress-chart');
    const message = document.getElementById('project-chart-message');
    
    if (!ctx) return;
    
    // Destroy existing chart
    if (projectProgressChart) {
        projectProgressChart.destroy();
    }
    
    // Get user-specific projects based on permissions
    let userProjects = [];
    if (isAdmin()) {
        userProjects = allProjects;
    } else {
        userProjects = getUserAllowedProjects();
    }
    
    if (!userProjects || userProjects.length === 0) {
        message.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu d·ª± √°n';
        message.classList.remove('hidden');
        return;
    }
    
    message.classList.add('hidden');
    
    // Initialize progress ranges
    const progressRanges = {
        '0-25%': { count: 0, projects: [] },
        '26-50%': { count: 0, projects: [] },
        '51-75%': { count: 0, projects: [] },
        '76-99%': { count: 0, projects: [] },
        '100%': { count: 0, projects: [] }
    };
    
    // Group projects by progress ranges (user-specific)
    userProjects.forEach(project => {
        const projectTasks = allTasks.filter(task => task[COL.T_PID] === project[COL.P_ID]);
        const completedTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length;
        const totalTasks = projectTasks.length;
        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        const projectName = project[COL.P_NAME] || 'Ch∆∞a c√≥ t√™n';
        
        // Determine which range the project belongs to
        if (progress === 100) {
            progressRanges['100%'].count++;
            progressRanges['100%'].projects.push(projectName);
        } else if (progress >= 76) {
            progressRanges['76-99%'].count++;
            progressRanges['76-99%'].projects.push(projectName);
        } else if (progress >= 51) {
            progressRanges['51-75%'].count++;
            progressRanges['51-75%'].projects.push(projectName);
        } else if (progress >= 26) {
            progressRanges['26-50%'].count++;
            progressRanges['26-50%'].projects.push(projectName);
        } else {
            progressRanges['0-25%'].count++;
            progressRanges['0-25%'].projects.push(projectName);
        }
    });
    
    // Prepare chart data
    const labels = Object.keys(progressRanges);
    const data = Object.values(progressRanges).map(range => range.count);
    const colors = [
        'rgba(239, 68, 68, 0.8)',   // Red for 0-25%
        'rgba(245, 158, 11, 0.8)',  // Orange for 26-50%
        'rgba(59, 130, 246, 0.8)',  // Blue for 51-75%
        'rgba(16, 185, 129, 0.8)',  // Green for 76-99%
        'rgba(34, 197, 94, 0.8)'    // Dark green for 100%
    ];
    
    projectProgressChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'S·ªë l∆∞·ª£ng d·ª± √°n',
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `Kho·∫£ng ti·∫øn ƒë·ªô: ${context[0].label}`;
                        },
                        label: function(context) {
                            return `S·ªë l∆∞·ª£ng: ${context.parsed.y} d·ª± √°n`;
                        },
                        afterLabel: function(context) {
                            const rangeKey = context.label;
                            const projects = progressRanges[rangeKey].projects;
                            if (projects.length > 0) {
                                const maxDisplay = 5; // Hi·ªÉn th·ªã t·ªëi ƒëa 5 d·ª± √°n trong tooltip
                                let result = '\nD·ª± √°n:';
                                projects.slice(0, maxDisplay).forEach(project => {
                                    result += `\n‚Ä¢ ${project}`;
                                });
                                if (projects.length > maxDisplay) {
                                    result += `\n... v√† ${projects.length - maxDisplay} d·ª± √°n kh√°c`;
                                }
                                return result;
                            }
                            return '';
                        }
                    },
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    footerFont: {
                        size: 11
                    },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Math.floor(value); // Ch·ªâ hi·ªÉn th·ªã s·ªë nguy√™n
                        }
                    },
                    title: {
                        display: true,
                        text: 'S·ªë l∆∞·ª£ng d·ª± √°n'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Kho·∫£ng ti·∫øn ƒë·ªô'
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutCubic'
            }
        }
    });
}

// === New Staff Performance Chart ===
function renderStaffPerformanceChart() {
    const ctx = document.getElementById('staff-performance-chart');
    const message = document.getElementById('staff-chart-message');
    
    if (!ctx) return;
    
    // Destroy existing chart
    if (staffPerformanceChart) {
        staffPerformanceChart.destroy();
    }

    // Get user-specific data based on permissions
    let relevantTasks = [];
    let relevantStaff = [];
    
    if (isAdmin()) {
        // Admin sees all data
        relevantTasks = allTasks;
        relevantStaff = allStaff;
    } else if (isManager()) {
        // Manager sees staff in their managed projects
        const managedProjects = getUserAllowedProjects();
        const managedProjectIds = managedProjects.map(p => p[COL.P_ID]);
        relevantTasks = allTasks.filter(task => managedProjectIds.includes(task[COL.T_PROJECT_ID]));
        
        // Get unique staff from relevant tasks
        const staffNames = [...new Set(relevantTasks.map(task => task[COL.T_ASSIGNEE]).filter(name => name))];
        relevantStaff = allStaff.filter(staff => staffNames.includes(staff[COL.S_NAME]));
    } else {
        // Staff only sees their own performance
        relevantTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
        relevantStaff = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
    }
    
    if (!relevantStaff || relevantStaff.length === 0 || !relevantTasks || relevantTasks.length === 0) {
        message.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu nh√¢n vi√™n ho·∫∑c nhi·ªám v·ª•';
        message.classList.remove('hidden');
        return;
    }
    
    message.classList.add('hidden');
    
    // Calculate staff performance (user-specific)
    const staffPerformance = relevantStaff.map(staff => {
        const staffName = staff[COL.S_NAME] || 'Kh√¥ng t√™n';
        const assignedTasks = relevantTasks.filter(task => task[COL.T_ASSIGNEE] === staffName);
        const completedTasks = assignedTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh'));
        const completionRate = assignedTasks.length > 0 ? Math.round((completedTasks.length / assignedTasks.length) * 100) : 0;
        
        return {
            name: staffName,
            totalTasks: assignedTasks.length,
            completedTasks: completedTasks.length,
            completionRate: completionRate
        };
    }).filter(staff => staff.totalTasks > 0); // Only show staff with assigned tasks
    
    if (staffPerformance.length === 0) {
        message.textContent = 'Ch∆∞a c√≥ nhi·ªám v·ª• n√†o ƒë∆∞·ª£c giao';
        message.classList.remove('hidden');
        return;
    }
    
    staffPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: staffPerformance.map(s => s.name),
            datasets: [
                {
                    label: 'T·ªïng s·ªë nhi·ªám v·ª•',
                    data: staffPerformance.map(s => s.totalTasks),
                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    yAxisID: 'y'
                },
                {
                    label: 'T·ª∑ l·ªá ho√†n th√†nh (%)',
                    data: staffPerformance.map(s => s.completionRate),
                    type: 'line',
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const staffData = staffPerformance[context.dataIndex];
                            if (context.dataset.label === 'T·ªïng s·ªë nhi·ªám v·ª•') {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            } else {
                                return `${context.dataset.label}: ${context.parsed.y}%`;
                            }
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 0) { // Only show for total tasks
                                const staffData = staffPerformance[context.dataIndex];
                                return `Ho√†n th√†nh: ${staffData.completedTasks}/${staffData.totalTasks}`;
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        font: {
                            size: 10
                        }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'S·ªë l∆∞·ª£ng nhi·ªám v·ª•'
                    },
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'T·ª∑ l·ªá (%)'
                    },
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutCubic'
            }
        }
    });
}

function renderActivity(activities) {
    const container = document.getElementById('recent-activity');
    if (!container) return;
    
    if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="loading-card">Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o</div>';
        return;
    }
    
    const displayActivities = activities.slice(0, 8);
    
    container.innerHTML = displayActivities.map(activity => `
        <div class="activity-item">
            <div class="flex items-start space-x-3">

                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900">${activity[COL.A_ACTION] || 'H√†nh ƒë·ªông'}</p>
                    <p class="text-xs text-gray-600 mt-1">${activity[COL.A_DETAILS] || ''}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        ${activity[COL.A_USER] || 'Ai ƒë√≥'} ‚Ä¢ ${formatDateForDisplay(activity[COL.A_TIME], true)}
                    </p>
                </div>
            </div>
        </div>
    `).join('');
}

function renderNotifications(notifications) {
    const container = document.getElementById('notification-list');
    const badge = document.getElementById('notification-badge');
    
    if (!container || !badge) return;
    
    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>';
        badge.classList.add('hidden');
        return;
    }
    
    // ‚úÖ S·ª¨A FILTER CHO USER HI·ªÜN T·∫†I
    const filteredNotifications = notifications.filter(notification => {
        const recipientUser = String(notification[COL.N_USER] || '').trim();
        const currentUserName = String(currentUser?.name || '').trim();
        
        // Debug ƒë·ªÉ ki·ªÉm tra
        console.log('Filter debug:', { 
            recipientUser, 
            currentUserName, 
            shouldShow: !recipientUser || recipientUser === currentUserName,
            notificationContent: notification[COL.N_CONTENT] 
        });
        
        // Hi·ªÉn th·ªã n·∫øu: g·ª≠i cho user n√†y HO·∫∂C g·ª≠i cho t·∫•t c·∫£ (recipientUser r·ªóng)
        return !recipientUser || recipientUser === currentUserName;
    });
    
    if (filteredNotifications.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>';
        badge.classList.add('hidden');
        return;
    }
    
    let unreadCount = 0;
    container.innerHTML = filteredNotifications.map(notification => {
        const isUnread = !notification.isRead;
        if (isUnread) unreadCount++;
        
        const recipientUser = String(notification[COL.N_USER] || '').trim();
        const recipientDisplay = recipientUser ? `G·ª≠i cho: ${recipientUser}` : 'G·ª≠i cho: T·∫•t c·∫£';
        
        return `
            <div class="notification-item p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0 cursor-pointer ${isUnread ? '' : 'opacity-60'}" 
                 data-id="${notification[COL.N_ID] || ''}"
                 onclick="markNotificationRead('${notification[COL.N_ID] || ''}', this)">
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 rounded-full ${isUnread ? 'bg-blue-500' : 'bg-gray-300'} mt-2 flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-900 ${isUnread ? 'font-medium' : ''}">${notification[COL.N_CONTENT] || 'Th√¥ng b√°o'}</p>
                        <p class="text-xs text-gray-400 mt-1">${recipientDisplay}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatDateForDisplay(notification[COL.N_TIME], true)}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// === Enhanced Modal Management ===
function openModal(type, data = null) {
    const isEdit = data !== null;
    const modalId = `${type}-modal`;
    
    // Remove existing modal
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }
    
    let modalHTML = '';
    
    if (type === 'project') {
        modalHTML = createProjectModal(isEdit, data);
    } else if (type === 'task') {
        modalHTML = createTaskModal(isEdit, data);
    } else if (type === 'staff') {
        modalHTML = createStaffModal(isEdit, data);
    }
    // ‚úÖ TH√äM V√ÄO ƒê√ÇY:
    else if (type === 'notification') {
        modalHTML = createNotificationModal(isEdit, data);
    }
    
    
    document.getElementById('modals-container').innerHTML = modalHTML;
    
    const modal = document.getElementById(modalId);
    modal.classList.add('active');
    
    // Setup form submission
    const form = modal.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isEdit) {
                handleEdit(type, data);
            } else {
                handleAdd(type);
            }
        });
    }
    
    // Setup close handlers - Fixed
    const closeButtons = modal.querySelectorAll('.close-modal');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal(modalId);
        });
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal(modalId);
        }
    });
}

function openEditModal(type, id) {
    let data = null;
    
    if (type === 'project') {
        data = allProjects.find(p => p[COL.P_ID] === id);
    } else if (type === 'task') {
        data = allTasks.find(t => t[COL.T_ID] === id);
    } else if (type === 'staff') {
        data = allStaff.find(s => s[COL.S_ID] === id);
    }
    
    if (data) {
        openModal(type, data);
    } else {
        showToast(`Kh√¥ng t√¨m th·∫•y ${type} v·ªõi ID: ${id}`, 'error');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
            }
        }, 300);
    }
}

function createProjectModal(isEdit, data) {
  const title = isEdit ? 'Ch·ªânh s·ª≠a d·ª± √°n' : 'T·∫°o d·ª± √°n m·ªõi';
  const submitText = isEdit ? 'C·∫≠p nh·∫≠t' : 'T·∫°o d·ª± √°n';
  
  // L·ªçc danh s√°ch ng∆∞·ªùi c√≥ th·ªÉ ƒë∆∞·ª£c ch·ªçn l√†m qu·∫£n l√Ω d·ª± √°n
  let eligibleManagers = [];
  
  // THAY ƒê·ªîI: ƒê·∫£m b·∫£o ng∆∞·ªùi qu·∫£n l√Ω hi·ªán t·∫°i c·ªßa d·ª± √°n lu√¥n ƒë∆∞·ª£c hi·ªÉn th·ªã trong danh s√°ch
  if (isEdit && data && data[COL.P_MANAGER]) {
    // Ki·ªÉm tra xem ng∆∞·ªùi qu·∫£n l√Ω hi·ªán t·∫°i c√≥ trong danh s√°ch nh√¢n vi√™n kh√¥ng
    const currentManager = allStaff.find(staff => staff[COL.S_NAME] === data[COL.P_MANAGER]);
    
    // N·∫øu kh√¥ng t√¨m th·∫•y, th√™m m·ªôt ƒë·ªëi t∆∞·ª£ng gi·∫£ v√†o danh s√°ch nh√¢n vi√™n t·∫°m th·ªùi
    if (!currentManager) {
      const tempStaff = [...allStaff];
      tempStaff.push({
        [COL.S_NAME]: data[COL.P_MANAGER],
        [COL.S_EMAIL]: ''
      });
      
      if (isAdmin()) {
        eligibleManagers = tempStaff;
      } else if (isManager()) {
        // Qu·∫£n l√Ω ch·ªâ c√≥ th·ªÉ ch·ªçn ch√≠nh h·ªç v√† ng∆∞·ªùi qu·∫£n l√Ω hi·ªán t·∫°i
        eligibleManagers = tempStaff.filter(staff => 
          staff[COL.S_NAME] === currentUser.name || staff[COL.S_NAME] === data[COL.P_MANAGER]
        );
      } else {
        // Ng∆∞·ªùi d√πng th∆∞·ªùng ch·ªâ c√≥ th·ªÉ ch·ªçn ch√≠nh h·ªç ho·∫∑c ng∆∞·ªùi qu·∫£n l√Ω hi·ªán t·∫°i n·∫øu h·ªç l√† ng∆∞·ªùi qu·∫£n l√Ω
        if (data[COL.P_MANAGER] === currentUser.name) {
          eligibleManagers = tempStaff.filter(staff => 
            staff[COL.S_NAME] === currentUser.name || staff[COL.S_NAME] === data[COL.P_MANAGER]
          );
        }
      }
    } else {
      // X·ª≠ l√Ω b√¨nh th∆∞·ªùng n·∫øu ng∆∞·ªùi qu·∫£n l√Ω ƒë√£ c√≥ trong danh s√°ch
      if (isAdmin()) {
        eligibleManagers = allStaff;
      } else if (isManager()) {
        // Qu·∫£n l√Ω ch·ªâ c√≥ th·ªÉ ch·ªçn ch√≠nh h·ªç v√† ng∆∞·ªùi qu·∫£n l√Ω hi·ªán t·∫°i
        eligibleManagers = allStaff.filter(staff => 
          staff[COL.S_NAME] === currentUser.name || staff[COL.S_NAME] === data[COL.P_MANAGER]
        );
      } else {
        // Ng∆∞·ªùi d√πng th∆∞·ªùng ch·ªâ c√≥ th·ªÉ ch·ªçn ch√≠nh h·ªç n·∫øu h·ªç l√† ng∆∞·ªùi qu·∫£n l√Ω d·ª± √°n
        if (data[COL.P_MANAGER] === currentUser.name) {
          eligibleManagers = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
        }
      }
    }
  } else {
    // N·∫øu l√† t·∫°o m·ªõi ho·∫∑c kh√¥ng c√≥ ng∆∞·ªùi qu·∫£n l√Ω
    if (isAdmin()) {
      eligibleManagers = allStaff;
    } else if (isManager()) {
      eligibleManagers = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
    }
  }
  
  return `
      <div id="project-modal" class="modal">
          <div class="modal-content">
              <div class="flex justify-end space-x-3 mb-6">
                  <button type="button" class="btn-secondary close-modal">H·ªßy</button>
                  <button type="submit" class="btn-primary" form="project-form">${submitText}</button>
              </div>
              
              <h3 class="text-xl font-bold text-gray-900 mb-6">${title}</h3>
              
              <form id="project-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.P_ID]}">` : ''}
                  
                  <div class="form-group">
                      <label class="form-label">T√™n d·ª± √°n *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.P_NAME] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">M√¥ t·∫£</label>
                      <textarea name="description" class="form-textarea">${isEdit ? data[COL.P_DESC] || '' : ''}</textarea>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Qu·∫£n l√Ω d·ª± √°n</label>
                      <select name="manager" class="form-select">
                          <option value="">-- Ch·ªçn qu·∫£n l√Ω --</option>
                          ${eligibleManagers.map(staff => {
                              const selected = isEdit && data[COL.P_MANAGER] === staff[COL.S_NAME] ? 'selected' : '';
                              const staffEmail = staff[COL.S_EMAIL] ? ` (${staff[COL.S_EMAIL]})` : '';
                              return `<option value="${staff[COL.S_NAME]}" ${selected}>${staff[COL.S_NAME]}${staffEmail}</option>`;
                          }).join('')}
                      </select>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                          <input type="date" name="startDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.P_START]) : ''}">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ng√†y k·∫øt th√∫c</label>
                          <input type="date" name="endDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.P_END]) : ''}">
                      </div>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Tr·∫°ng th√°i</label>
                      <select name="status" class="form-select">
                          <option value="Ch∆∞a b·∫Øt ƒë·∫ßu" ${isEdit && data[COL.P_STATUS] === 'Ch∆∞a b·∫Øt ƒë·∫ßu' ? 'selected' : ''}>Ch∆∞a b·∫Øt ƒë·∫ßu</option>
                          <option value="ƒêang th·ª±c hi·ªán" ${isEdit && data[COL.P_STATUS] === 'ƒêang th·ª±c hi·ªán' ? 'selected' : ''}>ƒêang th·ª±c hi·ªán</option>
                          <option value="Ho√†n th√†nh" ${isEdit && data[COL.P_STATUS] === 'Ho√†n th√†nh' ? 'selected' : ''}>Ho√†n th√†nh</option>
                      </select>
                  </div>
                  
                  ${isAdmin() ? `
                      <div class="form-group">
                          <label class="flex items-center space-x-3 cursor-pointer">
                              <input type="checkbox" name="isPublic" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2" ${isEdit && isPublicProject(data) ? 'checked' : ''}>
                              <span class="text-sm font-medium text-gray-700">
                                  üåê Cho ph√©p t·∫•t c·∫£ nh√¢n vi√™n th√™m nhi·ªám v·ª• v√†o d·ª± √°n n√†y
                              </span>
                          </label>
                          <p class="text-xs text-gray-500 mt-1 ml-7">D·ª± √°n n√†y s·∫Ω xu·∫•t hi·ªán trong danh s√°ch khi t·∫•t c·∫£ nh√¢n vi√™n t·∫°o nhi·ªám v·ª• m·ªõi</p>
                      </div>
                  ` : ''}
                  
              </form>
          </div>
      </div>
  `;
}

function createTaskModal(isEdit, data) {
  const title = isEdit ? 'Ch·ªânh s·ª≠a nhi·ªám v·ª•' : 'T·∫°o nhi·ªám v·ª• m·ªõi';
  const submitText = isEdit ? 'C·∫≠p nh·∫≠t' : 'T·∫°o nhi·ªám v·ª•';
  
  // L·ªçc danh s√°ch nh√¢n vi√™n c√≥ th·ªÉ giao vi·ªác
  let assignableStaff = [];
  
  if (isAdmin()) {
    // Admin c√≥ th·ªÉ giao vi·ªác cho t·∫•t c·∫£
    assignableStaff = allStaff;
  } else if (isManager()) {
    // Qu·∫£n l√Ω c√≥ th·ªÉ giao vi·ªác cho t·∫•t c·∫£ tr·ª´ Admin
    assignableStaff = allStaff.filter(staff => {
      const role = (staff[COL.S_ROLE] || '').toLowerCase();
      return !role.includes('admin');
    });
  } else {
    // Ng∆∞·ªùi d√πng th∆∞·ªùng ch·ªâ c√≥ th·ªÉ giao vi·ªác cho ch√≠nh m√¨nh
    assignableStaff = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
  }
  
  // ƒê·∫£m b·∫£o danh s√°ch ng∆∞·ªùi th·ª±c hi·ªán ƒë∆∞·ª£c hi·ªÉn th·ªã ƒë√∫ng
  console.log("Danh s√°ch ng∆∞·ªùi c√≥ th·ªÉ giao vi·ªác:", assignableStaff.map(s => s[COL.S_NAME]));
  
  return `
      <div id="task-modal" class="modal">
          <div class="modal-content">
              <div class="flex justify-end space-x-3 mb-6">
                  <button type="button" class="btn-secondary close-modal">H·ªßy</button>
                  <button type="submit" class="btn-primary" form="task-form">${submitText}</button>
              </div>
              
              <h3 class="text-xl font-bold text-gray-900 mb-6">${title}</h3>
              
              <form id="task-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.T_ID]}">` : ''}
                  
                  <div class="form-group">
                      <label class="form-label">T√™n nhi·ªám v·ª• *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.T_NAME] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Thu·ªôc d·ª± √°n *</label>
                      <select name="projectId" class="form-select" required>
                          <option value="">-- Ch·ªçn d·ª± √°n --</option>
                          ${getAvailableProjectsForTask().map(project => {
                              const selected = isEdit && data[COL.T_PID] === project[COL.P_ID] ? 'selected' : '';
                              const publicLabel = isPublicProject(project) ? ' üåê' : '';
                              return `<option value="${project[COL.P_ID]}" ${selected}>${project[COL.P_NAME]}${publicLabel} (${project[COL.P_ID]})</option>`;
                          }).join('')}
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">M√¥ t·∫£</label>
                      <textarea name="description" class="form-textarea">${isEdit ? data[COL.T_DESC] || '' : ''}</textarea>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                          <select name="assignee" class="form-select">
                              <option value="">-- Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán --</option>
                              ${assignableStaff.map(staff => {
                                  const selected = isEdit && data[COL.T_ASSIGNEE] === staff[COL.S_NAME] ? 'selected' : '';
                                  const staffEmail = staff[COL.S_EMAIL] ? ` (${staff[COL.S_EMAIL]})` : '';
                                  return `<option value="${staff[COL.S_NAME]}" ${selected}>${staff[COL.S_NAME]}${staffEmail}</option>`;
                              }).join('')}
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">∆Øu ti√™n</label>
                          <select name="priority" class="form-select">
                              <option value="Th·∫•p" ${isEdit && data[COL.T_PRIORITY] === 'Th·∫•p' ? 'selected' : ''}>Th·∫•p</option>
                              <option value="Trung b√¨nh" ${isEdit && data[COL.T_PRIORITY] === 'Trung b√¨nh' ? 'selected' : 'selected'}>Trung b√¨nh</option>
                              <option value="Cao" ${isEdit && data[COL.T_PRIORITY] === 'Cao' ? 'selected' : ''}>Cao</option>
                          </select>
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                          <input type="date" name="startDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_START]) : ''}">
                      </div>
                      <div class="form-group">
                          <label class="form-label">H·∫°n ch√≥t</label>
                          <input type="date" name="dueDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_DUE]) : ''}">
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Tr·∫°ng th√°i</label>
                          <select name="status" class="form-select">
                              <option value="Ch∆∞a b·∫Øt ƒë·∫ßu" ${isEdit && data[COL.T_STATUS] === 'Ch∆∞a b·∫Øt ƒë·∫ßu' ? 'selected' : 'selected'}>Ch∆∞a b·∫Øt ƒë·∫ßu</option>
                              <option value="ƒêang th·ª±c hi·ªán" ${isEdit && data[COL.T_STATUS] === 'ƒêang th·ª±c hi·ªán' ? 'selected' : ''}>ƒêang th·ª±c hi·ªán</option>
                              <option value="Ho√†n th√†nh" ${isEdit && data[COL.T_STATUS] === 'Ho√†n th√†nh' ? 'selected' : ''}>Ho√†n th√†nh</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ti·∫øn ƒë·ªô (%)</label>
                          <input type="number" name="completion" class="form-input" min="0" max="100" value="${isEdit ? parseInt(data[COL.T_COMPLETION] || 0) : 0}">
                      </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Ng√†y b√°o c√°o</label>
                    <input type="date" name="reportDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_REPORT_DATE]) : ''}">
                  </div>

                  <div class="form-group">
                    <label class="form-label">M·ª•c ti√™u</label>
                    <textarea name="target" class="form-textarea">${isEdit ? data[COL.T_TARGET] || '' : ''}</textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Link k·∫øt qu·∫£</label>
                    <textarea name="resultLinks" class="form-textarea" placeholder="Nh·∫≠p m·ªói link tr√™n m·ªôt d√≤ng">${isEdit ? data[COL.T_RESULT_LINKS] || '' : ''}</textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">K·∫øt qu·∫£ ƒë·∫ßu ra</label>
                    <textarea name="output" class="form-textarea">${isEdit ? data[COL.T_OUTPUT] || '' : ''}</textarea>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Ghi ch√∫</label>
                      <textarea name="notes" class="form-textarea">${isEdit ? data[COL.T_NOTES] || '' : ''}</textarea>
                  </div>
                  
              </form>
          </div>
      </div>
  `;
}

function createStaffModal(isEdit, data) {
  const title = isEdit ? 'Ch·ªânh s·ª≠a nh√¢n vi√™n' : 'Th√™m nh√¢n vi√™n m·ªõi';
  const submitText = isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m nh√¢n vi√™n';
  
  return `
      <div id="staff-modal" class="modal">
          <div class="modal-content">
              <div class="flex justify-end space-x-3 mb-6">
                  <button type="button" class="btn-secondary close-modal">H·ªßy</button>
                  <button type="submit" class="btn-primary" form="staff-form">${submitText}</button>
              </div>
              
              <h3 class="text-xl font-bold text-gray-900 mb-6">${title}</h3>
              
              <form id="staff-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.S_ID]}">` : ''}
                  
                  <div class="form-group">
                      <label class="form-label">H·ªç t√™n *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.S_NAME] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" name="email" class="form-input" value="${isEdit ? data[COL.S_EMAIL] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Ch·ª©c v·ª•</label>
                      <input type="text" name="position" class="form-input" value="${isEdit ? data[COL.S_POS] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Ph√¢n quy·ªÅn</label>
                      <select name="role" class="permission-select">
                          <option value="Nh√¢n vi√™n" ${isEdit && data[COL.S_ROLE] === 'Nh√¢n vi√™n' ? 'selected' : 'selected'}>Nh√¢n vi√™n</option>
                          <option value="Qu·∫£n l√Ω" ${isEdit && data[COL.S_ROLE] === 'Qu·∫£n l√Ω' ? 'selected' : ''}>Qu·∫£n l√Ω</option>
                          <option value="Admin" ${isEdit && data[COL.S_ROLE] === 'Admin' ? 'selected' : ''}>Admin</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">M·∫≠t kh·∫©u *</label>
                      <input type="text" name="password" class="form-input" required 
                             value="${isEdit ? data[COL.S_PASSWORD] || '' : ''}"
                             placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                  </div>
                  
              </form>
          </div>
      </div>
  `;
}

// === Enhanced Form Handlers with Button Loading ===

// === Public Project Helper Functions ===
function isPublicProject(project) {
    // An to√†n: ki·ªÉm tra d·ª± √°n c√≥ t·ªìn t·∫°i v√† c√≥ thu·ªôc t√≠nh isPublic
    if (!project) return false;
    const publicValue = project[COL.P_IS_PUBLIC];
    // Ki·ªÉm tra c√°c tr∆∞·ªùng h·ª£p: true, "true", "TRUE", "1"
    return publicValue === true || 
           publicValue === "true" || 
           publicValue === "TRUE" || 
           publicValue === "1";
}

function getAvailableProjectsForTask() {
    if (!allProjects) return [];
    
    if (isAdmin() || isManager()) {
        // Admin v√† Manager c√≥ th·ªÉ th·∫•y t·∫•t c·∫£ d·ª± √°n
        return allProjects;
    } else {
        // Nh√¢n vi√™n c√≥ th·ªÉ th·∫•y:
        // 1. D·ª± √°n m√† h·ªç ƒë∆∞·ª£c giao (existing logic)
        // 2. D·ª± √°n public (new feature)
        const userProjects = getUserAllowedProjects() || [];
        const publicProjects = allProjects.filter(p => isPublicProject(p)) || [];
        
        // Merge v√† remove duplicates
        const availableProjects = [...userProjects];
        publicProjects.forEach(publicProject => {
            if (!availableProjects.find(userProject => 
                userProject[COL.P_ID] === publicProject[COL.P_ID])) {
                availableProjects.push(publicProject);
            }
        });
        
        return availableProjects;
    }
}

function handleAdd(type) {
    if (!isAuthenticated) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'error');
        return;
    }
    
    const form = document.getElementById(`${type}-form`);
    const submitBtn = document.querySelector(`button[form="${type}-form"][type="submit"]`);
    const formData = new FormData(form);
    
    let data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho checkbox isPublic
    if (type === 'project') {
        data.isPublic = form.querySelector('input[name="isPublic"]')?.checked || false;
        console.log('Project data being sent:', data); // Debug log
    }
    
    // TH√äM: Validation cho task c·ªßa user th∆∞·ªùng - updated for public projects
    if (type === 'task' && !isAdmin()) {
        const selectedProjectId = data.projectId;
        const availableProjects = getAvailableProjectsForTask();
        const isAllowed = availableProjects.some(p => p[COL.P_ID] === selectedProjectId);
        
        if (!isAllowed) {
            showToast('B·∫°n ch·ªâ c√≥ th·ªÉ t·∫°o nhi·ªám v·ª• trong c√°c d·ª± √°n ƒë∆∞·ª£c ph√©p ho·∫∑c d·ª± √°n chung', 'error');
            return;
        }
    }
    
    // Set button loading state
    setButtonLoading(submitBtn, true);
    
    // Special handling for notifications
    if (type === 'notification') {
        // Handle ALL_STAFF recipient
        if (data.recipient === 'ALL_STAFF') {
            data.recipient = ''; // Server expects empty string for all staff
        }
        
        // Add sender information
        data.sender = currentUser.name;
        data.senderRole = currentUser.role;
        
        const successMessage = isAdmin() || isManager() ? 'Th√¥ng b√°o' : 'B√°o c√°o';
        
        google.script.run
            .withSuccessHandler(function(response) {
                setButtonLoading(submitBtn, false);
                if (response.success) {
                    showToast(`${successMessage} ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!`, 'success');
                    closeModal('notification-modal');
                    loadNotifications(); // Refresh notifications specifically
                    refreshData(); // Refresh other data
                } else {
                    showToast(response.error || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            })
            .withFailureHandler(function(error) {
                setButtonLoading(submitBtn, false);
                showToast(`L·ªói g·ª≠i ${successMessage.toLowerCase()}: ` + error.message, 'error');
            })
            .addNotificationWithAuth(data);
        return;
    }
    
    let apiMethod = '';
    if (type === 'project') apiMethod = 'addProjectWithAuth';
    else if (type === 'task') apiMethod = 'addTaskWithAuth';
    else if (type === 'staff') apiMethod = 'addStaffWithAuth';
    
    google.script.run
        .withSuccessHandler(function(response) {
            setButtonLoading(submitBtn, false);
            if (response.success) {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!`, 'success');
                closeModal(`${type}-modal`);
                forceRefreshAllSections(); // Force refresh all sections including current view
            } else {
                showToast(response.error || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
        })
        .withFailureHandler(function(error) {
            setButtonLoading(submitBtn, false);
            showToast('L·ªói: ' + error.message, 'error');
        })
        [apiMethod](data);
}

function handleEdit(type, originalData) {
    if (!isAuthenticated) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'error');
        return;
    }
    
    const form = document.getElementById(`${type}-form`);
    const submitBtn = document.querySelector(`button[form="${type}-form"][type="submit"]`);
    const formData = new FormData(form);
    
    let data = {};
    for (let [key, value] of formData.entries()) {
        if (key !== 'id') data[key] = value;
    }
    
    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho checkbox isPublic
    if (type === 'project') {
        data.isPublic = form.querySelector('input[name="isPublic"]')?.checked || false;
        console.log('Project edit data being sent:', data); // Debug log
    }
    
    const id = formData.get('id');
    
    // Set button loading state
    setButtonLoading(submitBtn, true);
    
    let apiMethod = '';
    if (type === 'project') apiMethod = 'updateProjectWithAuth';
    else if (type === 'task') apiMethod = 'updateTaskWithAuth';
    else if (type === 'staff') apiMethod = 'updateStaffWithAuth';
    
    google.script.run
        .withSuccessHandler(function(response) {
            setButtonLoading(submitBtn, false);
            if (response.success) {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!`, 'success');
                closeModal(`${type}-modal`);
                forceRefreshAllSections(); // Force refresh all sections including current view
            } else {
                showToast(response.error || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
        })
        .withFailureHandler(function(error) {
            setButtonLoading(submitBtn, false);
            showToast('L·ªói: ' + error.message, 'error');
        })
        [apiMethod](id, data);
}

function confirmDelete(type, id, name) {
    if (!isAuthenticated) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'error');
        return;
    }
    
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${type} "${name}"?`)) {
        // Find the delete button and set loading
        const deleteBtn = document.querySelector(`[data-type="${type}"][data-id="${id}"].delete-btn`);
        if (deleteBtn) setButtonLoading(deleteBtn, true);
        
        let apiMethod = '';
        if (type === 'project') apiMethod = 'deleteProjectWithAuth';
        else if (type === 'task') apiMethod = 'deleteTaskWithAuth';
        else if (type === 'staff') apiMethod = 'deleteStaffWithAuth';
        
        google.script.run
            .withSuccessHandler(function(response) {
                if (deleteBtn) setButtonLoading(deleteBtn, false);
                if (response.success) {
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!`, 'success');
                    forceRefreshAllSections(); // Force refresh all sections including current view
                } else {
                    showToast(response.error || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            })
            .withFailureHandler(function(error) {
                if (deleteBtn) setButtonLoading(deleteBtn, false);
                showToast('L·ªói: ' + error.message, 'error');
            })
            [apiMethod](id);
    }
}

function refreshData() {
    if (!isAuthenticated) return;
    
    // showLoading('ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu...');
    
    google.script.run
        .withSuccessHandler(function(response) {
            // hideLoading();
            if (response.success) {
                handleSuccessfulLogin(response);
            } else {
                showToast(response.error || 'L·ªói khi t·∫£i d·ªØ li·ªáu', 'error');
            }
        })
        .withFailureHandler(function(error) {
            // hideLoading();
            showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        })
        .getDataForUser();
}

function forceRefreshAllSections() {
    if (!isAuthenticated) return;
    
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                // Update global data
                allProjects = response.projects || [];
                allTasks = response.tasks || [];
                allStaff = response.staff || [];
                
                // Force refresh all sections regardless of current view
                renderStats(response.summaryStats);
                renderProjectTaskTree();
                renderPriorityTasks();
                renderProjects();
                renderTasks();
                renderStaff();
                renderChart(response.chartData);
                renderProjectProgressChart();
                renderStaffPerformanceChart();
                renderActivity(response.recentActivities);
                renderNotifications(response.notifications);
                populateDropdowns();
                
                if (currentSection === 'gantt') {
                    renderGanttChart();
                }
            } else {
                showToast(response.error || 'L·ªói khi t·∫£i d·ªØ li·ªáu', 'error');
            }
        })
        .withFailureHandler(function(error) {
            showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        })
        .getDataForUser();
}

// === Load Notifications Separately ===
function loadNotifications() {
    if (!isAuthenticated) return;
    
    google.script.run
        .withSuccessHandler(function(notifications) {
            if (notifications && Array.isArray(notifications)) {
                allNotifications = notifications;
                
                // Update notification counter if it exists
                const counter = document.getElementById('notification-counter');
                if (counter) {
                    const unreadCount = notifications.filter(n => !n.read).length;
                    counter.textContent = unreadCount;
                    counter.style.display = unreadCount > 0 ? 'inline' : 'none';
                }
                
                console.log(`Loaded ${notifications.length} notifications`);
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error loading notifications:', error);
        })
        .getNotificationsForUser();
}

// === Button Loading State Management ===
function setButtonLoading(button, isLoading) {
    if (!button) {
        console.warn('setButtonLoading: button not found');
        return;
    }
    
    console.log('setButtonLoading:', button, 'isLoading:', isLoading);
    
    if (isLoading) {
        button.classList.add('loading');
        button.disabled = true;
        // Store original content
        if (!button.dataset.originalContent) {
            button.dataset.originalContent = button.innerHTML;
        }
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    } else {
        button.classList.remove('loading');
        button.disabled = false;
        // Restore original content
        if (button.dataset.originalContent) {
            button.innerHTML = button.dataset.originalContent;
            delete button.dataset.originalContent;
        }
    }
}

// === Utility Functions ===
function populateDropdowns() {
    // This is handled in modal creation
}

function handleSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    // Filter current section data
    if (currentSection === 'projects') {
        filterCards('.project-card', searchTerm);
    } else if (currentSection === 'tasks') {
        filterCards('.task-card', searchTerm);
    } else if (currentSection === 'staff') {
        filterCards('.staff-card', searchTerm);
    }
}

function handleProjectTaskSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    // Filter project tree items
    const projectItems = document.querySelectorAll('.project-tree-item');
    projectItems.forEach(item => {
        const projectText = item.textContent.toLowerCase();
        const projectId = item.dataset.id.toLowerCase();
        
        // Check if project matches search
        const projectMatches = projectText.includes(searchTerm) || projectId.includes(searchTerm);
        
        // Check if any tasks within project match search
        const taskItems = item.querySelectorAll('.task-tree-item');
        let hasMatchingTask = false;
        
        taskItems.forEach(taskItem => {
            const taskText = taskItem.textContent.toLowerCase();
            const taskId = taskItem.dataset.id.toLowerCase();
            const taskMatches = taskText.includes(searchTerm) || taskId.includes(searchTerm);
            
            // N·∫øu d·ª± √°n match th√¨ hi·ªÉn th·ªã t·∫•t c·∫£ task, ng∆∞·ª£c l·∫°i ch·ªâ hi·ªÉn th·ªã task match
            const shouldShowTask = projectMatches || taskMatches || searchTerm === '';
            taskItem.style.display = shouldShowTask ? 'block' : 'none';
            if (taskMatches) hasMatchingTask = true;
        });
        
        // Show project if it matches or has matching tasks
        const shouldShowProject = projectMatches || hasMatchingTask || searchTerm === '';
        item.style.display = shouldShowProject ? 'block' : 'none';
        
        // T·ª± ƒë·ªông expand n·∫øu: project match HO·∫∂C c√≥ task match
        if (shouldShowProject && (projectMatches || hasMatchingTask) && searchTerm !== '') {
            const tasksContainer = item.querySelector('.project-tasks');
            const expandBtn = item.querySelector('.project-expand-btn');
            if (tasksContainer && expandBtn) {
                tasksContainer.classList.add('expanded');
                const icon = expandBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
                expandBtn.classList.add('expanded');
            }
        }
    });
}

function filterCards(selector, searchTerm) {
    const cards = document.querySelectorAll(selector);
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        const id = card.dataset.id.toLowerCase();
        const isVisible = text.includes(searchTerm) || id.includes(searchTerm);
        card.style.display = isVisible ? 'block' : 'none';
    });
}

function toggleNotifications() {
    // Handled by Alpine.js
}

function markNotificationRead(notificationId, element) {
    if (!notificationId || element.classList.contains('opacity-60')) return;
    
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                element.classList.add('opacity-60');
                const dot = element.querySelector('.w-2.h-2');
                if (dot) dot.classList.replace('bg-blue-500', 'bg-gray-300');
                
                // Update badge
                const badge = document.getElementById('notification-badge');
                const currentCount = parseInt(badge.textContent) || 0;
                if (currentCount > 1) {
                    badge.textContent = currentCount - 1;
                } else {
                    badge.classList.add('hidden');
                }
            }
        })
        .withFailureHandler(function(error) {
            showToast('L·ªói c·∫≠p nh·∫≠t th√¥ng b√°o: ' + error.message, 'error');
        })
        .markNotificationAsRead(notificationId);
}

function clearNotifications() {
    if (confirm('X√≥a t·∫•t c·∫£ th√¥ng b√°o ƒë√£ ƒë·ªçc?')) {
        // ‚úÖ HI·ªÇN TH·ªä LOADING
        const clearBtn = document.getElementById('clear-notifications');
        if (clearBtn) {
            clearBtn.textContent = 'ƒêang x√≥a...';
            clearBtn.disabled = true;
        }
        
        google.script.run
            .withSuccessHandler(function(response) {
                // ‚úÖ RESET BUTTON
                if (clearBtn) {
                    clearBtn.textContent = 'X√≥a ƒë√£ ƒë·ªçc';
                    clearBtn.disabled = false;
                }
                
                if (response.success) {
                    showToast(`ƒê√£ x√≥a ${response.deletedCount || 0} th√¥ng b√°o`, 'success');
                    // ‚úÖ REFRESH NOTIFICATIONS
                    refreshNotifications();
                } else {
                    showToast(response.error || 'L·ªói x√≥a th√¥ng b√°o', 'error');
                }
            })
            .withFailureHandler(function(error) {
                // ‚úÖ RESET BUTTON ON ERROR
                if (clearBtn) {
                    clearBtn.textContent = 'X√≥a ƒë√£ ƒë·ªçc';
                    clearBtn.disabled = false;
                }
                showToast('L·ªói: ' + error.message, 'error');
            })
            .clearReadNotifications();
    }
}

function clearActivity() {
    if (!isAdmin()) {
        showToast('Ch·ªâ admin m·ªõi c√≥ th·ªÉ x√≥a ho·∫°t ƒë·ªông', 'error');
        return;
    }
    
    if (confirm('X√≥a t·∫•t c·∫£ ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        const clearBtn = document.getElementById('clear-activity-btn');
        if (clearBtn) {
            clearBtn.textContent = 'ƒêang x√≥a...';
            clearBtn.disabled = true;
        }
        
        google.script.run
            .withSuccessHandler(function(response) {
                if (clearBtn) {
                    clearBtn.textContent = 'Clear';
                    clearBtn.disabled = false;
                }
                
                if (response.success) {
                    showToast(`ƒê√£ x√≥a ${response.deletedCount || 0} ho·∫°t ƒë·ªông`, 'success');
                    // Refresh activity log
                    document.getElementById('recent-activity').innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o</div>';
                } else {
                    showToast(response.error || 'L·ªói x√≥a ho·∫°t ƒë·ªông', 'error');
                }
            })
            .withFailureHandler(function(error) {
                if (clearBtn) {
                    clearBtn.textContent = 'Clear';
                    clearBtn.disabled = false;
                }
                showToast('L·ªói: ' + error.message, 'error');
            })
            .clearActivityLog();
    }
}

// ‚úÖ TH√äM H√ÄM REFRESH NOTIFICATIONS
function refreshNotifications() {
    google.script.run
        .withSuccessHandler(function(notifications) {
            renderNotifications(notifications);
        })
        .withFailureHandler(function(error) {
            showToast('L·ªói t·∫£i th√¥ng b√°o: ' + error.message, 'error');
        })
        .getNotifications();
}

function getStatusClass(status) {
    const statusLower = status.toLowerCase();
    if (statusLower.includes('ho√†n th√†nh')) return 'status-completed';
    if (statusLower.includes('ƒëang')) return 'status-active';
    if (statusLower.includes('qu√° h·∫°n')) return 'status-overdue';
    return 'status-pending';
}

function getPriorityClass(priority) {
    const priorityLower = priority.toLowerCase();
    if (priorityLower.includes('cao')) return 'priority-high';
    if (priorityLower.includes('th·∫•p')) return 'priority-low';
    return 'priority-medium';
}

function isTaskOverdue(dueDate) {
    if (!dueDate) return false;
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const due = new Date(dueDate);
        due.setHours(0, 0, 0, 0);
        return due < today;
    } catch (e) {
        return false;
    }
}

function formatDateForDisplay(dateInput, includeTime = false) {
    if (!dateInput) return '';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return dateInput;
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        let formatted = `${day}/${month}/${year}`;
        
        if (includeTime) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            formatted += ` ${hours}:${minutes}`;
        }
        
        return formatted;
    } catch (e) {
        return dateInput;
    }
}

function formatDateForInput(dateInput) {
    if (!dateInput) return '';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return '';
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    } catch (e) {
        return '';
    }
}

function showLoading(message = 'ƒêang x·ª≠ l√Ω...') {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.remove('hidden');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: 'fa-check-circle text-green-500',
        error: 'fa-exclamation-circle text-red-500',
        info: 'fa-info-circle text-blue-500'
    };
    
    toast.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas ${icons[type] || icons.info}"></i>
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                ƒê√≥ng
            </button>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Show animation
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function getUserAllowedProjects() {
  if (isAdmin()) {
    return allProjects;
  }
  
  if (isManager()) {
    // Qu·∫£n l√Ω ch·ªâ th·∫•y d·ª± √°n h·ªç qu·∫£n l√Ω ho·∫∑c c√≥ nhi·ªám v·ª•
    const managerProjects = allProjects.filter(project => 
      project[COL.P_MANAGER] === currentUser.name
    );
    
    // Th√™m c√°c d·ª± √°n m√† qu·∫£n l√Ω c√≥ nhi·ªám v·ª•
    const managerTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
    const taskProjectIds = [...new Set(managerTasks.map(task => task[COL.T_PID]))];
    
    const projectIds = new Set([
      ...managerProjects.map(p => p[COL.P_ID]),
      ...taskProjectIds
    ]);
    
    return allProjects.filter(project => projectIds.has(project[COL.P_ID]));
  }
  
  // Ng∆∞·ªùi d√πng th∆∞·ªùng - d·ª± √°n h·ªç c√≥ nhi·ªám v·ª• ho·∫∑c qu·∫£n l√Ω
  const userTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
  const userTaskProjectIds = [...new Set(userTasks.map(task => task[COL.T_PID]))];
  
  // Th√™m c√°c d·ª± √°n m√† ng∆∞·ªùi d√πng l√† ng∆∞·ªùi qu·∫£n l√Ω
  const managedProjects = allProjects.filter(project => project[COL.P_MANAGER] === currentUser.name);
  const managedProjectIds = managedProjects.map(p => p[COL.P_ID]);
  
  const projectIds = new Set([...userTaskProjectIds, ...managedProjectIds]);
  
  return allProjects.filter(project => projectIds.has(project[COL.P_ID]));
}

function canUserCreateTask() {
  if (isAdmin() || isManager()) {
    return true;
  }
  
  // User th∆∞·ªùng c√≥ th·ªÉ t·∫°o task n·∫øu h·ªç l√† ng∆∞·ªùi ƒë∆∞·ª£c ph·ª• tr√°ch d·ª± √°n ho·∫∑c ƒë√£ c√≥ task
  if (currentUser) {
    // Ki·ªÉm tra xem user c√≥ ph·∫£i l√† ng∆∞·ªùi ph·ª• tr√°ch d·ª± √°n n√†o kh√¥ng
    const userManagedProjects = allProjects.filter(project => 
      project[COL.P_MANAGER] === currentUser.name
    );
    
    if (userManagedProjects.length > 0) {
      return true;
    }
    
    // Ho·∫∑c ki·ªÉm tra n·∫øu user ƒë√£ c√≥ nhi·ªám v·ª• trong h·ªá th·ªëng
    if (allTasks) {
      const userTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
      return userTasks.length > 0;
    }
  }
  
  return false;
}

function createNotificationModal(isEdit, data) {
  // Determine title and recipients based on user role
  let modalTitle = 'T·∫°o th√¥ng b√°o m·ªõi';
  let recipientOptions = '';
  
  if (isAdmin()) {
    // Admin c√≥ th·ªÉ g·ª≠i cho t·∫•t c·∫£
    modalTitle = 'T·∫°o th√¥ng b√°o m·ªõi';
    recipientOptions = `
      <option value="">T·∫•t c·∫£ m·ªçi ng∆∞·ªùi</option>
      ${allStaff.map(staff => 
        `<option value="${staff[COL.S_NAME]}">${staff[COL.S_NAME]} (${staff[COL.S_EMAIL] || 'No email'})</option>`
      ).join('')}
    `;
  } else if (isManager()) {
    // Manager ch·ªâ c√≥ th·ªÉ g·ª≠i cho nh√¢n vi√™n (kh√¥ng ph·∫£i admin) ho·∫∑c l√™n admin
    modalTitle = 'G·ª≠i th√¥ng b√°o cho team';
    const staffMembers = allStaff.filter(staff => {
      const role = (staff[COL.S_ROLE] || '').toLowerCase();
      return !role.includes('admin') && !role.includes('qu·∫£n l√Ω');
    });
    const adminMembers = allStaff.filter(staff => {
      const role = (staff[COL.S_ROLE] || '').toLowerCase();
      return role.includes('admin');
    });
    
    recipientOptions = `
      <option value="">Ch·ªçn ng∆∞·ªùi nh·∫≠n</option>
      <optgroup label="G·ª≠i l√™n c·∫•p tr√™n">
        ${adminMembers.map(admin => 
          `<option value="${admin[COL.S_NAME]}">${admin[COL.S_NAME]} (Admin)</option>`
        ).join('')}
      </optgroup>
      <optgroup label="G·ª≠i cho nh√¢n vi√™n">
        <option value="ALL_STAFF">T·∫•t c·∫£ nh√¢n vi√™n</option>
        ${staffMembers.map(staff => 
          `<option value="${staff[COL.S_NAME]}">${staff[COL.S_NAME]} (${staff[COL.S_EMAIL] || 'No email'})</option>`
        ).join('')}
      </optgroup>
    `;
  } else {
    // Staff ch·ªâ c√≥ th·ªÉ g·ª≠i l√™n qu·∫£n l√Ω ho·∫∑c admin
    modalTitle = 'G·ª≠i b√°o c√°o l√™n c·∫•p tr√™n';
    const managers = allStaff.filter(staff => {
      if (!staff || staff[COL.S_NAME] === currentUser.name) return false; // Don't include self
      
      const role = (staff[COL.S_ROLE] || '').toLowerCase().trim();
      console.log('Staff role check:', staff[COL.S_NAME], 'Role:', `"${role}"`);
      
      // Check for various manager/admin role patterns
      return role.includes('admin') || 
             role.includes('qu·∫£n l√Ω') || 
             role.includes('manager') || 
             role.includes('qu·∫£n ly') ||
             role.includes('gi√°m ƒë·ªëc') ||
             role.includes('tr∆∞·ªüng') ||
             role === 'admin' ||
             role === 'manager';
    });
    
    console.log('Found managers for staff:', managers.map(m => ({name: m[COL.S_NAME], role: m[COL.S_ROLE]})));
    
    recipientOptions = `
      <option value="">Ch·ªçn ng∆∞·ªùi nh·∫≠n</option>
      ${managers.map(manager => 
        `<option value="${manager[COL.S_NAME]}">${manager[COL.S_NAME]} (${manager[COL.S_ROLE]})</option>`
      ).join('')}
    `;
  }

  return `
    <div id="notification-modal" class="modal">
      <div class="modal-content">
        <div class="flex justify-end space-x-3 mb-6">
          <button type="button" class="btn-secondary close-modal">H·ªßy</button>
          <button type="submit" class="btn-primary" form="notification-form">G·ª≠i ${isAdmin() || isManager() ? 'th√¥ng b√°o' : 'b√°o c√°o'}</button>
        </div>
        
        <h3 class="text-xl font-bold text-gray-900 mb-6">${modalTitle}</h3>
        
        <form id="notification-form">
          <div class="form-group">
            <label class="form-label">N·ªôi dung ${isAdmin() || isManager() ? 'th√¥ng b√°o' : 'b√°o c√°o'} *</label>
            <textarea name="content" class="form-textarea" required placeholder="Nh·∫≠p n·ªôi dung ${isAdmin() || isManager() ? 'th√¥ng b√°o' : 'b√°o c√°o'}..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Ng∆∞·ªùi nh·∫≠n *</label>
            <select name="recipient" class="form-select" required>
              ${recipientOptions}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Lo·∫°i ${isAdmin() || isManager() ? 'th√¥ng b√°o' : 'b√°o c√°o'}</label>
            <select name="type" class="form-select">
              ${isAdmin() ? `
                <option value="Th√¥ng b√°o">Th√¥ng b√°o chung</option>
                <option value="Kh·∫©n c·∫•p">Kh·∫©n c·∫•p</option>
                <option value="C√¥ng vi·ªác">C√¥ng vi·ªác</option>
                <option value="H·ªá th·ªëng">H·ªá th·ªëng</option>
              ` : isManager() ? `
                <option value="C√¥ng vi·ªác">C√¥ng vi·ªác</option>
                <option value="Th√¥ng b√°o">Th√¥ng b√°o team</option>
                <option value="B√°o c√°o">B√°o c√°o l√™n c·∫•p tr√™n</option>
              ` : `
                <option value="B√°o c√°o">B√°o c√°o c√¥ng vi·ªác</option>
                <option value="Y√™u c·∫ßu">Y√™u c·∫ßu h·ªó tr·ª£</option>
                <option value="V·∫•n ƒë·ªÅ">B√°o c√°o v·∫•n ƒë·ªÅ</option>
              `}
            </select>
            <!-- Hidden fields for additional data -->
            <input type="hidden" name="sender" value="${currentUser.name}">
            <input type="hidden" name="senderRole" value="${currentUser.role}">
          </div>
          
        </form>
      </div>
    </div>
  `;
}

// === Gantt Chart Functions ===
function renderGanttChart() {
  if (currentSection !== 'gantt') return;
  
  const ganttContainer = document.getElementById('gantt-container');
  const ganttHeader = document.getElementById('gantt-header');
  const ganttItems = document.getElementById('gantt-items');
  const currentPeriod = document.getElementById('current-period');
  
  if (!ganttContainer || !ganttHeader || !ganttItems || !currentPeriod) return;
  
  // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ k·ª≥ hi·ªÉn th·ªã
  const monthName = currentGanttDate.toLocaleString('vi-VN', { month: 'long' });
  const year = currentGanttDate.getFullYear();
  currentPeriod.textContent = `${monthName} ${year}`;
  
  // T·∫°o header v·ªõi ng√†y trong th√°ng
  const daysInMonth = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0).getDate();
  const firstDay = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth(), 1);
  const daysHeader = document.querySelector('.gantt-days');
  
  // S·ª≠a l·∫°i CSS cho ph·∫ßn header ng√†y ƒë·ªÉ hi·ªÉn th·ªã ngang
  daysHeader.style.display = 'flex';
  daysHeader.style.flexDirection = 'row';
  
  let daysHTML = '';
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth(), day);
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const isToday = isSameDate(date, new Date());
    const dayName = date.toLocaleString('vi-VN', { weekday: 'short' });
    
    daysHTML += `
      <div class="gantt-day ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
        <div class="gantt-day-number">${day}</div>
        <div class="gantt-day-label">${dayName}</div>
      </div>
    `;
  }
  daysHeader.innerHTML = daysHTML;
  
  // Hi·ªÉn th·ªã d·ª± √°n v√† nhi·ªám v·ª•
  let itemsHTML = '';

  // Hi·ªÉn th·ªã c·∫£ d·ª± √°n v√† nhi·ªám v·ª• theo nh√≥m
  allProjects.forEach(project => {
    const projectStartDate = new Date(project[COL.P_START]);
    const projectEndDate = new Date(project[COL.P_END]);
    
    // Ki·ªÉm tra xem d·ª± √°n c√≥ hi·ªÉn th·ªã trong th√°ng hi·ªán t·∫°i kh√¥ng
    if (isDateInMonth(projectStartDate, currentGanttDate) || 
        isDateInMonth(projectEndDate, currentGanttDate) || 
        (projectStartDate < firstDay && projectEndDate > new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0))) {
      
      // === RENDER PROJECT ===
      const projectGanttBarStyle = calculateGanttBarStyle(projectStartDate, projectEndDate, currentGanttDate, daysInMonth);
      const projectTasks = allTasks.filter(task => task[COL.T_PID] === project[COL.P_ID]);
      const completedProjectTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length;
      const projectProgressPercent = projectTasks.length > 0 ? Math.round((completedProjectTasks / projectTasks.length) * 100) : 0;
      const projectIsOverdue = new Date() > projectEndDate && projectProgressPercent < 100;
      const projectFormattedStartDate = formatDateForGantt(project[COL.P_START]);
      const projectFormattedEndDate = formatDateForGantt(project[COL.P_END]);
      const projectDescription = project[COL.P_DESC] || 'Kh√¥ng c√≥ m√¥ t·∫£';
      const projectId = project[COL.P_ID];
      const publicIcon = isPublicProject(project) ? '<span class="ml-1 text-blue-600" title="D·ª± √°n chung">üåê</span>' : '';
      
      itemsHTML += `
        <div class="gantt-project-group" data-project-id="${projectId}">
          <div class="gantt-item" data-id="${projectId}" data-type="project">
            <div class="gantt-item-label">
              <div class="flex items-center flex-1 min-w-0">
                <button class="gantt-toggle-btn mr-2 hover:bg-gray-100 rounded transition-colors duration-200 flex-shrink-0" data-project="${projectId}">
                  ‚à®
                </button>
                
                <span class="truncate cursor-pointer hover:text-blue-600 transition-colors duration-200" onclick="showProjectDetailsModal('${projectId}', '${project[COL.P_NAME]}')">${project[COL.P_NAME]}${publicIcon}</span>
              </div>
              
              <div class="gantt-item-actions">
                <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Ch·ªânh s·ª≠a">
                  S·ª≠a
                </button>
                <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${project[COL.P_NAME]}" title="X√≥a">
                  X√≥a
                </button>
              </div>
            </div>
            
            <div class="gantt-item-timeline">
              <div class="gantt-bar gantt-bar-project ${projectIsOverdue ? 'gantt-bar-overdue' : ''}" style="${projectGanttBarStyle}" data-tooltip="${project[COL.P_NAME]}: ${projectDescription}">
                <div class="gantt-bar-label">${projectFormattedStartDate} - ${projectFormattedEndDate}</div>
                <div class="gantt-progress" style="width: ${projectProgressPercent}%"></div>
              </div>
            </div>
          </div>
          
          <div class="gantt-project-tasks" id="gantt-tasks-${projectId}">
            ${projectTasks.map(task => {
              const taskStartDate = new Date(task[COL.T_START]);
              const taskEndDate = new Date(task[COL.T_DUE]);
              
                const projectEndDate = new Date(project[COL.P_END]);
                const lastDayOfMonth = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0);

                // Hi·ªÉn th·ªã t·∫•t c·∫£ nhi·ªám v·ª• n·∫øu d·ª± √°n k·∫øt th√∫c trong ho·∫∑c sau th√°ng hi·ªán t·∫°i
                if (projectEndDate >= firstDay) {
                
                // T√≠nh to√°n c√°c gi√° tr·ªã Gantt cho task
                const taskGanttBarStyle = calculateGanttBarStyle(taskStartDate, taskEndDate, currentGanttDate, daysInMonth);
                const taskProgressPercent = parseInt(task[COL.T_COMPLETION] || 0);
                const taskIsOverdue = isTaskOverdue(task[COL.T_DUE]) && !(task[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh');
                const taskAssignee = task[COL.T_ASSIGNEE] || 'Ch∆∞a g√°n';
                const taskStatus = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
                const taskPriority = task[COL.T_PRIORITY] || 'Trung b√¨nh';
                const taskFormattedStartDate = formatDateForGantt(task[COL.T_START]);
                const taskFormattedEndDate = formatDateForGantt(task[COL.T_DUE]);
                const taskDescription = task[COL.T_DESC] || 'Kh√¥ng c√≥ m√¥ t·∫£';
                
                // X·ª≠ l√Ω c√°c link n·∫øu c√≥
                const taskLinks = task[COL.T_RESULT_LINKS] ? task[COL.T_RESULT_LINKS].split('\n').filter(link => link.trim() !== '') : [];
                const hasLinks = taskLinks.length > 0;
                
                return `
                  <div class="gantt-item gantt-task-item" data-id="${task[COL.T_ID]}" data-type="task" data-project-id="${task[COL.T_PID]}">
                    <div class="gantt-item-label">
                      <div class="flex flex-col flex-1 min-w-0">
                        <span class="truncate cursor-pointer hover:text-blue-600 transition-colors duration-200" onclick="openEditModal('task', '${task[COL.T_ID]}')">${task[COL.T_NAME]}</span>
                        <span class="text-xs text-gray-500 truncate">${taskAssignee} - ${taskStatus} - ${taskPriority}</span>
                        
                        ${hasLinks ? `
                          <div class="flex gap-2 mt-1 overflow-x-auto">
                            ${taskLinks.map((link, index) => `
                              <a href="${link}" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center flex-shrink-0">
                                Link ${index + 1}
                              </a>
                            `).join('')}
                          </div>
                        ` : ''}
                      </div>
                      
                      <div class="gantt-item-actions">
                        <button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${task[COL.T_ID]}" data-name="${task[COL.T_NAME]}" title="X√≥a">
                          X√≥a
                        </button>
                      </div>
                    </div>
                    
                    <div class="gantt-item-timeline">
                      ${isDateInMonth(taskStartDate, currentGanttDate) || 
                        isDateInMonth(taskEndDate, currentGanttDate) || 
                        (taskStartDate < firstDay && taskEndDate > new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0)) ?
                        `<div class="gantt-bar gantt-bar-task ${taskIsOverdue ? 'gantt-bar-overdue' : ''}" style="${taskGanttBarStyle}" data-tooltip="${task[COL.T_NAME]}: ${taskDescription}">
                          <div class="gantt-bar-label">${taskFormattedStartDate} - ${taskFormattedEndDate}</div>
                          <div class="gantt-progress" style="width: ${taskProgressPercent}%"></div>
                        </div>` :
                        `<div class="gantt-non-visible-task" style="height: 20px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; font-style: italic;">
                          ${taskFormattedStartDate} - ${taskFormattedEndDate}: Kh√¥ng hi·ªÉn th·ªã trong th√°ng n√†y
                        </div>`
                      }
                    </div>
                  </div>
                `;
              }
              return '';
            }).join('')}
          </div>
        </div>
      `;
    }
  });

  // Hi·ªÉn th·ªã tr·ªëng n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
  if (itemsHTML === '') {
    itemsHTML = '';
  }
  // Render d·ªØ li·ªáu
  ganttItems.innerHTML = itemsHTML;
  // Th√™m s·ª± ki·ªán toggle cho c√°c n√∫t m≈©i t√™n
  document.querySelectorAll('.gantt-toggle-btn').forEach(btn => {
    // X√≥a event listeners c≈© tr∆∞·ªõc khi th√™m m·ªõi ƒë·ªÉ tr√°nh duplicate
    btn.removeEventListener('click', toggleGanttProject);
    btn.addEventListener('click', toggleGanttProject);
  });

  // Kh√¥i ph·ª•c tr·∫°ng th√°i x·ªï c·ªßa c√°c d·ª± √°n  
  expandedProjects.forEach(projectId => {
    const taskContainer = document.getElementById(`gantt-tasks-${projectId}`);
    const toggleBtn = document.querySelector(`.gantt-toggle-btn[data-project="${projectId}"]`);
    
    if (taskContainer && toggleBtn) {
      taskContainer.classList.remove('hidden');
      toggleBtn.textContent = '‚à®'; // M≈©i t√™n xu·ªëng
    }
  });
}

// H√†m x·ª≠ l√Ω s·ª± ki·ªán toggle cho c√°c n√∫t m≈©i t√™n trong Gantt chart
function toggleGanttProject(event) {
  const projectId = this.dataset.project;
  const taskContainer = document.getElementById(`gantt-tasks-${projectId}`);
  
  // V√¨ m·∫∑c ƒë·ªãnh hi·ªÉn th·ªã, n√™n ta toggle ng∆∞·ª£c l·∫°i
  if (taskContainer.classList.contains('hidden')) {
    // N·∫øu ƒëang ·∫©n, hi·ªÉn th·ªã l·∫°i
    taskContainer.classList.remove('hidden');
    this.textContent = '‚à®'; // M≈©i t√™n xu·ªëng
    expandedProjects.add(projectId);
  } else {
    // N·∫øu ƒëang hi·ªÉn th·ªã, ·∫©n ƒëi  
    taskContainer.classList.add('hidden');
    this.textContent = '>'; // M≈©i t√™n ph·∫£i
    expandedProjects.delete(projectId);
  }
}

// H√†m t√≠nh to√°n style cho gantt bar
function calculateGanttBarStyle(startDate, endDate, currentMonth, daysInMonth) {
  // ƒê·∫£m b·∫£o ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c h·ª£p l·ªá
  if (!startDate || isNaN(startDate.getTime())) {
    startDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
  }
  
  if (!endDate || isNaN(endDate.getTime())) {
    endDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), daysInMonth);
  }
  
  // Ng√†y ƒë·∫ßu v√† cu·ªëi th√°ng
  const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
  const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), daysInMonth);
  
  // N·∫øu c·∫£ startDate v√† endDate ƒë·ªÅu n·∫±m ngo√†i th√°ng hi·ªán t·∫°i
  if (startDate < monthStart && endDate > monthEnd) {
    return 'left: 0; width: 100%;';
  }
  
  // ƒêi·ªÅu ch·ªânh startDate v√† endDate trong ph·∫°m vi th√°ng hi·ªán t·∫°i
  const effectiveStartDate = startDate < monthStart ? monthStart : startDate;
  const effectiveEndDate = endDate > monthEnd ? monthEnd : endDate;
  
  // T√≠nh to√°n ch√≠nh x√°c h∆°n
  const startDay = effectiveStartDate.getDate();
  const endDay = effectiveEndDate.getDate();
  
  // T√≠nh v·ªã tr√≠ b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c theo ph·∫ßn trƒÉm
  // M·ªói ng√†y chi·∫øm 1/daysInMonth c·ªßa chi·ªÅu r·ªông
  const dayWidth = 100 / daysInMonth;
  const leftPercent = (startDay - 1) * dayWidth;
  const widthPercent = (endDay - startDay + 1) * dayWidth;
  
  return `left: ${leftPercent}%; width: ${widthPercent}%;`;
}

// Ki·ªÉm tra xem m·ªôt ng√†y c√≥ n·∫±m trong th√°ng kh√¥ng
function isDateInMonth(date, monthDate) {
  if (!date || isNaN(date.getTime())) return false;
  return date.getMonth() === monthDate.getMonth() && date.getFullYear() === monthDate.getFullYear();
}

// Ki·ªÉm tra xem hai ng√†y c√≥ gi·ªëng nhau kh√¥ng
function isSameDate(date1, date2) {
  return date1.getDate() === date2.getDate() && 
         date1.getMonth() === date2.getMonth() && 
         date1.getFullYear() === date2.getFullYear();
}

// H√†m ƒëi·ªÅu h∆∞·ªõng th√°ng tr∆∞·ªõc/sau
function navigateGanttMonth(direction) {
  const newDate = new Date(currentGanttDate);
  newDate.setMonth(newDate.getMonth() + direction);
  currentGanttDate = newDate;
  renderGanttChart();
  
  // Th√™m timeout ng·∫Øn ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr∆∞·ªõc khi thi·∫øt l·∫≠p l·∫°i event listeners
  setTimeout(() => {
    setupGanttEventListeners();
  }, 50);
}

// H√†m t√¨m ki·∫øm trong Gantt chart
function searchGantt(searchTerm) {
  if (!searchTerm) {
    // Hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£ c√°c item
    document.querySelectorAll('.gantt-item').forEach(item => {
      item.style.display = 'flex';
    });
    return;
  }
  
  const lowerSearchTerm = searchTerm.toLowerCase();
  
  // L·ªçc c√°c item theo term t√¨m ki·∫øm
  document.querySelectorAll('.gantt-item').forEach(item => {
    const itemText = item.querySelector('.gantt-item-label').textContent.toLowerCase();
    const matches = itemText.includes(lowerSearchTerm);
    
    item.style.display = matches ? 'flex' : 'none';
  });
}

// Th√™m v√†o h√†m setupEventListeners
function setupGanttEventListeners() {
  console.log('Setting up Gantt event listeners'); // Log ƒë·ªÉ debug
  
  // ƒêi·ªÅu h∆∞·ªõng th√°ng - g·ª° b·ªè event listener c≈© n·∫øu c√≥
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  
  if (prevMonthBtn) {
    prevMonthBtn.replaceWith(prevMonthBtn.cloneNode(true));
    document.getElementById('prev-month').addEventListener('click', () => navigateGanttMonth(-1));
  }
  
  if (nextMonthBtn) {
    nextMonthBtn.replaceWith(nextMonthBtn.cloneNode(true));
    document.getElementById('next-month').addEventListener('click', () => navigateGanttMonth(1));
  }
  
  // Toggle All Projects Button
  const toggleAllBtn = document.getElementById('toggle-all-projects');
  if (toggleAllBtn) {
    toggleAllBtn.replaceWith(toggleAllBtn.cloneNode(true));
    document.getElementById('toggle-all-projects').addEventListener('click', toggleAllGanttProjects);
  }
  
  // T√¨m ki·∫øm - th√™m x·ª≠ l√Ω cho icon button v·ªõi cleanup
  const searchBtn = document.getElementById('gantt-search-btn');
  const searchInput = document.getElementById('gantt-search');
  if (searchBtn && searchInput) {
    console.log('Setting up search button listener'); // Debug log
    // Cleanup old event listeners by replacing elements
    const newSearchBtn = searchBtn.cloneNode(true);
    searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn);
    
    // Add new event listener
    newSearchBtn.addEventListener('click', (e) => {
      console.log('Search button clicked'); // Debug log
      e.preventDefault();
      e.stopPropagation();
      searchInput.classList.toggle('hidden');
      console.log('Search input hidden class:', searchInput.classList.contains('hidden')); // Debug log
      if (!searchInput.classList.contains('hidden')) {
        setTimeout(() => searchInput.focus(), 100);
      }
    });
    
    // Setup search input listener
    searchInput.removeEventListener('input', handleGanttSearch);
    searchInput.addEventListener('input', handleGanttSearch);
  } else {
    console.log('Search elements not found:', { searchBtn, searchInput }); // Debug log
  }
}

// Th√™m h√†m m·ªõi n√†y ƒë·ªÉ x·ª≠ l√Ω s·ª± ki·ªán t√¨m ki·∫øm
function handleGanttSearch(e) {
  searchGantt(e.target.value);
}

function toggleAllGanttProjects() {
  const toggleAllBtn = document.getElementById('toggle-all-projects');
  const projectItems = document.querySelectorAll('.gantt-project-item');
  const taskItems = document.querySelectorAll('.gantt-task-item');
  
  if (!toggleAllBtn || !projectItems.length) return;
  
  const isCurrentlyExpanded = !toggleAllBtn.classList.contains('collapsed');
  
  // Toggle button state and icon
  if (isCurrentlyExpanded) {
    // Collapse all
    toggleAllBtn.classList.add('collapsed');
    toggleAllBtn.title = 'X·ªï t·∫•t c·∫£ d·ª± √°n';
    
    // Hide all task items
    taskItems.forEach(taskItem => {
      taskItem.style.display = 'none';
    });
    
    // Update individual project toggle buttons to collapsed state
    projectItems.forEach(projectItem => {
      const toggleBtn = projectItem.querySelector('.gantt-toggle');
      if (toggleBtn) {
        toggleBtn.classList.add('collapsed');
      }
    });
  } else {
    // Expand all
    toggleAllBtn.classList.remove('collapsed');
    toggleAllBtn.title = 'Thu g·ªçn t·∫•t c·∫£ d·ª± √°n';
    
    // Show all task items
    taskItems.forEach(taskItem => {
      taskItem.style.display = 'flex';
    });
    
    // Update individual project toggle buttons to expanded state
    projectItems.forEach(projectItem => {
      const toggleBtn = projectItem.querySelector('.gantt-toggle');
      if (toggleBtn) {
        toggleBtn.classList.remove('collapsed');
      }
    });
  }
}

function formatDateForGantt(dateInput) {
    if (!dateInput) return '';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return '';
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        
        return `${day}/${month}`;
    } catch (e) {
        return '';
    }
}

function getStatusIcon(status) {
    const statusLower = (status || '').toLowerCase();
    if (statusLower.includes('ho√†n th√†nh')) return 'text-green-500';
    if (statusLower.includes('ƒëang')) return 'text-blue-500'; 
    return 'text-gray-400'; // Ch∆∞a b·∫Øt ƒë·∫ßu
}

// Th√™m h√†m m·ªõi sau c√°c h√†m utility
function formatTaskLinks(linksText) {
  if (!linksText) return '';
  
  // T√°ch c√°c link theo d√≤ng m·ªõi
  const links = linksText.split('\n').filter(link => link.trim() !== '');
  
  if (links.length === 0) return '';
  
  // T·∫°o HTML cho c√°c link
  return links.map(link => {
    const url = link.trim();
    if (!url) return '';
    
    // X√°c ƒë·ªãnh domain c·ªßa link
    let domain = '';
    
    try {
      const urlObj = new URL(url);
      domain = urlObj.hostname;
    } catch (e) {
      domain = 'Invalid URL';
    }
    
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" 
               class="result-link" title="${url}">
              ${domain || 'Link'}
            </a>`;
  }).join('');
}

// === SMART SYNC SYSTEM ===

// Initialize sync system
function initializeSyncSystem() {
  if (!isAuthenticated) return;
  
  console.log('üîÑ Initializing Smart Sync System');
  
  // Start periodic sync intervals
  startSyncIntervals();
  
  // Setup visibility change handler
  document.addEventListener('visibilitychange', handleVisibilityChange);
  
  // Set initial sync time
  lastSyncTime = new Date();
  updateSyncIndicator();
  
  // Update sync indicator every minute
  setInterval(updateSyncIndicator, 60000);
}

// Start sync intervals
function startSyncIntervals() {
  // Clear existing intervals
  stopSyncIntervals();
  
  // Notification sync (more frequent)
  syncIntervals.notifications = setInterval(() => {
    if (!userIsInteracting && isAuthenticated) {
      performNotificationSync();
    }
  }, SYNC_CONFIG.NOTIFICATION_INTERVAL);
  
  // Data sync (less frequent)
  syncIntervals.data = setInterval(() => {
    if (!userIsInteracting && isAuthenticated) {
      performDataSync();
    }
  }, SYNC_CONFIG.DATA_INTERVAL);
  
  console.log('üîÑ Sync intervals started');
}

// Stop sync intervals
function stopSyncIntervals() {
  if (syncIntervals.notifications) {
    clearInterval(syncIntervals.notifications);
    syncIntervals.notifications = null;
  }
  
  if (syncIntervals.data) {
    clearInterval(syncIntervals.data);
    syncIntervals.data = null;
  }
  
  console.log('üîÑ Sync intervals stopped');
}

// Setup user interaction detection
function setupUserInteractionDetection() {
  const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
  
  events.forEach(event => {
    document.addEventListener(event, () => {
      userIsInteracting = true;
      
      // Clear previous timeout
      if (interactionTimeout) {
        clearTimeout(interactionTimeout);
      }
      
      // Set timeout to mark user as not interacting
      interactionTimeout = setTimeout(() => {
        userIsInteracting = false;
      }, SYNC_CONFIG.USER_INTERACTION_DELAY);
    });
  });
}

// Handle visibility change (when user switches tabs)
function handleVisibilityChange() {
  if (!document.hidden && isAuthenticated) {
    // User came back to tab, perform immediate sync
    console.log('üîÑ User returned, performing immediate sync');
    performImmediateSync();
  }
}

// Manual sync triggered by user
function handleManualSync() {
  if (isSyncing) return;
  
  console.log('üîÑ Manual sync triggered');
  performImmediateSync(true); // Pass true for manual sync
}

// Perform immediate sync
async function performImmediateSync(isManual = false) {
  if (isSyncing) return;
  
  setSyncingState(true, isManual);
  
  try {
    await Promise.all([
      performNotificationSync(),
      performDataSync()
    ]);
    
    // Removed success toast - too distracting
    // showSyncToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô', 'success');
  } catch (error) {
    console.error('Sync error:', error);
    showSyncToast('L·ªói khi ƒë·ªìng b·ªô d·ªØ li·ªáu', 'error');
  } finally {
    setSyncingState(false, isManual);
  }
}

// Perform notification sync
async function performNotificationSync() {
  try {
    console.log('üîî Syncing notifications...');
    
    const response = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getNotifications();
    });
    
    if (response && response.length !== undefined) {
      const currentCount = allNotifications ? allNotifications.length : 0;
      const newCount = response.length;
      
      // Removed notification toast - too distracting
      // if (newCount > currentCount) {
      //   const newNotifications = newCount - currentCount;
      //   showSyncToast(`${newNotifications} th√¥ng b√°o m·ªõi`, 'info');
      // }
      
      // Update global notifications data
      allNotifications = response;
      
      // Only re-render if user is not viewing notifications
      if (currentSection !== 'notifications' && !isNotificationPanelOpen()) {
        renderNotifications(response);
      }
      
      updateNotificationBadge();
    }
  } catch (error) {
    console.error('Notification sync error:', error);
  }
}

// Perform data sync
async function performDataSync() {
  try {
    console.log('üìä Syncing data...');
    
    const response = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getInitialData();
    });
    
    if (response && !response.error) {
      // Compare and update data
      const hasChanges = compareAndUpdateData(response);
      
      if (hasChanges) {
        // Update UI elements that don't disrupt user
        updateBackgroundElements();
      }
      
      lastSyncTime = new Date();
      updateSyncIndicator();
    }
  } catch (error) {
    console.error('Data sync error:', error);
  }
}

// Compare and update data
function compareAndUpdateData(newData) {
  let hasChanges = false;
  
  // Compare projects
  if (JSON.stringify(allProjects) !== JSON.stringify(newData.projects || [])) {
    allProjects = newData.projects || [];
    hasChanges = true;
  }
  
  // Compare tasks
  if (JSON.stringify(allTasks) !== JSON.stringify(newData.tasks || [])) {
    allTasks = newData.tasks || [];
    hasChanges = true;
  }
  
  // Compare staff
  if (JSON.stringify(allStaff) !== JSON.stringify(newData.staff || [])) {
    allStaff = newData.staff || [];
    hasChanges = true;
  }
  
  return hasChanges;
}

// Update background elements that don't disrupt user
function updateBackgroundElements() {
  // Always safe to update these
  const statsData = calculateStats();
  renderStats(statsData);
  
  // Update charts (they animate smoothly)
  renderChart();
  renderProjectProgressChart();
  renderStaffPerformanceChart();
  
  // Update sections only if user is not viewing them (for background sync)
  if (currentSection !== 'projects') {
    renderProjects();
  }
  
  if (currentSection !== 'tasks') {
    renderTasks();
  }
  
  if (currentSection !== 'staff') {
    renderStaff();
  }
  
  if (currentSection !== 'gantt') {
    // Gantt chart can be updated as it doesn't disrupt scrolling
    renderGanttChart();
  }
  
  // Always safe to update these background elements
  renderProjectTaskTree();
  renderPriorityTasks();
  populateDropdowns();
}

// Set syncing state
function setSyncingState(syncing, isManual = false) {
  isSyncing = syncing;
  const syncBtn = document.getElementById('sync-btn');
  const syncIcon = document.getElementById('sync-icon');
  
  if (syncBtn) {
    if (syncing) {
      if (isManual) {
        // Manual sync - show spinning animation
        syncBtn.classList.add('syncing');
        syncBtn.title = 'ƒêang ƒë·ªìng b·ªô...';
      } else {
        // Auto sync - just change color to gray (subtle)
        syncIcon.style.color = '#9CA3AF'; // gray-400
        syncBtn.title = 'ƒêang ƒë·ªìng b·ªô ng·∫ßm...';
      }
    } else {
      // Reset to normal state
      syncBtn.classList.remove('syncing');
      syncIcon.style.color = ''; // Reset to default color
      syncBtn.title = 'ƒê·ªìng b·ªô d·ªØ li·ªáu';
    }
  }
}

// Update sync indicator
function updateSyncIndicator() {
  const syncBtn = document.getElementById('sync-btn');
  
  if (syncBtn && lastSyncTime) {
    const now = new Date();
    const diffMinutes = Math.floor((now - lastSyncTime) / 60000);
    
    // Update tooltip with last sync time
    const timeText = diffMinutes < 1 ? 'v·ª´a xong' : `${diffMinutes} ph√∫t tr∆∞·ªõc`;
    syncBtn.title = `ƒê·ªìng b·ªô l·∫ßn cu·ªëi: ${timeText}`;
  }
}

// Check if notification panel is open
function isNotificationPanelOpen() {
  // This depends on your notification panel implementation
  // For Alpine.js, you might check the x-data state
  return false; // Placeholder - implement based on your notification panel
}

// Show sync toast notification
function showSyncToast(message, type = 'info') {
  // Remove any existing sync toast
  const existingToast = document.querySelector('.sync-toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = `sync-toast ${type}`;
  
  const iconClass = type === 'success' ? 'fas fa-check-circle text-green-500' :
                   type === 'error' ? 'fas fa-exclamation-circle text-red-500' :
                   'fas fa-info-circle text-blue-500';
  
  toast.innerHTML = `
    <i class="${iconClass}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  // Trigger animation
  setTimeout(() => toast.classList.add('show'), 100);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Start sync system when user logs in
function startSyncSystemForUser() {
  if (isAuthenticated) {
    initializeSyncSystem();
  }
}

// Stop sync system when user logs out
function stopSyncSystemForUser() {
  stopSyncIntervals();
  document.removeEventListener('visibilitychange', handleVisibilityChange);
  console.log('üîÑ Sync system stopped');
}

// Calculate stats (helper function)
function calculateStats() {
  // Implement your stats calculation logic here
  // This should return the same format as your current stats
  return {
    totalProjects: allProjects.length,
    completedProjects: allProjects.filter(p => (p[COL.P_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length,
    totalTasks: allTasks.length,
    completedTasks: allTasks.filter(t => (t[COL.T_STATUS] || '').toLowerCase().includes('ho√†n th√†nh')).length,
    // Add other stats as needed
  };
}

// === KANBAN VIEW MANAGEMENT ===
let currentTaskView = 'kanban'; // Default to 'kanban' instead of 'list'
let currentProjectView = 'kanban'; // Default to 'kanban' for projects
let sortableInstances = []; // Store Sortable instances
let projectSortableInstances = []; // Store Project Sortable instances

function toggleTaskView(view) {
  if (currentTaskView === view) return;
  
  currentTaskView = view;
  
  // Update toggle buttons
  document.querySelectorAll('.view-toggle .btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === view) {
      btn.classList.add('active');
    }
  });
  
  // Show/hide views
  const listView = document.getElementById('tasks-list-view');
  const kanbanView = document.getElementById('tasks-kanban-view');
  
  if (view === 'list') {
    listView.classList.remove('hidden-view');
    kanbanView.classList.add('hidden-view');
    destroySortableInstances();
    // Force render list view with current data
    renderTasksList();
  } else {
    listView.classList.add('hidden-view');
    kanbanView.classList.remove('hidden-view');
    renderTasksKanban();
  }
}

function toggleProjectView(view) {
  if (currentProjectView === view) return;
  
  currentProjectView = view;
  
  // Update toggle buttons
  document.querySelectorAll('#projects-section .view-toggle .btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === view) {
      btn.classList.add('active');
    }
  });
  
  // Show/hide views
  const listView = document.getElementById('projects-list-view');
  const kanbanView = document.getElementById('projects-kanban-view');
  
  if (view === 'list') {
    listView.classList.remove('hidden-view');
    kanbanView.classList.add('hidden-view');
    destroyProjectSortableInstances();
    // Force render list view with current data
    renderProjectsList();
  } else {
    listView.classList.add('hidden-view');
    kanbanView.classList.remove('hidden-view');
    renderProjectsKanban();
  }
}

function renderTasksKanban() {
  const kanbanBoard = document.querySelector('#tasks-kanban-view .kanban-board');
  if (!kanbanBoard) return;
  
  // Get user tasks (same logic as list view)
  let userTasks = [];
  
  if (isAdmin()) {
    userTasks = allTasks;
  } else {
    const userProjects = getUserAllowedProjects();
    const userProjectIds = userProjects.map(p => p[COL.P_ID]);
    
    userTasks = allTasks.filter(task => {
      if (task[COL.T_ASSIGNEE] === currentUser.name) {
        return true;
      }
      
      const projectId = task[COL.T_PID];
      const project = allProjects.find(p => p[COL.P_ID] === projectId);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      
      return false;
    });
  }
  
  // Group tasks by status
  const tasksByStatus = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': [],
    'ƒêang th·ª±c hi·ªán': [],
    'Ho√†n th√†nh': []
  };
  
  userTasks.forEach(task => {
    const status = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    if (tasksByStatus[status]) {
      tasksByStatus[status].push(task);
    }
  });
  
  // Render kanban columns
  let kanbanHTML = '';
  Object.keys(tasksByStatus).forEach(status => {
    const tasks = tasksByStatus[status];
    kanbanHTML += `
      <div class="kanban-column">
        <h3>${status} (${tasks.length})</h3>
        <div class="kanban-cards" data-status="${status}">
          ${tasks.length > 0 
            ? tasks.map(task => createKanbanTaskCard(task)).join('')
            : '<div class="kanban-empty">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o</div>'
          }
        </div>
      </div>
    `;
  });
  
  kanbanBoard.innerHTML = kanbanHTML;
  
  // Initialize drag & drop
  initializeSortable();
}

function createKanbanTaskCard(task) {
  const taskId = task[COL.T_ID];
  const taskName = task[COL.T_NAME] || 'Kh√¥ng t√™n';
  const taskDesc = task[COL.T_DESC] || '';
  const assignee = task[COL.T_ASSIGNEE] || 'Ch∆∞a g√°n';
  const priority = task[COL.T_PRIORITY] || 'Th∆∞·ªùng';
  const dueDate = formatDateForDisplay(task[COL.T_DUE]);
  const completion = task[COL.T_COMPLETION] || 0;
  
  // Get project info
  const project = allProjects.find(p => p[COL.P_ID] === task[COL.T_PID]);
  const projectName = project ? project[COL.P_NAME] : 'N/A';
  
  // Priority colors
  const priorityColors = {
    'Cao': 'bg-red-100 text-red-700',
    'Th∆∞·ªùng': 'bg-blue-100 text-blue-700',
    'Th·∫•p': 'bg-gray-100 text-gray-700'
  };
  
  return `
    <div class="kanban-card" data-id="${taskId}" data-type="task">
      <div class="flex justify-between items-start mb-2">
        <h4 class="font-medium text-gray-900 flex-1">${taskName}</h4>
        <span class="text-xs px-2 py-1 rounded-full ${priorityColors[priority] || priorityColors['Th∆∞·ªùng']}">
          ${priority}
        </span>
      </div>
      
      ${taskDesc ? `<p class="text-sm text-gray-600 mb-3">${taskDesc}</p>` : ''}
      
      <div class="text-xs text-gray-500 mb-3">
        <div class="flex items-center justify-between">
          <span class="font-medium">${projectName}</span>
          ${dueDate ? `<span>${dueDate}</span>` : ''}
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <span class="text-xs text-gray-600">${assignee}</span>
        <div class="flex items-center">
          <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
            <div class="bg-blue-500 h-2 rounded-full" style="width: ${completion}%"></div>
          </div>
          <span class="text-xs text-gray-500">${completion}%</span>
        </div>
      </div>
    </div>
  `;
}

function initializeSortable() {
  // Destroy existing instances
  destroySortableInstances();
  
  // Initialize new instances
  document.querySelectorAll('.kanban-cards').forEach(column => {
    const sortable = new Sortable(column, {
      group: 'kanban-tasks',
      animation: 150,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',
      onEnd: handleTaskDragEnd,
      onStart: function(evt) {
        console.log('Drag started:', evt.item.dataset.id);
      }
    });
    
    sortableInstances.push(sortable);
  });
}

function destroySortableInstances() {
  sortableInstances.forEach(instance => {
    if (instance && instance.destroy) {
      instance.destroy();
    }
  });
  sortableInstances = [];
}

function destroyAllSortableInstances() {
  // Destroy task sortable instances
  destroySortableInstances();
  
  // Destroy project sortable instances
  destroyProjectSortableInstances();
}

function handleTaskDragEnd(evt) {
  const taskId = evt.item.dataset.id;
  const newStatus = evt.to.dataset.status;
  const oldStatus = evt.from.dataset.status;
  
  if (newStatus === oldStatus) {
    console.log('Task moved within same column');
    return;
  }
  
  console.log(`Task ${taskId} moved from ${oldStatus} to ${newStatus}`);
  
  // Update task status optimistically
  const task = allTasks.find(t => t[COL.T_ID] === taskId);
  if (task) {
    const oldTaskStatus = task[COL.T_STATUS];
    task[COL.T_STATUS] = newStatus;
    
    // Update progress for completed tasks
    if (newStatus === 'Ho√†n th√†nh') {
      task[COL.T_COMPLETION] = 100;
    }
    
    // Update column headers
    updateKanbanHeaders();
    
    // Show loading state
    showToast('ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i...', 'info');
    
    // Prepare update data with required fields
    const updateData = {
      name: task[COL.T_NAME], // Required field
      status: newStatus,
      projectId: task[COL.T_PID],
      description: task[COL.T_DESC] || '',
      assignee: task[COL.T_ASSIGNEE] || '',
      priority: task[COL.T_PRIORITY] || 'Th∆∞·ªùng',
      startDate: task[COL.T_START] || '',
      dueDate: task[COL.T_DUE] || '',
      completion: newStatus === 'Ho√†n th√†nh' ? 100 : (task[COL.T_COMPLETION] || 0)
    };
    
    // Sync to backend
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          showToast('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!', 'success');
          // Refresh data to ensure consistency
          refreshData();
        } else {
          // Revert changes on error
          task[COL.T_STATUS] = oldTaskStatus;
          showToast(response.error || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t', 'error');
          renderTasksKanban(); // Re-render to show reverted state
        }
      })
      .withFailureHandler(function(error) {
        // Revert changes on error
        task[COL.T_STATUS] = oldTaskStatus;
        showToast('L·ªói: ' + error.message, 'error');
        renderTasksKanban(); // Re-render to show reverted state
      })
      .updateTaskWithAuth(taskId, updateData);
  }
}

function updateKanbanHeaders() {
  const tasksByStatus = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': [],
    'ƒêang th·ª±c hi·ªán': [],
    'Ho√†n th√†nh': []
  };
  
  // Count tasks by status
  allTasks.forEach(task => {
    const status = task[COL.T_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    if (tasksByStatus[status]) {
      tasksByStatus[status].push(task);
    }
  });
  
  // Update headers
  Object.keys(tasksByStatus).forEach(status => {
    const header = document.querySelector(`[data-status="${status}"]`)?.parentElement.querySelector('h3');
    if (header) {
      header.textContent = `${status} (${tasksByStatus[status].length})`;
    }
  });
}

// === PROJECTS KANBAN FUNCTIONS ===
function renderProjectsKanban() {
  const kanbanBoard = document.querySelector('#projects-kanban-view .kanban-board');
  if (!kanbanBoard) return;
  
  // Get user projects (same logic as list view)
  const userProjects = getUserAllowedProjects();
  
  if (!userProjects || userProjects.length === 0) {
    kanbanBoard.innerHTML = `
      <div class="col-span-full text-center py-12 text-gray-500">
        <p>Ch∆∞a c√≥ d·ª± √°n n√†o</p>
      </div>
    `;
    return;
  }
  
  // Define project status columns
  const statusColumns = [
    { key: 'Ch∆∞a b·∫Øt ƒë·∫ßu', label: 'Ch∆∞a b·∫Øt ƒë·∫ßu', color: 'bg-gray-50' },
    { key: 'ƒêang th·ª±c hi·ªán', label: 'ƒêang th·ª±c hi·ªán', color: 'bg-blue-50' },
    { key: 'Ho√†n th√†nh', label: 'Ho√†n th√†nh', color: 'bg-green-50' }
  ];
  
  // Group projects by status
  const projectsByStatus = {};
  statusColumns.forEach(col => {
    projectsByStatus[col.key] = userProjects.filter(project => 
      (project[COL.P_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu') === col.key
    );
  });
  
  // Generate Kanban columns
  const columnsHtml = statusColumns.map(column => {
    const projects = projectsByStatus[column.key] || [];
    
    return `
      <div class="kanban-column ${column.color}" data-status="${column.key}">
        <h3 class="kanban-header">
          ${column.label} <span class="kanban-count">(${projects.length})</span>
        </h3>
        <div class="kanban-list" data-status="${column.key}">
          ${projects.length > 0 
            ? projects.map(project => createKanbanProjectCard(project)).join('')
            : '<div class="kanban-empty-state">Ch∆∞a c√≥ d·ª± √°n n√†o</div>'
          }
        </div>
      </div>
    `;
  }).join('');
  
  kanbanBoard.innerHTML = columnsHtml;
  
  // Initialize drag and drop
  initializeProjectSortable();
}

function createKanbanProjectCard(project) {
  const projectId = project[COL.P_ID] || 'N/A';
  const projectName = project[COL.P_NAME] || 'Ch∆∞a c√≥ t√™n';
  const projectDesc = project[COL.P_DESC] || '';
  const projectManager = project[COL.P_MANAGER] || 'Ch∆∞a g√°n';
  const startDate = formatDateForDisplay(project[COL.P_START]);
  const endDate = formatDateForDisplay(project[COL.P_END]);
  
  const publicBadge = isPublicProject(project) ? `<span class="kanban-badge bg-blue-100 text-blue-800">Chung</span>` : '';
  
  return `
    <div class="kanban-card clickable-project-card cursor-pointer" data-id="${projectId}">
      <div class="kanban-card-header">
        <h4 class="kanban-card-title">${projectName}</h4>
        <div class="kanban-card-actions">
          <button class="kanban-action-btn edit-btn" data-type="project" data-id="${projectId}" title="Ch·ªânh s·ª≠a">
            S·ª≠a
          </button>
          <button class="kanban-action-btn delete-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="X√≥a">
            X√≥a
          </button>
        </div>
      </div>
      
      ${projectDesc ? `<p class="kanban-card-desc">${projectDesc}</p>` : ''}
      
      <div class="kanban-card-meta">
        <div class="kanban-card-info">
          <span class="kanban-meta-item">${projectManager}</span>
          ${startDate ? `<span class="kanban-meta-item">${startDate}</span>` : ''}
        </div>
        ${publicBadge}
      </div>
      </div>
    </div>
  `;
}

function initializeProjectSortable() {
  // Destroy existing instances
  destroyProjectSortableInstances();
  
  // Initialize Sortable for each column
  const columns = document.querySelectorAll('#projects-kanban-view .kanban-list');
  columns.forEach(column => {
    const sortable = new Sortable(column, {
      group: 'projects-kanban',
      animation: 150,
      chosenClass: 'kanban-card-chosen',
      dragClass: 'kanban-card-drag',
      ghostClass: 'kanban-card-ghost',
      onEnd: handleProjectDragEnd,
      // Enable touch support
      forceFallback: false,
      fallbackTolerance: 0,
      touchStartThreshold: 5,
      delayOnTouchStart: true,
      delay: 100
    });
    
    projectSortableInstances.push(sortable);
  });
}

function destroyProjectSortableInstances() {
  projectSortableInstances.forEach(instance => {
    if (instance && typeof instance.destroy === 'function') {
      instance.destroy();
    }
  });
  projectSortableInstances = [];
}

function handleProjectDragEnd(evt) {
  const projectId = evt.item.dataset.id;
  const newStatus = evt.to.dataset.status;
  const oldStatus = evt.from.dataset.status;
  
  if (newStatus === oldStatus) {
    console.log('Project moved within same column');
    return;
  }
  
  console.log(`Project ${projectId} moved from ${oldStatus} to ${newStatus}`);
  
  // Update project status optimistically
  const project = allProjects.find(p => p[COL.P_ID] === projectId);
  if (project) {
    const oldProjectStatus = project[COL.P_STATUS];
    project[COL.P_STATUS] = newStatus;
    
    // Update column headers
    updateProjectKanbanHeaders();
    
    // Show loading state
    showToast('ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i...', 'info');
    
    // Prepare update data with required fields
    const updateData = {
      name: project[COL.P_NAME], // Required field
      description: project[COL.P_DESC] || '',
      manager: project[COL.P_MANAGER] || '',
      status: newStatus,
      startDate: project[COL.P_START] || '',
      endDate: project[COL.P_END] || '',
      isPublic: project[COL.P_IS_PUBLIC] || false
    };
    
    // Sync to backend
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          showToast('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!', 'success');
          // Refresh data to ensure consistency
          refreshData();
        } else {
          // Revert changes on error
          project[COL.P_STATUS] = oldProjectStatus;
          showToast(response.error || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t', 'error');
          renderProjectsKanban(); // Re-render to show reverted state
        }
      })
      .withFailureHandler(function(error) {
        // Revert changes on error
        project[COL.P_STATUS] = oldProjectStatus;
        showToast('L·ªói: ' + error.message, 'error');
        renderProjectsKanban(); // Re-render to show reverted state
      })
      .updateProjectWithAuth(projectId, updateData);
  }
}

function updateProjectKanbanHeaders() {
  const userProjects = getUserAllowedProjects();
  const projectsByStatus = {
    'Ch∆∞a b·∫Øt ƒë·∫ßu': [],
    'ƒêang th·ª±c hi·ªán': [],
    'Ho√†n th√†nh': []
  };
  
  // Count projects by status
  userProjects.forEach(project => {
    const status = project[COL.P_STATUS] || 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    if (projectsByStatus[status]) {
      projectsByStatus[status].push(project);
    }
  });
  
  // Update headers
  Object.keys(projectsByStatus).forEach(status => {
    const header = document.querySelector(`#projects-kanban-view [data-status="${status}"]`)?.parentElement.querySelector('h3');
    if (header) {
      header.textContent = `${status} (${projectsByStatus[status].length})`;
    }
  });
}

</script>