<!-- js.html -->
<script>
// === Global Variables ===
let chartInstance = null;
let projectProgressChart = null;
let staffPerformanceChart = null;
let allProjects = [];
let allTasks = [];
let allStaff = [];
let allNotifications = [];
let currentSection = 'overview';
let currentUser = null; // Store current logged in user
let isAuthenticated = false;

// === Sync System Variables ===
let syncIntervals = {
    notifications: null,
    data: null
};
let lastSyncTime = null;
let isSyncing = false;
let userIsInteracting = false;
let interactionTimeout = null;

// === Sync Configuration ===
const SYNC_CONFIG = {
    NOTIFICATION_INTERVAL: 30000,  // 30 seconds
    DATA_INTERVAL: 60000,         // 1 minute  
    USER_INTERACTION_DELAY: 5000, // 5 seconds after user stops interacting
    SYNC_RETRY_DELAY: 10000       // 10 seconds retry delay
};

// === Gantt Chart Variables ===
let currentGanttDate = new Date();
let expandedProjects = new Set(); // Lưu ID của các dự án đang xổ

// === Constants matching backend ===
const COL = {
    P_ID: "Mã dự án", P_NAME: "Tên dự án", P_DESC: "Mô tả dự án",
    P_MANAGER: "Quản lý dự án", P_START: "Ngày bắt đầu", P_END: "Ngày kết thúc",
    P_STATUS: "Trạng thái dự án",
    T_ID: "Mã nhiệm vụ", T_PID: "Mã dự án", T_NAME: "Tên nhiệm vụ",
    T_DESC: "Mô tả nhiệm vụ", T_ASSIGNEE: "Người thực hiện", T_STATUS: "Trạng thái",
    T_PRIORITY: "Ưu tiên", T_START: "Ngày bắt đầu", T_DUE: "Hạn chót",
    T_COMPLETION: "Tiến độ (%)", T_REPORT_DATE: "Ngày báo cáo", T_TARGET: "Mục tiêu", T_RESULT_LINKS: "Link kết quả", T_OUTPUT: "Kết quả đầu ra", T_NOTES: "Ghi chú",
    S_ID: "Mã NV", S_NAME: "Họ tên", S_EMAIL: "Email", S_POS: "Chức vụ",
    S_ROLE: "Phân quyền", S_PASSWORD: "Mật khẩu",
    A_TIME: "Thời gian", A_ACTION: "Hành động", A_USER: "Người thực hiện", A_DETAILS: "Chi tiết",
    N_ID: "Mã thông báo", N_TIME: "Thời gian", N_USER: "Người nhận", N_CONTENT: "Nội dung"  // ← THÊM N_USER
};

// === Initialization ===
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    checkAuthenticationAndInitialize();
});

function initializeApp() {
    // showLoading('Đang tải dữ liệu...');
    
    google.script.run
        .withSuccessHandler(function(data) {
            // hideLoading();
            if (data.error) {
                showToast(data.error, 'error');
                return;
            }
            
            // Store data globally
            allProjects = data.projects || [];
            allTasks = data.tasks || [];
            allStaff = data.staff || [];
            
            // Render all sections
            renderStats(data.summaryStats);
            renderProjectTaskTree();
            renderPriorityTasks();
            renderProjects();
            renderTasks();
            renderStaff();
            renderChart(data.chartData);
            renderProjectProgressChart();
            renderStaffPerformanceChart();
            renderActivity(data.recentActivities);
            renderNotifications(data.notifications);
            
            // Populate dropdowns
            populateDropdowns();
            
            showToast('Dữ liệu đã được tải thành công!', 'success');
        })
        .withFailureHandler(function(error) {
            // hideLoading();
            showToast('Lỗi khi tải dữ liệu: ' + error.message, 'error');
        })
        .getInitialData();
}

function checkAuthenticationAndInitialize() {
    // Hide sidebar by default until user logs in
    document.body.classList.add('sidebar-collapsed');
    const toggleBtn = document.getElementById('sidebar-toggle');
    if (toggleBtn) {
        const icon = toggleBtn.querySelector('i');
        if (icon) icon.className = 'fas fa-bars text-gray-600';
    }
    
    showLoading('Đang kiểm tra đăng nhập...');
    
    google.script.run
        .withSuccessHandler(function(response) {
            hideLoading();
            
            if (response.requireLogin) {
                // User not logged in, show login modal
                showLoginModal();
            } else if (response.success) {
                // User is logged in, initialize app
                handleSuccessfulLogin(response);
            } else {
                // Error occurred
                showToast(response.error || 'Lỗi khi kiểm tra đăng nhập', 'error');
                showLoginModal();
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            showToast('Lỗi kết nối: ' + error.message, 'error');
            showLoginModal();
        })
        .getInitialDataWithAuth();
}

function showLoginModal() {
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.classList.remove('opacity-0', 'invisible');
        loginModal.querySelector('.bg-white\\/90').classList.remove('scale-95');
        loginModal.querySelector('.bg-white\\/90').classList.add('scale-100');
        
        // Focus on email input
        setTimeout(() => {
            document.getElementById('login-email')?.focus();
        }, 300);
    }
}

function hideLoginModal() {
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.querySelector('.bg-white\\/90').classList.remove('scale-100');
        loginModal.querySelector('.bg-white\\/90').classList.add('scale-95');
        
        setTimeout(() => {
            loginModal.classList.add('opacity-0', 'invisible');
        }, 200);
    }
}

function handleLogin(email, password) {
    if (!email || !password) {
        showLoginError('Vui lòng nhập đầy đủ email và mật khẩu');
        return;
    }

    setLoginLoading(true);
    
    google.script.run
        .withSuccessHandler(function(response) {
            setLoginLoading(false);
            
            if (response.success) {
                hideLoginModal();
                hideLoginError();
                
                // Get user data and initialize
                google.script.run
                    .withSuccessHandler(function(dataResponse) {
                        if (dataResponse.success) {
                            handleSuccessfulLogin(dataResponse);
                            showToast('Đăng nhập thành công!', 'success');
                        } else {
                            showToast(dataResponse.error || 'Lỗi khi tải dữ liệu', 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        showToast('Lỗi khi tải dữ liệu: ' + error.message, 'error');
                    })
                    .getDataForUser();
                    
            } else {
                showLoginError(response.error || 'Đăng nhập thất bại');
            }
        })
        .withFailureHandler(function(error) {
            setLoginLoading(false);
            showLoginError('Lỗi kết nối: ' + error.message);
        })
        .authenticateUser(email, password);
}

function handleSuccessfulLogin(dataResponse) {
    currentUser = dataResponse.user;
    isAuthenticated = true;
    
    // Store data globally
    allProjects = dataResponse.projects || [];
    allTasks = dataResponse.tasks || [];
    allStaff = dataResponse.staff || [];
    
    // Update UI based on user role
    updateUIForUser(currentUser);
    
    // Render all sections
    renderStats(dataResponse.summaryStats);
    renderProjectTaskTree();
    renderPriorityTasks();
    renderProjects();
    renderTasks();
    renderStaff();
    renderChart(dataResponse.chartData);
    renderProjectProgressChart();
    renderStaffPerformanceChart();
    renderActivity(dataResponse.recentActivities);
    renderNotifications(dataResponse.notifications);
    
    // Populate dropdowns
    populateDropdowns();

    // Thêm thiết lập cho Gantt chart
    setupGanttEventListeners();
    if (currentSection === 'gantt') {
      renderGanttChart();
    }
    
    // Initialize Smart Sync System
    startSyncSystemForUser();
}

function updateUIForUser(user) {
  const isAdminUser = isAdmin();
  const isManagerUser = user.role && user.role.toLowerCase().includes('quản lý');
  
  // Show sidebar when user logs in successfully
  const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  if (!sidebarCollapsed) {
    document.body.classList.remove('sidebar-collapsed');
    const toggleBtn = document.getElementById('sidebar-toggle');
    if (toggleBtn) {
      const icon = toggleBtn.querySelector('i');
      if (icon) icon.className = 'fas fa-times text-gray-600';
    }
  }
  
  // Update user info in sidebar
  document.getElementById('user-info').classList.remove('hidden');
  document.getElementById('login-prompt').classList.add('hidden');
  
  const userName = document.getElementById('user-name');
  const userRole = document.getElementById('user-role');
  
  if (userName && userRole) {
    userName.textContent = user.name;
    userRole.textContent = user.role;
  }
  
  // THAY ĐỔI: Kiểm tra xem nhân viên có phải là người phụ trách dự án nào không
  const isProjectManager = allProjects.some(project => project[COL.P_MANAGER] === user.name);
  
  // Hide/show navigation items based on role
  const projectsNav = document.getElementById('projects-nav');
  const staffNav = document.getElementById('staff-nav');
  
  if (isAdminUser) {
    // Show all nav items for admin
    if (projectsNav) projectsNav.style.display = 'flex';
    if (staffNav) staffNav.style.display = 'flex';
    showAdminButtons();
  } 
  else if (isManagerUser) {
    // Show projects nav for managers, hide staff nav
    if (projectsNav) projectsNav.style.display = 'flex';
    if (staffNav) staffNav.style.display = 'none';
    hideAdminButtons();
  } 
  else {
    // THAY ĐỔI: Hiển thị tab Dự án cho nhân viên phụ trách dự án
    if (projectsNav) {
      projectsNav.style.display = isProjectManager ? 'flex' : 'none';
    }
    if (staffNav) staffNav.style.display = 'none';
    hideAdminButtons();
  }

  // Hiển thị button thêm thông báo cho admin
  const addNotificationBtn = document.getElementById('add-notification-btn');
  if (isAdminUser) {
    if (addNotificationBtn) addNotificationBtn.classList.remove('hidden');
  } else {
    if (addNotificationBtn) addNotificationBtn.classList.add('hidden');
  }
  
  // Update page title to show current user
  updatePageTitle();
}

function hideAdminButtons() {
  // Hide admin-only buttons 
  const adminButtons = [
    'add-staff-btn',
    'quick-add-staff'
  ];
  
  adminButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.style.display = 'none';
    }
  });
  
  // THAY ĐỔI: Kiểm tra xem người dùng có phải là người phụ trách dự án nào không
  const isProjectManager = allProjects.some(project => project[COL.P_MANAGER] === currentUser.name);
  
  // Hiển thị/ẩn project buttons based on permissions
  const projectButtons = [
    'add-project-btn',
    'add-project-standalone',
    'quick-add-project'
  ];
  
  projectButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      if (isManager() || isProjectManager) {
        button.style.display = ''; // Hiển thị nếu là quản lý hoặc người phụ trách dự án
      } else {
        button.style.display = 'none'; // Ẩn nếu không phải
      }
    }
  });
  
  // Kiểm tra và ẩn/hiện task buttons based on permissions
  const taskButtons = [
    'add-task-btn',
    'add-task-standalone',
    'quick-add-task'
  ];
  
  taskButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      if (canUserCreateTask()) {
        button.style.display = ''; // Hiển thị
      } else {
        button.style.display = 'none'; // Ẩn
      }
    }
  });
  
  // Hide admin action buttons in cards
  document.addEventListener('DOMContentLoaded', function() {
    hideActionButtons();
  });
}

function showAdminButtons() {
  // Show admin-only buttons
  const adminButtons = [
    'add-project-btn',
    'add-project-standalone', 
    'add-task-btn',
    'add-task-standalone',
    'add-staff-btn',
    'quick-add-project',
    'quick-add-task',
    'quick-add-staff'
  ];
  
  adminButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.style.display = '';
    }
  });
}

function hideActionButtons() {
  const actionButtons = document.querySelectorAll('.edit-btn, .delete-btn');
  actionButtons.forEach(button => {
    const type = button.dataset.type;
    const id = button.dataset.id;
    
    if (isAdmin()) {
      // Admin có quyền đối với tất cả
      return;
    }
    
    if (isManager()) {
      // Quản lý có thể thao tác với project và task, nhưng không với staff
      if (type === 'staff') {
        button.style.display = 'none';
      }
    } 
    else if (type === 'project' || type === 'staff') {
      // Nhân viên thường không thể sửa/xóa dự án và nhân viên
      button.style.display = 'none';
    } 
    else if (type === 'task') {
      // Kiểm tra nếu task thuộc dự án mà người dùng quản lý
      const task = allTasks.find(t => t[COL.T_ID] === id);
      if (task) {
        const projectId = task[COL.T_PID];
        const project = allProjects.find(p => p[COL.P_ID] === projectId);
        
        // Hiển thị nút nếu người dùng là người quản lý dự án hoặc người được giao
        if (project && project[COL.P_MANAGER] === currentUser.name) {
          return; // Hiển thị nút
        }
        
        // Ẩn nút nếu người dùng không phải người được giao
        if (task[COL.T_ASSIGNEE] !== currentUser.name) {
          button.style.display = 'none';
        }
      }
    }
  });
}

function handleLogout() {
    if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
        // showLoading('Đang đăng xuất...');
        
        google.script.run
            .withSuccessHandler(function(response) {
                // hideLoading();
                
                // Reset application state
                currentUser = null;
                isAuthenticated = false;
                allProjects = [];
                allTasks = [];
                allStaff = [];
                
                // Stop sync system
                stopSyncSystemForUser();
                
                // Reset UI
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('login-prompt').classList.remove('hidden');
                
                // Clear all sections
                clearAllSections();
                
                // Show login modal
                showLoginModal();
                
                showToast('Đăng xuất thành công', 'success');
            })
            .withFailureHandler(function(error) {
                // hideLoading();
                showToast('Lỗi khi đăng xuất: ' + error.message, 'error');
            })
            .logout();
    }
}

function setLoginLoading(isLoading) {
    const submitBtn = document.getElementById('login-submit-btn');
    const btnText = document.getElementById('login-btn-text');
    
    if (isLoading) {
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        btnText.textContent = '';
    } else {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        btnText.textContent = 'Đăng nhập';
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('login-error');
    const errorMessage = document.getElementById('login-error-message');
    
    if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
    }
}

function clearAllSections() {
    // Clear all section content
    const sectionsToSelect = [
        '#projects-grid',
        '#tasks-grid', 
        '#staff-grid',
        '#project-task-tree',
        '#priority-tasks',
        '#recent-activity'
    ];
    
    sectionsToSelect.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.innerHTML = '<div class="loading-card">Vui lòng đăng nhập</div>';
        }
    });
    
    // Clear stats
    const statsElements = [
        'total-projects', 'completed-projects', 'project-completion-rate',
        'total-tasks', 'completed-tasks', 'task-completion-rate',
        'active-tasks', 'pending-tasks', 'paused-tasks',
        'overdue-tasks', 'overdue-total-tasks', 'overdue-rate'
    ];
    
    statsElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '-';
        }
    });
}

function updatePageTitle() {
    const pageTitle = document.getElementById('page-title');
    if (pageTitle && currentUser) {
        const sectionTitles = {
            'overview': 'Tổng Quan',
            'projects': 'Quản lý Dự án', 
            'tasks': 'Quản lý Nhiệm vụ',
            'staff': 'Quản lý Nhân viên'
        };
        
        const baseTitle = sectionTitles[currentSection] || 'Dashboard';
        const userName = currentUser.name || 'User';
        pageTitle.textContent = `${baseTitle} - ${userName}`;
    }
}

function isAdmin() {
    return currentUser && currentUser.role && currentUser.role.toLowerCase().includes('admin');
}

function isManager() {
  return currentUser && currentUser.role && currentUser.role.toLowerCase().includes('quản lý');
}


function hideLoginError() {
    const errorDiv = document.getElementById('login-error');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
}

// === Event Listeners ===
function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            if (section !== 'activity' && isAuthenticated) {
                switchSection(section);
            }
        });
    });

    // Mobile menu
    document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);
    document.getElementById('mobile-overlay').addEventListener('click', closeMobileMenu);
    
    // Sidebar toggle
    document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);

    // Authentication buttons
    document.getElementById('login-btn')?.addEventListener('click', showLoginModal);
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
    
    // Login form
    document.getElementById('login-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        handleLogin(email, password);
    });

    // Quick add buttons - only work if user is authenticated and has permission
    document.getElementById('quick-add-project')?.addEventListener('click', () => {
      // Thay đổi điều kiện từ isAdmin() thành isAdmin() || isManager()
      if (isAuthenticated && (isAdmin() || isManager())) openModal('project');
    });
    document.getElementById('quick-add-task')?.addEventListener('click', () => {
        if (isAuthenticated && isAdmin()) openModal('task');
    });
    document.getElementById('quick-add-staff')?.addEventListener('click', () => {
        if (isAuthenticated && isAdmin()) openModal('staff');
    });

    // Add buttons
    document.getElementById('add-project-btn')?.addEventListener('click', () => {
      // Thay đổi điều kiện từ isAdmin() thành isAdmin() || isManager()
      if (isAuthenticated && (isAdmin() || isManager())) openModal('project');
    });
    document.getElementById('add-project-standalone')?.addEventListener('click', () => {
      // Thay đổi điều kiện từ isAdmin() thành isAdmin() || isManager()
      if (isAuthenticated && (isAdmin() || isManager())) openModal('project');
    });
    document.getElementById('add-task-btn')?.addEventListener('click', () => {
        if (isAuthenticated && canUserCreateTask()) openModal('task');
    });
    document.getElementById('add-task-standalone')?.addEventListener('click', () => {
        if (isAuthenticated && canUserCreateTask()) openModal('task');
    });

    // Và dòng này:
    document.getElementById('quick-add-task')?.addEventListener('click', () => {
        if (isAuthenticated && canUserCreateTask()) openModal('task');
    });

    // Thêm event listener cho nút thêm thông báo
    document.getElementById('add-notification-btn')?.addEventListener('click', () => {
      if (isAuthenticated && isAdmin()) openModal('notification');
    });

    // Search
    document.getElementById('search-input')?.addEventListener('input', handleSearch);
    document.getElementById('project-task-search')?.addEventListener('input', handleProjectTaskSearch);

    // Notifications
    document.getElementById('notification-btn')?.addEventListener('click', toggleNotifications);
    document.getElementById('clear-notifications')?.addEventListener('click', clearNotifications);

    // Sync button
    document.getElementById('sync-btn')?.addEventListener('click', handleManualSync);

    // User interaction detection for smart sync
    setupUserInteractionDetection();

    // Global click handler for action buttons
    document.addEventListener('click', function(e) {
        if (!isAuthenticated) return;
        
        if (e.target.matches('.edit-btn') || e.target.closest('.edit-btn')) {
            const btn = e.target.matches('.edit-btn') ? e.target : e.target.closest('.edit-btn');
            const type = btn.dataset.type;
            const id = btn.dataset.id;
            
            // Check permissions
            if (canUserEditResource(type, id)) {
                openEditModal(type, id);
            } else {
                showToast('Bạn không có quyền chỉnh sửa mục này', 'error');
            }
        }
        
        if (e.target.matches('.delete-btn') || e.target.closest('.delete-btn')) {
            const btn = e.target.matches('.delete-btn') ? e.target : e.target.closest('.delete-btn');
            const type = btn.dataset.type;
            const id = btn.dataset.id;
            const name = btn.dataset.name || id;
            
            // Check permissions
            if (canUserDeleteResource(type, id)) {
                confirmDelete(type, id, name);
            } else {
                showToast('Bạn không có quyền xóa mục này', 'error');
            }
        }

        // THÊM: Xử lý click vào project card
        if (e.target.closest('.clickable-project-card') && !e.target.closest('.action-btn')) {
            const card = e.target.closest('.clickable-project-card');
            const projectId = card.dataset.id;
            
            if (projectId) {
                // Get project data
                const project = allProjects.find(p => p[COL.P_ID] === projectId);
                const projectName = project ? project[COL.P_NAME] : 'Unknown Project';
                showProjectDetailsModal(projectId, projectName);
            }
        }

        // THÊM: Xử lý click vào task card
        if (e.target.closest('.clickable-task-card') && !e.target.closest('.action-btn')) {
            const card = e.target.closest('.clickable-task-card');
            const taskId = card.dataset.id;
            
            if (taskId) {
                // Mở modal chỉnh sửa task trực tiếp
                openEditModal('task', taskId);
            }
        }

        // Project expand/collapse
        if (e.target.matches('.project-expand-btn') || e.target.closest('.project-expand-btn')) {
            const btn = e.target.matches('.project-expand-btn') ? e.target : e.target.closest('.project-expand-btn');
            toggleProjectTasks(btn);
        }

        // Hide Gantt search when clicking outside
        const ganttSearchBtn = document.getElementById('gantt-search-btn');
        const ganttSearchInput = document.getElementById('gantt-search');
        if (ganttSearchBtn && ganttSearchInput && currentSection === 'gantt') {
            if (!ganttSearchBtn.contains(e.target) && !ganttSearchInput.contains(e.target)) {
                ganttSearchInput.classList.add('hidden');
            }
        }
    });

    // Thêm phần Gantt chart listeners
    setupGanttEventListeners();
}

function showProjectDetailsModal(projectId, projectName) {
    // Lọc các nhiệm vụ thuộc dự án này
    const projectTasks = allTasks.filter(task => task[COL.T_PID] === projectId);
    
    // Tính số liệu thống kê
    const totalTasks = projectTasks.length;
    const completedTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành')).length;
    const inProgressTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('đang')).length;
    const pendingTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('chưa')).length;
    const overdueTasks = projectTasks.filter(task => isTaskOverdue(task[COL.T_DUE]) && !(task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành')).length;
    const projectProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    // Sắp xếp nhiệm vụ theo trạng thái
    projectTasks.sort((a, b) => {
        const statusA = (a[COL.T_STATUS] || '').toLowerCase();
        const statusB = (b[COL.T_STATUS] || '').toLowerCase();
        
        // Sắp xếp theo thứ tự: Hoàn thành -> Đang thực hiện -> Chưa bắt đầu -> Khác
        if (statusA.includes('hoàn thành') && !statusB.includes('hoàn thành')) return 1;
        if (!statusA.includes('hoàn thành') && statusB.includes('hoàn thành')) return -1;
        if (statusA.includes('đang') && statusB.includes('chưa')) return -1;
        if (statusA.includes('chưa') && statusB.includes('đang')) return 1;
        
        return 0;
    });
    
    // Tạo HTML cho modal
    const modalHTML = `
        <div id="project-details-modal" class="modal">
            <div class="modal-content max-w-4xl">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Chi tiết dự án: ${projectName}</h3>
                    <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                        Đóng
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="glass-card p-4 text-center">
                            <h4 class="text-lg font-semibold text-gray-700">${totalTasks}</h4>
                            <p class="text-sm text-gray-500">Tổng nhiệm vụ</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-green-50">
                            <h4 class="text-lg font-semibold text-green-600">${completedTasks}</h4>
                            <p class="text-sm text-gray-500">Hoàn thành</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-blue-50">
                            <h4 class="text-lg font-semibold text-blue-600">${inProgressTasks}</h4>
                            <p class="text-sm text-gray-500">Đang thực hiện</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-red-50">
                            <h4 class="text-lg font-semibold text-red-600">${overdueTasks}</h4>
                            <p class="text-sm text-gray-500">Quá hạn</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-700">Tiến độ dự án</h4>
                            <span class="text-sm font-semibold">${projectProgress}%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full">
                            <div class="h-full bg-gray-300 rounded-full" style="width: ${projectProgress}%"></div>
                        </div>
                    </div>
                </div>
                
                <h4 class="font-semibold text-gray-900 mb-4">Danh sách nhiệm vụ (${totalTasks})</h4>
                
                <div class="max-h-96 overflow-y-auto">
                    ${totalTasks > 0 ? 
                        `<div class="space-y-3">
                            ${projectTasks.map(task => createTaskListItem(task)).join('')}
                        </div>` : 
                        `<div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2 opacity-30 font-bold">Nhiệm vụ</div>
                            <p>Chưa có nhiệm vụ nào trong dự án này</p>
                        </div>`
                    }
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" class="btn-primary close-modal">Đóng</button>
                </div>
            </div>
        </div>
    `;
    
    // Thêm modal vào DOM
    document.getElementById('modals-container').innerHTML = modalHTML;
    
    // Hiển thị modal
    const modal = document.getElementById('project-details-modal');
    modal.classList.add('active');
    
    // Setup close handler
    const closeButtons = modal.querySelectorAll('.close-modal');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal('project-details-modal');
        });
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal('project-details-modal');
        }
    });
}

// Hàm tạo item cho danh sách nhiệm vụ trong modal
function createTaskListItem(task) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Chưa có tên';
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Chưa gán';
    const taskStatus = task[COL.T_STATUS] || 'Chưa bắt đầu';
    const taskPriority = task[COL.T_PRIORITY] || 'Trung bình';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    const isOverdue = isTaskOverdue(task[COL.T_DUE]) && !(taskStatus.toLowerCase().includes('hoàn thành'));
    
    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    
    return `
        <div class="glass-card p-4 hover:shadow-md transition-shadow ${isOverdue ? 'border-l-4 border-red-500' : ''}">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h5 class="font-medium text-gray-900">${taskName} <span class="text-gray-500 text-xs">(${taskId})</span></h5>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                        ${isOverdue ? '<span class="status-badge status-overdue">Quá hạn</span>' : ''}
                    </div>
                </div>
                
                <div class="ml-4 flex flex-col items-end">
                    <div class="flex items-center text-sm text-gray-600 mb-1">
                        
                        <span>${taskAssignee}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        
                        <span>${taskDueDate}</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                    <span>Tiến độ</span>
                    <span>${taskCompletion}%</span>
                </div>
                <div class="h-1.5 bg-gray-200 rounded-full">
                    <div class="h-full ${taskStatus.toLowerCase().includes('hoàn thành') ? 'bg-green-500' : 'bg-blue-500'} rounded-full" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
        </div>
    `;
}

function canUserEditResource(type, id) {
  if (isAdmin()) return true;
  
  if (isManager()) {
    // Managers can edit projects and any tasks
    if (type === 'project') {
      return true;
    }
    
    if (type === 'task') {
      // Manager có thể sửa tất cả các task
      return true;
    }
  }
  
  // THÊM: Người dùng thường có thể sửa dự án họ phụ trách
  if (type === 'project') {
    const project = allProjects.find(p => p[COL.P_ID] === id);
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    return false;
  }
  
  // Người dùng thường có thể sửa task trong dự án mà họ quản lý
  if (type === 'task') {
    const task = allTasks.find(t => t[COL.T_ID] === id);
    if (!task) return false;
    
    // Kiểm tra nếu task thuộc về dự án mà người dùng là quản lý
    const projectId = task[COL.T_PID];
    const project = allProjects.find(p => p[COL.P_ID] === projectId);
    
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    
    // Hoặc task được giao cho người dùng này
    return task[COL.T_ASSIGNEE] === currentUser.name;
  }
  
  return false;
}

function canUserDeleteResource(type, id) {
  if (isAdmin()) return true;
  
  if (isManager()) {
    // Managers can delete projects and any tasks
    if (type === 'project') {
      return true;
    }
    
    if (type === 'task') {
      // Manager có thể xóa tất cả các task
      return true;
    }
  }
  
  // THÊM: Người dùng thường có thể xóa dự án họ phụ trách
  if (type === 'project') {
    const project = allProjects.find(p => p[COL.P_ID] === id);
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    return false;
  }
  
  // Người dùng thường có thể xóa task trong dự án mà họ quản lý
  if (type === 'task') {
    const task = allTasks.find(t => t[COL.T_ID] === id);
    if (!task) return false;
    
    // Kiểm tra nếu task thuộc về dự án mà người dùng là quản lý
    const projectId = task[COL.T_PID];
    const project = allProjects.find(p => p[COL.P_ID] === projectId);
    
    if (project && project[COL.P_MANAGER] === currentUser.name) {
      return true;
    }
    
    // Hoặc task được giao cho người dùng này
    return task[COL.T_ASSIGNEE] === currentUser.name;
  }
  
  return false;
}


// === Navigation ===
function switchSection(sectionName) {
  // Update active nav link
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

  // Update page title
  const titles = {
    'overview': 'Tổng Quan',
    'projects': 'Quản lý Dự án',
    'tasks': 'Quản lý Nhiệm vụ',
    'staff': 'Quản lý Nhân viên',
    'gantt': 'Sơ đồ Gantt'  // Thêm tiêu đề cho tab Gantt
  };
  document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';

  // Show/hide sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(`${sectionName}-section`).classList.add('active');

  currentSection = sectionName;
  
  // Nếu chuyển sang tab Gantt, render biểu đồ
  if (sectionName === 'gantt') {
    // Thêm timeout để đảm bảo DOM được cập nhật trước khi thiết lập event listeners
    setTimeout(() => {
      renderGanttChart();
      // setupGanttEventListeners() đã được gọi trong renderGanttChart() nên không cần gọi lại ở đây
    }, 10);
  }
  
  // Close mobile menu if open
  closeMobileMenu();
}

function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    sidebar.classList.add('open');
    overlay.classList.remove('hidden');
    setTimeout(() => overlay.classList.remove('opacity-0'), 10);
}

function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    sidebar.classList.remove('open');
    overlay.classList.add('opacity-0');
    setTimeout(() => overlay.classList.add('hidden'), 300);
}

function toggleSidebar() {
    const body = document.body;
    const toggleBtn = document.getElementById('sidebar-toggle');
    const icon = toggleBtn.querySelector('i');
    
    body.classList.toggle('sidebar-collapsed');
    
    // Always use bars icon
    icon.className = 'fas fa-bars text-gray-600';
    
    // Save state to localStorage
    localStorage.setItem('sidebarCollapsed', body.classList.contains('sidebar-collapsed'));
}

// === Data Rendering ===
function renderStats(stats) {
    if (!stats) return;
    
    // Tính toán dữ liệu cho projects
    const totalProjects = stats.totalProjects || 0;
    const completedProjects = allProjects.filter(project => {
        const status = (project[COL.P_STATUS] || '').toLowerCase();
        return status.includes('hoàn thành');
    }).length;
    const projectCompletionRate = totalProjects > 0 ? Math.round((completedProjects / totalProjects) * 100) : 0;
    
    // Tính toán dữ liệu cho tasks
    const totalTasks = stats.totalTasks || 0;
    const completedTasks = stats.completedTasks || 0;
    const taskCompletionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    // Tính toán dự án đang làm
    const pendingTasks = allTasks.filter(task => {
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        return status.includes('chưa bắt đầu');
    }).length;

    const ongoingTasks = allTasks.filter(task => {
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        return status.includes('đang');
    }).length;

    const pausedTasks = allTasks.filter(task => {
        const status = (task[COL.T_STATUS] || '').toLowerCase();
        return status.includes('tạm dừng');
    }).length;

    const activeTasks = ongoingTasks + pendingTasks + pausedTasks;
    
    // Tính toán nhiệm vụ quá hạn
    const overdueTasks = stats.overdueTasks || 0;
    const overdueRate = totalTasks > 0 ? Math.round((overdueTasks / totalTasks) * 100) : 0;
    
    // Cập nhật DOM
    document.getElementById('total-projects').textContent = totalProjects;
    document.getElementById('completed-projects').textContent = completedProjects;
    document.getElementById('project-completion-rate').textContent = `${projectCompletionRate}%`;
    
    document.getElementById('total-tasks').textContent = totalTasks;
    document.getElementById('completed-tasks').textContent = completedTasks;
    document.getElementById('task-completion-rate').textContent = `${taskCompletionRate}%`;
    
    document.getElementById('active-tasks').textContent = activeTasks;
    document.getElementById('pending-tasks').textContent = pendingTasks;
    document.getElementById('paused-tasks').textContent = pausedTasks;
    
    document.getElementById('overdue-tasks').textContent = overdueTasks;
    document.getElementById('overdue-total-tasks').textContent = totalTasks;
    document.getElementById('overdue-rate').textContent = `${overdueRate}%`;
}

// === Compact Project Task Tree ===
function renderProjectTaskTree() {
  const container = document.getElementById('project-task-tree');
  if (!container) return;
  
  // Chỉ lấy các dự án mà người dùng có quyền xem
  const userProjects = getUserAllowedProjects();
  
  if (!userProjects || userProjects.length === 0) {
    container.innerHTML = '<div class="loading-card">Chưa có dự án nào</div>';
    return;
  }
  
  const projectsWithTasks = userProjects.map(project => {
    // Chỉ lấy các nhiệm vụ thuộc dự án này mà người dùng có quyền xem
    let projectTasks = allTasks.filter(task => task[COL.T_PID] === project[COL.P_ID]);
    
    // Nếu không phải admin, lọc thêm các nhiệm vụ
    if (!isAdmin()) {
      if (isManager()) {
        // Quản lý thấy các nhiệm vụ của dự án họ quản lý và nhiệm vụ của họ
        if (project[COL.P_MANAGER] !== currentUser.name) {
          // Nếu không phải dự án quản lý, chỉ thấy nhiệm vụ của mình
          projectTasks = projectTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
        }
      } else {
        // Người dùng thường chỉ thấy nhiệm vụ của mình và nhiệm vụ của dự án họ quản lý
        projectTasks = projectTasks.filter(task => {
          if (task[COL.T_ASSIGNEE] === currentUser.name) {
            return true;
          }
          if (project[COL.P_MANAGER] === currentUser.name) {
            return true;
          }
          return false;
        });
      }
    }
    
    return { ...project, tasks: projectTasks };
  });
  
  container.innerHTML = projectsWithTasks.map(project => createCompactProjectItem(project)).join('');
}

function createCompactProjectItem(project) {
    const projectId = project[COL.P_ID] || 'N/A';
    const projectName = `${project[COL.P_NAME] || 'Chưa có tên'} (${projectId})`;
    const projectDesc = project[COL.P_DESC] || 'Không có mô tả';
    const projectStatus = project[COL.P_STATUS] || 'Chưa bắt đầu';
    const projectManager = project[COL.P_MANAGER] || 'Chưa gán';
    const tasks = project.tasks || [];
    
    const statusClass = getStatusClass(projectStatus);
    const completedTasks = tasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành')).length;
    const totalTasks = tasks.length;
    const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    return `
        <div class="project-tree-item" data-id="${projectId}">
            <div class="project-header">
                <button class="expand-icon project-expand-btn" data-project="${projectId}">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="project-info">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="project-title">${projectName}</h4>
                            <p class="project-description">${projectDesc}</p>
                            <div class="project-meta">
                              <span class="status-badge ${statusClass}">${projectStatus}</span>
                              <span class="flex items-center text-xs">
                                  ${projectManager}
                              </span>
                              <span class="flex items-center text-xs ml-2">
                                  Bắt đầu: ${formatDateForDisplay(project[COL.P_START])}
                              </span>
                              <span class="flex items-center text-xs ml-2">
                                  Kết thúc: ${formatDateForDisplay(project[COL.P_END])}
                              </span>
                          </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Chỉnh sửa">
                                Sửa
                            </button>
                            <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="Xóa">
                                Xóa
                            </button>
                        </div>
                    </div>
                    <div class="project-stats">
                        <span class="text-sm text-gray-600">${completedTasks}/${totalTasks} nhiệm vụ</span>
                        <span class="text-sm font-medium text-gray-700">${progressPercent}%</span>
                    </div>
                    <div class="project-progress">
                        <div class="project-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
            </div>
            
            <div class="project-tasks" id="tasks-${projectId}">
                ${tasks.length > 0 ? tasks.map(task => createCompactTaskItem(task)).join('') : '<div class="text-gray-500 text-sm py-3">Chưa có nhiệm vụ nào</div>'}
            </div>
        </div>
    `;
}

function createCompactTaskItem(task) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Chưa có tên';
    const taskDesc = task[COL.T_DESC] || ''; // Thêm dòng này
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Chưa gán';
    const taskStatus = task[COL.T_STATUS] || 'Chưa bắt đầu';
    const taskPriority = task[COL.T_PRIORITY] || 'Trung bình';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    
    // THAY ĐỔI: Thêm thông tin dự án vào task item
    const taskProjectId = task[COL.T_PID] || 'N/A';
    const project = allProjects.find(p => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : '';
    
    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    
    return `
        <div class="task-tree-item task-connection" data-id="${taskId}">
            <div class="task-info">
                <div class="task-details">
                    <h5 class="task-title">${taskName}</h5>
                    ${taskDesc ? `<p class="text-xs text-gray-600 mb-1">${taskDesc}</p>` : ''}
                    <div class="task-meta">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                    </div>
                    <div class="task-assignee">
                        
                        <span>${taskAssignee}</span>
                        <span class="mx-2">•</span>
                        
                        <span>${taskDueDate}</span>
                    </div>
                    
                    ${task[COL.T_RESULT_LINKS] ? `
                    <div class="mt-1 text-xs">
                        <span class="font-medium">Links:</span> ${formatTaskLinks(task[COL.T_RESULT_LINKS])}
                    </div>
                    ` : ''}
                    
                </div>
                <div class="flex items-center space-x-3">
                    <div class="task-progress">
                        <span class="task-progress-text">${taskCompletion}%</span>
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${taskCompletion}%"></div>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button class="action-btn action-btn-edit edit-btn" data-type="task" data-id="${taskId}" title="Chỉnh sửa">
                                 Sửa
                             </button>
                             <button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Xóa">
                                 Xóa
                             </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function toggleProjectTasks(btn) {
    const projectId = btn.dataset.project;
    const tasksContainer = document.getElementById(`tasks-${projectId}`);
    
    if (tasksContainer.classList.contains('expanded')) {
        // Đóng dự án hiện tại
        tasksContainer.classList.remove('expanded');
        btn.classList.remove('expanded');
    } else {
        // Đóng tất cả các dự án khác trước
        const allExpandedProjects = document.querySelectorAll('.project-tasks.expanded');
        const allExpandedBtns = document.querySelectorAll('.project-expand-btn.expanded');
        
        allExpandedProjects.forEach(container => {
            container.classList.remove('expanded');
        });
        
        allExpandedBtns.forEach(expandBtn => {
            expandBtn.classList.remove('expanded');
        });
        
        // Sau đó mở dự án hiện tại
        tasksContainer.classList.add('expanded');
        btn.classList.add('expanded');
    }
}

function renderPriorityTasks() {
  const container = document.getElementById('priority-tasks');
  if (!container) return;
  
  // Lọc các nhiệm vụ ưu tiên cao mà người dùng có quyền xem
  let userTasks = [];
  
  if (isAdmin()) {
    userTasks = allTasks;
  } else {
    const userProjects = getUserAllowedProjects();
    const userProjectIds = userProjects.map(p => p[COL.P_ID]);
    
    userTasks = allTasks.filter(task => {
      // Nhiệm vụ được giao cho người dùng
      if (task[COL.T_ASSIGNEE] === currentUser.name) {
        return true;
      }
      
      // Nhiệm vụ thuộc dự án mà người dùng quản lý
      const projectId = task[COL.T_PID];
      const project = allProjects.find(p => p[COL.P_ID] === projectId);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      
      return false;
    });
  }
  
  const highPriorityTasks = userTasks.filter(task => {
    const priority = (task[COL.T_PRIORITY] || '').toLowerCase();
    const status = (task[COL.T_STATUS] || '').toLowerCase();
    return priority.includes('cao') && !status.includes('hoàn thành');
  });
  
  if (highPriorityTasks.length === 0) {
    container.innerHTML = '<div class="col-span-full loading-card">Không có nhiệm vụ ưu tiên cao</div>';
    return;
  }
  
  // Show up to 8 tasks (4 per column) to fit the height better
  container.innerHTML = highPriorityTasks.slice(0, 8).map(task => createPriorityTaskCard(task)).join('');
}

function createPriorityTaskCard(task) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Chưa có tên';
    const taskDesc = task[COL.T_DESC] || ''; // Thêm mô tả
    const taskProjectId = task[COL.T_PID] || 'N/A';
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Chưa gán';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    
    // Tìm tên dự án từ mã dự án
    const project = allProjects.find(p => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : '';
    const projectDisplay = projectName ? `${projectName} (${taskProjectId})` : taskProjectId;
    
    const isOverdue = isTaskOverdue(task[COL.T_DUE]);
    
    return `
        <div class="priority-task-card" data-id="${taskId}">
            <div class="mb-3">
                <div class="flex items-start justify-between mb-1">
                    <h5 class="font-medium text-gray-900 text-sm leading-tight">${taskName}</h5>
                    ${isOverdue ? '<span class="status-badge status-overdue text-xs">Quá hạn</span>' : ''}
                </div>
                ${taskDesc ? `<p class="text-xs text-gray-600 mb-2 leading-relaxed">${taskDesc}</p>` : ''}
                <div class="text-xs text-gray-600 space-y-1">
                    <div>Dự án: ${projectDisplay}</div>
                    <div>Người thực hiện: ${taskAssignee}</div>
                    <div>Hạn: ${taskDueDate}</div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-medium text-gray-700 min-w-[30px]">${taskCompletion}%</span>
                <div class="flex-1 h-1.5 bg-gray-200 rounded-full">
                    <div class="h-full bg-gray-300 rounded-full" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
        </div>
    `;
}

function renderProjects() {
  const container = document.getElementById('projects-grid');
  if (!container) return;
  
  // Chỉ lấy các dự án mà người dùng có quyền xem
  const userProjects = getUserAllowedProjects();
  
  if (!userProjects || userProjects.length === 0) {
    container.innerHTML = '<div class="loading-card">Chưa có dự án nào</div>';
    return;
  }
  
  container.innerHTML = userProjects.map(project => createProjectCard(project, true)).join('');
}

function createProjectCard(project, isDetailed = false) {
    const projectId = project[COL.P_ID] || 'N/A';
    const projectName = project[COL.P_NAME] || 'Chưa có tên';
    const projectDesc = project[COL.P_DESC] || '';
    const projectManager = project[COL.P_MANAGER] || 'Chưa gán';
    const projectStatus = project[COL.P_STATUS] || 'Chưa bắt đầu';
    const startDate = formatDateForDisplay(project[COL.P_START]);
    const endDate = formatDateForDisplay(project[COL.P_END]);
    
    const statusClass = getStatusClass(projectStatus);
    
    return `
        <div class="project-card clickable-project-card cursor-pointer" data-id="${projectId}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 text-lg mb-1">${projectName}</h4>
                    ${projectDesc ? `<p class="text-sm text-gray-600 mb-2">${projectDesc}</p>` : ''}
                    <span class="status-badge ${statusClass}">${projectStatus}</span>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Chỉnh sửa">
                        Sửa
                    </button>
                    <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="Xóa">
                        Xóa
                    </button>
                </div>
            </div>
            
            ${isDetailed ? `
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex items-center">
                        <span>Quản lý: ${projectManager}</span>
                    </div>
                    ${startDate || endDate ? `
                    <div class="flex items-center justify-between">
                        ${startDate ? `<span>Bắt đầu: ${startDate}</span>` : (endDate ? `<span>Kết thúc: ${endDate}</span>` : '<span></span>')}
                        ${startDate && endDate ? `<span>Kết thúc: ${endDate}</span>` : '<span></span>'}
                    </div>
                    ` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function renderTasks() {
  const container = document.getElementById('tasks-grid');
  if (!container) return;
  
  // Lọc các nhiệm vụ mà người dùng có quyền xem
  let userTasks = [];
  
  if (isAdmin()) {
    userTasks = allTasks;
  } else {
    const userProjects = getUserAllowedProjects();
    const userProjectIds = userProjects.map(p => p[COL.P_ID]);
    
    userTasks = allTasks.filter(task => {
      // Nhiệm vụ được giao cho người dùng
      if (task[COL.T_ASSIGNEE] === currentUser.name) {
        return true;
      }
      
      // Nhiệm vụ thuộc dự án mà người dùng quản lý
      const projectId = task[COL.T_PID];
      const project = allProjects.find(p => p[COL.P_ID] === projectId);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      
      return false;
    });
  }
  
  if (!userTasks || userTasks.length === 0) {
    container.innerHTML = '<div class="loading-card">Chưa có nhiệm vụ nào</div>';
    return;
  }
  
  container.innerHTML = userTasks.map(task => createTaskCard(task, true)).join('');
}

function createTaskCard(task, isDetailed = false) {
    const taskId = task[COL.T_ID] || 'N/A';
    const taskName = task[COL.T_NAME] || 'Chưa có tên';
    const taskDesc = task[COL.T_DESC] || ''; // Thêm dòng này
    const taskProjectId = task[COL.T_PID] || 'N/A';
    const taskAssignee = task[COL.T_ASSIGNEE] || 'Chưa gán';
    const taskStatus = task[COL.T_STATUS] || 'Chưa bắt đầu';
    const taskPriority = task[COL.T_PRIORITY] || 'Trung bình';
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);

        // Thêm các biến mới để lấy giá trị từ task
    const taskReportDate = formatDateForDisplay(task[COL.T_REPORT_DATE]);
    const taskTarget = task[COL.T_TARGET] || '';
    const taskResultLinks = task[COL.T_RESULT_LINKS] || '';
    const taskOutput = task[COL.T_OUTPUT] || '';
    
    // THAY ĐỔI: Tìm tên dự án từ mã dự án
    const project = allProjects.find(p => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : '';
    // Tạo text hiển thị đầy đủ: "Tên dự án (Mã dự án)"
    const projectDisplay = projectName ? `${projectName} (${taskProjectId})` : taskProjectId;
    
    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    
    return `
        <div class="task-card clickable-task-card cursor-pointer" data-id="${taskId}">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 mb-1">${taskName}</h4>
                    ${taskDesc ? `<p class="text-sm text-gray-600 mb-2">${taskDesc}</p>` : ''}
                    <p class="text-sm text-gray-600 mb-2">Dự án: ${projectDisplay}</p>
                    <div class="flex items-center space-x-2">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                     <button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Xóa">
                         Xóa
                     </button>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-1">
                    <span>Tiến độ</span>
                    <span>${taskCompletion}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
            
            ${isDetailed ? `
                <div class="space-y-2 text-sm text-gray-600">
                  <div class="flex items-center justify-between">
                      <span>Giao cho: ${taskAssignee}</span>
                      <span>Hạn: ${taskDueDate}</span>
                  </div>
                  
                  ${taskReportDate ? `
                  <div class="flex items-center">
                      <span>Ngày báo cáo: ${taskReportDate}</span>
                  </div>
                  ` : ''}
                  
                  ${taskTarget ? `
                  <div class="flex items-start">
                      <div>
                          <span class="font-medium">Mục tiêu:</span>
                          <p class="text-xs text-gray-600 mt-1">${taskTarget}</p>
                      </div>
                  </div>
                  ` : ''}
                  
                  ${taskResultLinks ? `
                  <div class="flex items-start">
                      <div>
                          <span class="font-medium">Link kết quả:</span>
                          <div class="text-xs text-blue-600 mt-1">${formatTaskLinks(taskResultLinks)}</div>
                      </div>
                  </div>
                  ` : ''}
                  
                  ${taskOutput ? `
                  <div class="flex items-start">
                      <div>
                          <span class="font-medium">Kết quả đầu ra:</span>
                          <p class="text-xs text-gray-600 mt-1">${taskOutput}</p>
                      </div>
                  </div>
                  ` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function renderStaff() {
    const container = document.getElementById('staff-grid');
    if (!container) return;
    
    if (!allStaff || allStaff.length === 0) {
        container.innerHTML = '<div class="loading-card">Chưa có nhân viên nào</div>';
        return;
    }
    
    // Nhóm staff theo phân quyền
    const groupedStaff = {
        'Admin': [],
        'Quản lý': [],
        'Nhân viên': []
    };
    
    allStaff.forEach(staff => {
        const role = staff[COL.S_ROLE] || 'Nhân viên';
        if (groupedStaff[role]) {
            groupedStaff[role].push(staff);
        } else {
            groupedStaff['Nhân viên'].push(staff);
        }
    });
    
    let html = '';
    
    // Render từng nhóm
    Object.keys(groupedStaff).forEach(role => {
        if (groupedStaff[role].length > 0) {
            let roleClass = 'text-gray-800';
            if (role === 'Admin') roleClass = 'text-red-600';
            else if (role === 'Quản lý') roleClass = 'text-blue-600';
            else if (role === 'Nhân viên') roleClass = 'text-green-600';
            
            html += `
                <div class="col-span-full mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-sm font-medium ${roleClass}">${role}</span>
                        <span class="text-sm text-gray-500">(${groupedStaff[role].length} người)</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${groupedStaff[role].map(staff => createStaffCard(staff)).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

function createStaffCard(staff) {
  const staffId = staff[COL.S_ID] || 'N/A';
  const staffName = staff[COL.S_NAME] || 'Chưa có tên';
  const staffEmail = staff[COL.S_EMAIL] || '';
  const staffPosition = staff[COL.S_POS] || 'Chưa có chức vụ';
  const staffRole = staff[COL.S_ROLE] || 'Nhân viên';
  
  const initials = staffName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  let roleClass = 'user-role-user';
  
  if (staffRole.toLowerCase().includes('admin')) {
    roleClass = 'user-role-admin';
  } else if (staffRole.toLowerCase().includes('quản lý')) {
    roleClass = 'user-role-manager';
  }
  
  return `
      <div class="staff-card" data-id="${staffId}">
          <div class="flex justify-between items-start mb-4">
              <div class="flex-1"></div>
              <div class="flex space-x-2">
                  <button class="action-btn action-btn-edit edit-btn" data-type="staff" data-id="${staffId}" title="Chỉnh sửa">
                      Sửa
                  </button>
                  <button class="action-btn action-btn-delete delete-btn" data-type="staff" data-id="${staffId}" data-name="${staffName}" title="Xóa">
                      Xóa
                  </button>
              </div>
          </div>
          <div class="space-y-2 text-left">
              <div>
                  <span class="text-sm font-medium text-gray-700">Họ tên:</span>
                  <span class="text-sm text-gray-900 ml-1">${staffName}</span>
              </div>
              <div>
                  <span class="text-sm font-medium text-gray-700">Email:</span>
                  <span class="text-sm text-gray-900 ml-1">${staffEmail}</span>
              </div>
              <div>
                  <span class="text-sm font-medium text-gray-700">Chức vụ:</span>
                  <span class="text-sm text-gray-900 ml-1">${staffPosition}</span>
              </div>
          </div>
      </div>
  `;
}

function renderChart(chartData) {
    const ctx = document.getElementById('status-chart');
    const message = document.getElementById('chart-message');
    
    if (!ctx) return;
    
    // Destroy existing chart
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
        message.textContent = chartData?.message || 'Không có dữ liệu biểu đồ';
        message.classList.remove('hidden');
        return;
    }
    
    message.classList.add('hidden');
    
    const colors = [
        'rgba(59, 130, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(139, 92, 246, 0.8)'
    ];
    
    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.data,
                backgroundColor: colors.slice(0, chartData.labels.length),
                borderColor: colors.slice(0, chartData.labels.length).map(c => c.replace('0.8', '1')),
                borderWidth: 2,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,           // GIẢM từ 20 xuống 15
                        usePointStyle: true,
                        font: {
                            size: 10             // GIẢM từ 12 xuống 10
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutCubic'
            }
        }
    });
}

function renderProjectProgressChart() {
    const ctx = document.getElementById('project-progress-chart');
    const message = document.getElementById('project-chart-message');
    
    if (!ctx) return;
    
    // Destroy existing chart
    if (projectProgressChart) {
        projectProgressChart.destroy();
    }
    
    if (!allProjects || allProjects.length === 0) {
        message.textContent = 'Không có dữ liệu dự án';
        message.classList.remove('hidden');
        return;
    }
    
    message.classList.add('hidden');
    
    // Initialize progress ranges
    const progressRanges = {
        '0-25%': { count: 0, projects: [] },
        '26-50%': { count: 0, projects: [] },
        '51-75%': { count: 0, projects: [] },
        '76-99%': { count: 0, projects: [] },
        '100%': { count: 0, projects: [] }
    };
    
    // Group projects by progress ranges
    allProjects.forEach(project => {
        const projectTasks = allTasks.filter(task => task[COL.T_PID] === project[COL.P_ID]);
        const completedTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành')).length;
        const totalTasks = projectTasks.length;
        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        const projectName = project[COL.P_NAME] || 'Chưa có tên';
        
        // Determine which range the project belongs to
        if (progress === 100) {
            progressRanges['100%'].count++;
            progressRanges['100%'].projects.push(projectName);
        } else if (progress >= 76) {
            progressRanges['76-99%'].count++;
            progressRanges['76-99%'].projects.push(projectName);
        } else if (progress >= 51) {
            progressRanges['51-75%'].count++;
            progressRanges['51-75%'].projects.push(projectName);
        } else if (progress >= 26) {
            progressRanges['26-50%'].count++;
            progressRanges['26-50%'].projects.push(projectName);
        } else {
            progressRanges['0-25%'].count++;
            progressRanges['0-25%'].projects.push(projectName);
        }
    });
    
    // Prepare chart data
    const labels = Object.keys(progressRanges);
    const data = Object.values(progressRanges).map(range => range.count);
    const colors = [
        'rgba(239, 68, 68, 0.8)',   // Red for 0-25%
        'rgba(245, 158, 11, 0.8)',  // Orange for 26-50%
        'rgba(59, 130, 246, 0.8)',  // Blue for 51-75%
        'rgba(16, 185, 129, 0.8)',  // Green for 76-99%
        'rgba(34, 197, 94, 0.8)'    // Dark green for 100%
    ];
    
    projectProgressChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Số lượng dự án',
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `Khoảng tiến độ: ${context[0].label}`;
                        },
                        label: function(context) {
                            return `Số lượng: ${context.parsed.y} dự án`;
                        },
                        afterLabel: function(context) {
                            const rangeKey = context.label;
                            const projects = progressRanges[rangeKey].projects;
                            if (projects.length > 0) {
                                const maxDisplay = 5; // Hiển thị tối đa 5 dự án trong tooltip
                                let result = '\nDự án:';
                                projects.slice(0, maxDisplay).forEach(project => {
                                    result += `\n• ${project}`;
                                });
                                if (projects.length > maxDisplay) {
                                    result += `\n... và ${projects.length - maxDisplay} dự án khác`;
                                }
                                return result;
                            }
                            return '';
                        }
                    },
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    footerFont: {
                        size: 11
                    },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Math.floor(value); // Chỉ hiển thị số nguyên
                        }
                    },
                    title: {
                        display: true,
                        text: 'Số lượng dự án'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Khoảng tiến độ'
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutCubic'
            }
        }
    });
}

// === New Staff Performance Chart ===
function renderStaffPerformanceChart() {
    const ctx = document.getElementById('staff-performance-chart');
    const message = document.getElementById('staff-chart-message');
    
    if (!ctx) return;
    
    // Destroy existing chart
    if (staffPerformanceChart) {
        staffPerformanceChart.destroy();
    }
    
    if (!allStaff || allStaff.length === 0 || !allTasks || allTasks.length === 0) {
        message.textContent = 'Không có dữ liệu nhân viên hoặc nhiệm vụ';
        message.classList.remove('hidden');
        return;
    }
    
    message.classList.add('hidden');
    
    // Calculate staff performance
    const staffPerformance = allStaff.map(staff => {
        const staffName = staff[COL.S_NAME] || 'Không tên';
        const assignedTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === staffName);
        const completedTasks = assignedTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành'));
        const completionRate = assignedTasks.length > 0 ? Math.round((completedTasks.length / assignedTasks.length) * 100) : 0;
        
        return {
            name: staffName,
            totalTasks: assignedTasks.length,
            completedTasks: completedTasks.length,
            completionRate: completionRate
        };
    }).filter(staff => staff.totalTasks > 0); // Only show staff with assigned tasks
    
    if (staffPerformance.length === 0) {
        message.textContent = 'Chưa có nhiệm vụ nào được giao';
        message.classList.remove('hidden');
        return;
    }
    
    staffPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: staffPerformance.map(s => s.name),
            datasets: [
                {
                    label: 'Tổng số nhiệm vụ',
                    data: staffPerformance.map(s => s.totalTasks),
                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    yAxisID: 'y'
                },
                {
                    label: 'Tỷ lệ hoàn thành (%)',
                    data: staffPerformance.map(s => s.completionRate),
                    type: 'line',
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const staffData = staffPerformance[context.dataIndex];
                            if (context.dataset.label === 'Tổng số nhiệm vụ') {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            } else {
                                return `${context.dataset.label}: ${context.parsed.y}%`;
                            }
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 0) { // Only show for total tasks
                                const staffData = staffPerformance[context.dataIndex];
                                return `Hoàn thành: ${staffData.completedTasks}/${staffData.totalTasks}`;
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        font: {
                            size: 10
                        }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Số lượng nhiệm vụ'
                    },
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Tỷ lệ (%)'
                    },
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutCubic'
            }
        }
    });
}

function renderActivity(activities) {
    const container = document.getElementById('recent-activity');
    if (!container) return;
    
    if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="loading-card">Không có hoạt động nào</div>';
        return;
    }
    
    const displayActivities = activities.slice(0, 8);
    
    container.innerHTML = displayActivities.map(activity => `
        <div class="activity-item">
            <div class="flex items-start space-x-3">

                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900">${activity[COL.A_ACTION] || 'Hành động'}</p>
                    <p class="text-xs text-gray-600 mt-1">${activity[COL.A_DETAILS] || ''}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        ${activity[COL.A_USER] || 'Ai đó'} • ${formatDateForDisplay(activity[COL.A_TIME], true)}
                    </p>
                </div>
            </div>
        </div>
    `).join('');
}

function renderNotifications(notifications) {
    const container = document.getElementById('notification-list');
    const badge = document.getElementById('notification-badge');
    
    if (!container || !badge) return;
    
    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Không có thông báo mới</div>';
        badge.classList.add('hidden');
        return;
    }
    
    // ✅ SỬA FILTER CHO USER HIỆN TẠI
    const filteredNotifications = notifications.filter(notification => {
        const recipientUser = String(notification[COL.N_USER] || '').trim();
        const currentUserName = String(currentUser?.name || '').trim();
        
        // Debug để kiểm tra
        console.log('Filter debug:', { 
            recipientUser, 
            currentUserName, 
            shouldShow: !recipientUser || recipientUser === currentUserName,
            notificationContent: notification[COL.N_CONTENT] 
        });
        
        // Hiển thị nếu: gửi cho user này HOẶC gửi cho tất cả (recipientUser rỗng)
        return !recipientUser || recipientUser === currentUserName;
    });
    
    if (filteredNotifications.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Không có thông báo nào</div>';
        badge.classList.add('hidden');
        return;
    }
    
    let unreadCount = 0;
    container.innerHTML = filteredNotifications.map(notification => {
        const isUnread = !notification.isRead;
        if (isUnread) unreadCount++;
        
        const recipientUser = String(notification[COL.N_USER] || '').trim();
        const recipientDisplay = recipientUser ? `Gửi cho: ${recipientUser}` : 'Gửi cho: Tất cả';
        
        return `
            <div class="notification-item p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0 cursor-pointer ${isUnread ? '' : 'opacity-60'}" 
                 data-id="${notification[COL.N_ID] || ''}"
                 onclick="markNotificationRead('${notification[COL.N_ID] || ''}', this)">
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 rounded-full ${isUnread ? 'bg-blue-500' : 'bg-gray-300'} mt-2 flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-900 ${isUnread ? 'font-medium' : ''}">${notification[COL.N_CONTENT] || 'Thông báo'}</p>
                        <p class="text-xs text-gray-400 mt-1">${recipientDisplay}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatDateForDisplay(notification[COL.N_TIME], true)}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// === Enhanced Modal Management ===
function openModal(type, data = null) {
    const isEdit = data !== null;
    const modalId = `${type}-modal`;
    
    // Remove existing modal
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }
    
    let modalHTML = '';
    
    if (type === 'project') {
        modalHTML = createProjectModal(isEdit, data);
    } else if (type === 'task') {
        modalHTML = createTaskModal(isEdit, data);
    } else if (type === 'staff') {
        modalHTML = createStaffModal(isEdit, data);
    }
    // ✅ THÊM VÀO ĐÂY:
    else if (type === 'notification') {
        modalHTML = createNotificationModal(isEdit, data);
    }
    
    
    document.getElementById('modals-container').innerHTML = modalHTML;
    
    const modal = document.getElementById(modalId);
    modal.classList.add('active');
    
    // Setup form submission
    const form = modal.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isEdit) {
                handleEdit(type, data);
            } else {
                handleAdd(type);
            }
        });
    }
    
    // Setup close handlers - Fixed
    const closeButtons = modal.querySelectorAll('.close-modal');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal(modalId);
        });
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal(modalId);
        }
    });
}

function openEditModal(type, id) {
    let data = null;
    
    if (type === 'project') {
        data = allProjects.find(p => p[COL.P_ID] === id);
    } else if (type === 'task') {
        data = allTasks.find(t => t[COL.T_ID] === id);
    } else if (type === 'staff') {
        data = allStaff.find(s => s[COL.S_ID] === id);
    }
    
    if (data) {
        openModal(type, data);
    } else {
        showToast(`Không tìm thấy ${type} với ID: ${id}`, 'error');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
            }
        }, 300);
    }
}

function createProjectModal(isEdit, data) {
  const title = isEdit ? 'Chỉnh sửa dự án' : 'Tạo dự án mới';
  const submitText = isEdit ? 'Cập nhật' : 'Tạo dự án';
  
  // Lọc danh sách người có thể được chọn làm quản lý dự án
  let eligibleManagers = [];
  
  // THAY ĐỔI: Đảm bảo người quản lý hiện tại của dự án luôn được hiển thị trong danh sách
  if (isEdit && data && data[COL.P_MANAGER]) {
    // Kiểm tra xem người quản lý hiện tại có trong danh sách nhân viên không
    const currentManager = allStaff.find(staff => staff[COL.S_NAME] === data[COL.P_MANAGER]);
    
    // Nếu không tìm thấy, thêm một đối tượng giả vào danh sách nhân viên tạm thời
    if (!currentManager) {
      const tempStaff = [...allStaff];
      tempStaff.push({
        [COL.S_NAME]: data[COL.P_MANAGER],
        [COL.S_EMAIL]: ''
      });
      
      if (isAdmin()) {
        eligibleManagers = tempStaff;
      } else if (isManager()) {
        // Quản lý chỉ có thể chọn chính họ và người quản lý hiện tại
        eligibleManagers = tempStaff.filter(staff => 
          staff[COL.S_NAME] === currentUser.name || staff[COL.S_NAME] === data[COL.P_MANAGER]
        );
      } else {
        // Người dùng thường chỉ có thể chọn chính họ hoặc người quản lý hiện tại nếu họ là người quản lý
        if (data[COL.P_MANAGER] === currentUser.name) {
          eligibleManagers = tempStaff.filter(staff => 
            staff[COL.S_NAME] === currentUser.name || staff[COL.S_NAME] === data[COL.P_MANAGER]
          );
        }
      }
    } else {
      // Xử lý bình thường nếu người quản lý đã có trong danh sách
      if (isAdmin()) {
        eligibleManagers = allStaff;
      } else if (isManager()) {
        // Quản lý chỉ có thể chọn chính họ và người quản lý hiện tại
        eligibleManagers = allStaff.filter(staff => 
          staff[COL.S_NAME] === currentUser.name || staff[COL.S_NAME] === data[COL.P_MANAGER]
        );
      } else {
        // Người dùng thường chỉ có thể chọn chính họ nếu họ là người quản lý dự án
        if (data[COL.P_MANAGER] === currentUser.name) {
          eligibleManagers = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
        }
      }
    }
  } else {
    // Nếu là tạo mới hoặc không có người quản lý
    if (isAdmin()) {
      eligibleManagers = allStaff;
    } else if (isManager()) {
      eligibleManagers = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
    }
  }
  
  return `
      <div id="project-modal" class="modal">
          <div class="modal-content">
              <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                  <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                         Đóng
                     </button>
              </div>
              
              <form id="project-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.P_ID]}">` : ''}
                  
                  <div class="form-group">
                      <label class="form-label">Tên dự án *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.P_NAME] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Mô tả</label>
                      <textarea name="description" class="form-textarea">${isEdit ? data[COL.P_DESC] || '' : ''}</textarea>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Quản lý dự án</label>
                      <select name="manager" class="form-select">
                          <option value="">-- Chọn quản lý --</option>
                          ${eligibleManagers.map(staff => {
                              const selected = isEdit && data[COL.P_MANAGER] === staff[COL.S_NAME] ? 'selected' : '';
                              const staffEmail = staff[COL.S_EMAIL] ? ` (${staff[COL.S_EMAIL]})` : '';
                              return `<option value="${staff[COL.S_NAME]}" ${selected}>${staff[COL.S_NAME]}${staffEmail}</option>`;
                          }).join('')}
                      </select>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Ngày bắt đầu</label>
                          <input type="date" name="startDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.P_START]) : ''}">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ngày kết thúc</label>
                          <input type="date" name="endDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.P_END]) : ''}">
                      </div>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Trạng thái</label>
                      <select name="status" class="form-select">
                          <option value="Chưa bắt đầu" ${isEdit && data[COL.P_STATUS] === 'Chưa bắt đầu' ? 'selected' : ''}>Chưa bắt đầu</option>
                          <option value="Đang thực hiện" ${isEdit && data[COL.P_STATUS] === 'Đang thực hiện' ? 'selected' : ''}>Đang thực hiện</option>
                          <option value="Hoàn thành" ${isEdit && data[COL.P_STATUS] === 'Hoàn thành' ? 'selected' : ''}>Hoàn thành</option>
                          <option value="Tạm dừng" ${isEdit && data[COL.P_STATUS] === 'Tạm dừng' ? 'selected' : ''}>Tạm dừng</option>
                          <option value="Hủy bỏ" ${isEdit && data[COL.P_STATUS] === 'Hủy bỏ' ? 'selected' : ''}>Hủy bỏ</option>
                      </select>
                  </div>
                  
                  <div class="flex justify-end space-x-3 mt-6">
                      <button type="button" class="btn-secondary close-modal">Hủy</button>
                      <button type="submit" class="btn-primary">${submitText}</button>
                  </div>
              </form>
          </div>
      </div>
  `;
}

function createTaskModal(isEdit, data) {
  const title = isEdit ? 'Chỉnh sửa nhiệm vụ' : 'Tạo nhiệm vụ mới';
  const submitText = isEdit ? 'Cập nhật' : 'Tạo nhiệm vụ';
  
  // Lọc danh sách nhân viên có thể giao việc
  let assignableStaff = [];
  
  if (isAdmin()) {
    // Admin có thể giao việc cho tất cả
    assignableStaff = allStaff;
  } else if (isManager()) {
    // Quản lý có thể giao việc cho tất cả trừ Admin
    assignableStaff = allStaff.filter(staff => {
      const role = (staff[COL.S_ROLE] || '').toLowerCase();
      return !role.includes('admin');
    });
  } else {
    // Người dùng thường chỉ có thể giao việc cho chính mình
    assignableStaff = allStaff.filter(staff => staff[COL.S_NAME] === currentUser.name);
  }
  
  // Đảm bảo danh sách người thực hiện được hiển thị đúng
  console.log("Danh sách người có thể giao việc:", assignableStaff.map(s => s[COL.S_NAME]));
  
  return `
      <div id="task-modal" class="modal">
          <div class="modal-content">
              <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                  <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                         Đóng
                     </button>
              </div>
              
              <form id="task-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.T_ID]}">` : ''}
                  
                  <div class="form-group">
                      <label class="form-label">Tên nhiệm vụ *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.T_NAME] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Thuộc dự án *</label>
                      <select name="projectId" class="form-select" required>
                          <option value="">-- Chọn dự án --</option>
                          ${(isAdmin() || isManager() ? allProjects : getUserAllowedProjects()).map(project => {
                              const selected = isEdit && data[COL.T_PID] === project[COL.P_ID] ? 'selected' : '';
                              return `<option value="${project[COL.P_ID]}" ${selected}>${project[COL.P_NAME]} (${project[COL.P_ID]})</option>`;
                          }).join('')}
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Mô tả</label>
                      <textarea name="description" class="form-textarea">${isEdit ? data[COL.T_DESC] || '' : ''}</textarea>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Người thực hiện</label>
                          <select name="assignee" class="form-select">
                              <option value="">-- Chọn người thực hiện --</option>
                              ${assignableStaff.map(staff => {
                                  const selected = isEdit && data[COL.T_ASSIGNEE] === staff[COL.S_NAME] ? 'selected' : '';
                                  const staffEmail = staff[COL.S_EMAIL] ? ` (${staff[COL.S_EMAIL]})` : '';
                                  return `<option value="${staff[COL.S_NAME]}" ${selected}>${staff[COL.S_NAME]}${staffEmail}</option>`;
                              }).join('')}
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ưu tiên</label>
                          <select name="priority" class="form-select">
                              <option value="Thấp" ${isEdit && data[COL.T_PRIORITY] === 'Thấp' ? 'selected' : ''}>Thấp</option>
                              <option value="Trung bình" ${isEdit && data[COL.T_PRIORITY] === 'Trung bình' ? 'selected' : 'selected'}>Trung bình</option>
                              <option value="Cao" ${isEdit && data[COL.T_PRIORITY] === 'Cao' ? 'selected' : ''}>Cao</option>
                          </select>
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Ngày bắt đầu</label>
                          <input type="date" name="startDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_START]) : ''}">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Hạn chót</label>
                          <input type="date" name="dueDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_DUE]) : ''}">
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label">Trạng thái</label>
                          <select name="status" class="form-select">
                              <option value="Chưa bắt đầu" ${isEdit && data[COL.T_STATUS] === 'Chưa bắt đầu' ? 'selected' : 'selected'}>Chưa bắt đầu</option>
                              <option value="Đang thực hiện" ${isEdit && data[COL.T_STATUS] === 'Đang thực hiện' ? 'selected' : ''}>Đang thực hiện</option>
                              <option value="Hoàn thành" ${isEdit && data[COL.T_STATUS] === 'Hoàn thành' ? 'selected' : ''}>Hoàn thành</option>
                              <option value="Tạm dừng" ${isEdit && data[COL.T_STATUS] === 'Tạm dừng' ? 'selected' : ''}>Tạm dừng</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Tiến độ (%)</label>
                          <input type="number" name="completion" class="form-input" min="0" max="100" value="${isEdit ? parseInt(data[COL.T_COMPLETION] || 0) : 0}">
                      </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Ngày báo cáo</label>
                    <input type="date" name="reportDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_REPORT_DATE]) : ''}">
                  </div>

                  <div class="form-group">
                    <label class="form-label">Mục tiêu</label>
                    <textarea name="target" class="form-textarea">${isEdit ? data[COL.T_TARGET] || '' : ''}</textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Link kết quả</label>
                    <textarea name="resultLinks" class="form-textarea" placeholder="Nhập mỗi link trên một dòng">${isEdit ? data[COL.T_RESULT_LINKS] || '' : ''}</textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Kết quả đầu ra</label>
                    <textarea name="output" class="form-textarea">${isEdit ? data[COL.T_OUTPUT] || '' : ''}</textarea>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Ghi chú</label>
                      <textarea name="notes" class="form-textarea">${isEdit ? data[COL.T_NOTES] || '' : ''}</textarea>
                  </div>
                  
                  <div class="flex justify-end space-x-3 mt-6">
                      <button type="button" class="btn-secondary close-modal">Hủy</button>
                      <button type="submit" class="btn-primary">${submitText}</button>
                  </div>
              </form>
          </div>
      </div>
  `;
}

function createStaffModal(isEdit, data) {
  const title = isEdit ? 'Chỉnh sửa nhân viên' : 'Thêm nhân viên mới';
  const submitText = isEdit ? 'Cập nhật' : 'Thêm nhân viên';
  
  return `
      <div id="staff-modal" class="modal">
          <div class="modal-content">
              <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                  <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                         Đóng
                     </button>
              </div>
              
              <form id="staff-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.S_ID]}">` : ''}
                  
                  <div class="form-group">
                      <label class="form-label">Họ tên *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.S_NAME] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" name="email" class="form-input" value="${isEdit ? data[COL.S_EMAIL] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Chức vụ</label>
                      <input type="text" name="position" class="form-input" value="${isEdit ? data[COL.S_POS] || '' : ''}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Phân quyền</label>
                      <select name="role" class="permission-select">
                          <option value="Nhân viên" ${isEdit && data[COL.S_ROLE] === 'Nhân viên' ? 'selected' : 'selected'}>Nhân viên</option>
                          <option value="Quản lý" ${isEdit && data[COL.S_ROLE] === 'Quản lý' ? 'selected' : ''}>Quản lý</option>
                          <option value="Admin" ${isEdit && data[COL.S_ROLE] === 'Admin' ? 'selected' : ''}>Admin</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Mật khẩu *</label>
                      <input type="text" name="password" class="form-input" required 
                             value="${isEdit ? data[COL.S_PASSWORD] || '' : ''}"
                             placeholder="Nhập mật khẩu">
                  </div>
                  
                  <div class="flex justify-end space-x-3 mt-6">
                      <button type="button" class="btn-secondary close-modal">Hủy</button>
                      <button type="submit" class="btn-primary">${submitText}</button>
                  </div>
              </form>
          </div>
      </div>
  `;
}

// === Enhanced Form Handlers with Button Loading ===
function handleAdd(type) {
    if (!isAuthenticated) {
        showToast('Vui lòng đăng nhập', 'error');
        return;
    }
    
    const form = document.getElementById(`${type}-form`);
    const submitBtn = form.querySelector('button[type="submit"]');
    const formData = new FormData(form);
    
    let data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // THÊM: Validation cho task của user thường
    if (type === 'task' && !isAdmin()) {
        const selectedProjectId = data.projectId;
        const allowedProjects = getUserAllowedProjects();
        const isAllowed = allowedProjects.some(p => p[COL.P_ID] === selectedProjectId);
        
        if (!isAllowed) {
            showToast('Bạn chỉ có thể tạo nhiệm vụ trong các dự án mà bạn đã được giao việc', 'error');
            return;
        }
    }
    
    // Set button loading state
    setButtonLoading(submitBtn, true);
    
    let apiMethod = '';
    if (type === 'project') apiMethod = 'addProjectWithAuth';
    else if (type === 'task') apiMethod = 'addTaskWithAuth';
    else if (type === 'staff') apiMethod = 'addStaffWithAuth';
    else if (type === 'notification') apiMethod = 'addNotificationWithAuth';
    
    google.script.run
        .withSuccessHandler(function(response) {
            setButtonLoading(submitBtn, false);
            if (response.success) {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} đã được tạo thành công!`, 'success');
                closeModal(`${type}-modal`);
                refreshData(); // Refresh data instead of full initialization
            } else {
                showToast(response.error || 'Có lỗi xảy ra', 'error');
            }
        })
        .withFailureHandler(function(error) {
            setButtonLoading(submitBtn, false);
            showToast('Lỗi: ' + error.message, 'error');
        })
        [apiMethod](data);
}

function handleEdit(type, originalData) {
    if (!isAuthenticated) {
        showToast('Vui lòng đăng nhập', 'error');
        return;
    }
    
    const form = document.getElementById(`${type}-form`);
    const submitBtn = form.querySelector('button[type="submit"]');
    const formData = new FormData(form);
    
    let data = {};
    for (let [key, value] of formData.entries()) {
        if (key !== 'id') data[key] = value;
    }
    
    const id = formData.get('id');
    
    // Set button loading state
    setButtonLoading(submitBtn, true);
    
    let apiMethod = '';
    if (type === 'project') apiMethod = 'updateProjectWithAuth';
    else if (type === 'task') apiMethod = 'updateTaskWithAuth';
    else if (type === 'staff') apiMethod = 'updateStaffWithAuth';
    
    google.script.run
        .withSuccessHandler(function(response) {
            setButtonLoading(submitBtn, false);
            if (response.success) {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} đã được cập nhật thành công!`, 'success');
                closeModal(`${type}-modal`);
                refreshData(); // Refresh data instead of full initialization
            } else {
                showToast(response.error || 'Có lỗi xảy ra', 'error');
            }
        })
        .withFailureHandler(function(error) {
            setButtonLoading(submitBtn, false);
            showToast('Lỗi: ' + error.message, 'error');
        })
        [apiMethod](id, data);
}

function confirmDelete(type, id, name) {
    if (!isAuthenticated) {
        showToast('Vui lòng đăng nhập', 'error');
        return;
    }
    
    if (confirm(`Bạn có chắc chắn muốn xóa ${type} "${name}"?`)) {
        // Find the delete button and set loading
        const deleteBtn = document.querySelector(`[data-type="${type}"][data-id="${id}"].delete-btn`);
        if (deleteBtn) setButtonLoading(deleteBtn, true);
        
        let apiMethod = '';
        if (type === 'project') apiMethod = 'deleteProjectWithAuth';
        else if (type === 'task') apiMethod = 'deleteTaskWithAuth';
        else if (type === 'staff') apiMethod = 'deleteStaffWithAuth';
        
        google.script.run
            .withSuccessHandler(function(response) {
                if (deleteBtn) setButtonLoading(deleteBtn, false);
                if (response.success) {
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} đã được xóa thành công!`, 'success');
                    refreshData(); // Refresh data instead of full initialization
                } else {
                    showToast(response.error || 'Có lỗi xảy ra', 'error');
                }
            })
            .withFailureHandler(function(error) {
                if (deleteBtn) setButtonLoading(deleteBtn, false);
                showToast('Lỗi: ' + error.message, 'error');
            })
            [apiMethod](id);
    }
}

function refreshData() {
    if (!isAuthenticated) return;
    
    // showLoading('Đang cập nhật dữ liệu...');
    
    google.script.run
        .withSuccessHandler(function(response) {
            // hideLoading();
            if (response.success) {
                handleSuccessfulLogin(response);
            } else {
                showToast(response.error || 'Lỗi khi tải dữ liệu', 'error');
            }
        })
        .withFailureHandler(function(error) {
            // hideLoading();
            showToast('Lỗi khi tải dữ liệu: ' + error.message, 'error');
        })
        .getDataForUser();
}

// === Button Loading State Management ===
function setButtonLoading(button, isLoading) {
    if (!button) return;
    
    if (isLoading) {
        button.classList.add('loading');
        button.disabled = true;
        // Store original content
        if (!button.dataset.originalContent) {
            button.dataset.originalContent = button.innerHTML;
        }
        button.innerHTML = '';
    } else {
        button.classList.remove('loading');
        button.disabled = false;
        // Restore original content
        if (button.dataset.originalContent) {
            button.innerHTML = button.dataset.originalContent;
        }
    }
}

// === Utility Functions ===
function populateDropdowns() {
    // This is handled in modal creation
}

function handleSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    // Filter current section data
    if (currentSection === 'projects') {
        filterCards('.project-card', searchTerm);
    } else if (currentSection === 'tasks') {
        filterCards('.task-card', searchTerm);
    } else if (currentSection === 'staff') {
        filterCards('.staff-card', searchTerm);
    }
}

function handleProjectTaskSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    // Filter project tree items
    const projectItems = document.querySelectorAll('.project-tree-item');
    projectItems.forEach(item => {
        const projectText = item.textContent.toLowerCase();
        const projectId = item.dataset.id.toLowerCase();
        
        // Check if project matches search
        const projectMatches = projectText.includes(searchTerm) || projectId.includes(searchTerm);
        
        // Check if any tasks within project match search
        const taskItems = item.querySelectorAll('.task-tree-item');
        let hasMatchingTask = false;
        
        taskItems.forEach(taskItem => {
            const taskText = taskItem.textContent.toLowerCase();
            const taskId = taskItem.dataset.id.toLowerCase();
            const taskMatches = taskText.includes(searchTerm) || taskId.includes(searchTerm);
            
            // Nếu dự án match thì hiển thị tất cả task, ngược lại chỉ hiển thị task match
            const shouldShowTask = projectMatches || taskMatches || searchTerm === '';
            taskItem.style.display = shouldShowTask ? 'block' : 'none';
            if (taskMatches) hasMatchingTask = true;
        });
        
        // Show project if it matches or has matching tasks
        const shouldShowProject = projectMatches || hasMatchingTask || searchTerm === '';
        item.style.display = shouldShowProject ? 'block' : 'none';
        
        // Tự động expand nếu: project match HOẶC có task match
        if (shouldShowProject && (projectMatches || hasMatchingTask) && searchTerm !== '') {
            const tasksContainer = item.querySelector('.project-tasks');
            const expandBtn = item.querySelector('.project-expand-btn');
            if (tasksContainer && expandBtn) {
                tasksContainer.classList.add('expanded');
                const icon = expandBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
                expandBtn.classList.add('expanded');
            }
        }
    });
}

function filterCards(selector, searchTerm) {
    const cards = document.querySelectorAll(selector);
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        const id = card.dataset.id.toLowerCase();
        const isVisible = text.includes(searchTerm) || id.includes(searchTerm);
        card.style.display = isVisible ? 'block' : 'none';
    });
}

function toggleNotifications() {
    // Handled by Alpine.js
}

function markNotificationRead(notificationId, element) {
    if (!notificationId || element.classList.contains('opacity-60')) return;
    
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                element.classList.add('opacity-60');
                const dot = element.querySelector('.w-2.h-2');
                if (dot) dot.classList.replace('bg-blue-500', 'bg-gray-300');
                
                // Update badge
                const badge = document.getElementById('notification-badge');
                const currentCount = parseInt(badge.textContent) || 0;
                if (currentCount > 1) {
                    badge.textContent = currentCount - 1;
                } else {
                    badge.classList.add('hidden');
                }
            }
        })
        .withFailureHandler(function(error) {
            showToast('Lỗi cập nhật thông báo: ' + error.message, 'error');
        })
        .markNotificationAsRead(notificationId);
}

function clearNotifications() {
    if (confirm('Xóa tất cả thông báo đã đọc?')) {
        // ✅ HIỂN THỊ LOADING
        const clearBtn = document.getElementById('clear-notifications');
        if (clearBtn) {
            clearBtn.textContent = 'Đang xóa...';
            clearBtn.disabled = true;
        }
        
        google.script.run
            .withSuccessHandler(function(response) {
                // ✅ RESET BUTTON
                if (clearBtn) {
                    clearBtn.textContent = 'Xóa đã đọc';
                    clearBtn.disabled = false;
                }
                
                if (response.success) {
                    showToast(`Đã xóa ${response.deletedCount || 0} thông báo`, 'success');
                    // ✅ REFRESH NOTIFICATIONS
                    refreshNotifications();
                } else {
                    showToast(response.error || 'Lỗi xóa thông báo', 'error');
                }
            })
            .withFailureHandler(function(error) {
                // ✅ RESET BUTTON ON ERROR
                if (clearBtn) {
                    clearBtn.textContent = 'Xóa đã đọc';
                    clearBtn.disabled = false;
                }
                showToast('Lỗi: ' + error.message, 'error');
            })
            .clearReadNotifications();
    }
}

// ✅ THÊM HÀM REFRESH NOTIFICATIONS
function refreshNotifications() {
    google.script.run
        .withSuccessHandler(function(notifications) {
            renderNotifications(notifications);
        })
        .withFailureHandler(function(error) {
            showToast('Lỗi tải thông báo: ' + error.message, 'error');
        })
        .getNotifications();
}

function getStatusClass(status) {
    const statusLower = status.toLowerCase();
    if (statusLower.includes('hoàn thành')) return 'status-completed';
    if (statusLower.includes('đang')) return 'status-active';
    if (statusLower.includes('quá hạn')) return 'status-overdue';
    return 'status-pending';
}

function getPriorityClass(priority) {
    const priorityLower = priority.toLowerCase();
    if (priorityLower.includes('cao')) return 'priority-high';
    if (priorityLower.includes('thấp')) return 'priority-low';
    return 'priority-medium';
}

function isTaskOverdue(dueDate) {
    if (!dueDate) return false;
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const due = new Date(dueDate);
        due.setHours(0, 0, 0, 0);
        return due < today;
    } catch (e) {
        return false;
    }
}

function formatDateForDisplay(dateInput, includeTime = false) {
    if (!dateInput) return '';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return dateInput;
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        let formatted = `${day}/${month}/${year}`;
        
        if (includeTime) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            formatted += ` ${hours}:${minutes}`;
        }
        
        return formatted;
    } catch (e) {
        return dateInput;
    }
}

function formatDateForInput(dateInput) {
    if (!dateInput) return '';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return '';
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    } catch (e) {
        return '';
    }
}

function showLoading(message = 'Đang xử lý...') {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.remove('hidden');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: 'fa-check-circle text-green-500',
        error: 'fa-exclamation-circle text-red-500',
        info: 'fa-info-circle text-blue-500'
    };
    
    toast.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas ${icons[type] || icons.info}"></i>
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                Đóng
            </button>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Show animation
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function getUserAllowedProjects() {
  if (isAdmin()) {
    return allProjects;
  }
  
  if (isManager()) {
    // Quản lý chỉ thấy dự án họ quản lý hoặc có nhiệm vụ
    const managerProjects = allProjects.filter(project => 
      project[COL.P_MANAGER] === currentUser.name
    );
    
    // Thêm các dự án mà quản lý có nhiệm vụ
    const managerTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
    const taskProjectIds = [...new Set(managerTasks.map(task => task[COL.T_PID]))];
    
    const projectIds = new Set([
      ...managerProjects.map(p => p[COL.P_ID]),
      ...taskProjectIds
    ]);
    
    return allProjects.filter(project => projectIds.has(project[COL.P_ID]));
  }
  
  // Người dùng thường - dự án họ có nhiệm vụ hoặc quản lý
  const userTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
  const userTaskProjectIds = [...new Set(userTasks.map(task => task[COL.T_PID]))];
  
  // Thêm các dự án mà người dùng là người quản lý
  const managedProjects = allProjects.filter(project => project[COL.P_MANAGER] === currentUser.name);
  const managedProjectIds = managedProjects.map(p => p[COL.P_ID]);
  
  const projectIds = new Set([...userTaskProjectIds, ...managedProjectIds]);
  
  return allProjects.filter(project => projectIds.has(project[COL.P_ID]));
}

function canUserCreateTask() {
  if (isAdmin() || isManager()) {
    return true;
  }
  
  // User thường có thể tạo task nếu họ là người được phụ trách dự án hoặc đã có task
  if (currentUser) {
    // Kiểm tra xem user có phải là người phụ trách dự án nào không
    const userManagedProjects = allProjects.filter(project => 
      project[COL.P_MANAGER] === currentUser.name
    );
    
    if (userManagedProjects.length > 0) {
      return true;
    }
    
    // Hoặc kiểm tra nếu user đã có nhiệm vụ trong hệ thống
    if (allTasks) {
      const userTasks = allTasks.filter(task => task[COL.T_ASSIGNEE] === currentUser.name);
      return userTasks.length > 0;
    }
  }
  
  return false;
}

function createNotificationModal(isEdit, data) {
  return `
    <div id="notification-modal" class="modal">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900">Tạo thông báo mới</h3>
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            Đóng
          </button>
        </div>
        
        <form id="notification-form">
          <div class="form-group">
            <label class="form-label">Nội dung thông báo *</label>
            <textarea name="content" class="form-textarea" required placeholder="Nhập nội dung thông báo..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Người nhận</label>
            <select name="recipient" class="form-select">
              <option value="">Tất cả mọi người</option>
              ${allStaff.map(staff => 
                `<option value="${staff[COL.S_NAME]}">${staff[COL.S_NAME]} (${staff[COL.S_EMAIL] || 'No email'})</option>`
              ).join('')}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Loại thông báo</label>
            <select name="type" class="form-select">
              <option value="Thông báo">Thông báo chung</option>
              <option value="Khẩn cấp">Khẩn cấp</option>
              <option value="Công việc">Công việc</option>
              <option value="Hệ thống">Hệ thống</option>
            </select>
          </div>
          
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" class="btn-secondary close-modal">Hủy</button>
            <button type="submit" class="btn-primary">Gửi thông báo</button>
          </div>
        </form>
      </div>
    </div>
  `;
}

// === Gantt Chart Functions ===
function renderGanttChart() {
  if (currentSection !== 'gantt') return;
  
  const ganttContainer = document.getElementById('gantt-container');
  const ganttHeader = document.getElementById('gantt-header');
  const ganttItems = document.getElementById('gantt-items');
  const currentPeriod = document.getElementById('current-period');
  
  if (!ganttContainer || !ganttHeader || !ganttItems || !currentPeriod) return;
  
  // Cập nhật tiêu đề kỳ hiển thị
  const monthName = currentGanttDate.toLocaleString('vi-VN', { month: 'long' });
  const year = currentGanttDate.getFullYear();
  currentPeriod.textContent = `${monthName} ${year}`;
  
  // Tạo header với ngày trong tháng
  const daysInMonth = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0).getDate();
  const firstDay = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth(), 1);
  const daysHeader = document.querySelector('.gantt-days');
  
  // Sửa lại CSS cho phần header ngày để hiển thị ngang
  daysHeader.style.display = 'flex';
  daysHeader.style.flexDirection = 'row';
  
  let daysHTML = '';
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth(), day);
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const isToday = isSameDate(date, new Date());
    const dayName = date.toLocaleString('vi-VN', { weekday: 'short' });
    
    daysHTML += `
      <div class="gantt-day ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
        <div class="gantt-day-number">${day}</div>
        <div class="gantt-day-label">${dayName}</div>
      </div>
    `;
  }
  daysHeader.innerHTML = daysHTML;
  
  // Hiển thị dự án và nhiệm vụ
  let itemsHTML = '';

  // Hiển thị cả dự án và nhiệm vụ theo nhóm
  allProjects.forEach(project => {
    const projectStartDate = new Date(project[COL.P_START]);
    const projectEndDate = new Date(project[COL.P_END]);
    
    // Kiểm tra xem dự án có hiển thị trong tháng hiện tại không
    if (isDateInMonth(projectStartDate, currentGanttDate) || 
        isDateInMonth(projectEndDate, currentGanttDate) || 
        (projectStartDate < firstDay && projectEndDate > new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0))) {
      
      // === RENDER PROJECT ===
      const projectGanttBarStyle = calculateGanttBarStyle(projectStartDate, projectEndDate, currentGanttDate, daysInMonth);
      const projectTasks = allTasks.filter(task => task[COL.T_PID] === project[COL.P_ID]);
      const completedProjectTasks = projectTasks.filter(task => (task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành')).length;
      const projectProgressPercent = projectTasks.length > 0 ? Math.round((completedProjectTasks / projectTasks.length) * 100) : 0;
      const projectIsOverdue = new Date() > projectEndDate && projectProgressPercent < 100;
      const projectFormattedStartDate = formatDateForGantt(project[COL.P_START]);
      const projectFormattedEndDate = formatDateForGantt(project[COL.P_END]);
      const projectDescription = project[COL.P_DESC] || 'Không có mô tả';
      const projectId = project[COL.P_ID];
      
      itemsHTML += `
        <div class="gantt-project-group" data-project-id="${projectId}">
          <div class="gantt-item" data-id="${projectId}" data-type="project">
            <div class="gantt-item-label">
              <div class="flex items-center flex-1 min-w-0">
                <button class="gantt-toggle-btn mr-2 hover:bg-gray-100 rounded transition-colors duration-200 flex-shrink-0" data-project="${projectId}">
                  ∨
                </button>
                
                <span class="truncate cursor-pointer hover:text-blue-600 transition-colors duration-200" onclick="showProjectDetailsModal('${projectId}', '${project[COL.P_NAME]}')">${project[COL.P_NAME]}</span>
              </div>
              
              <div class="gantt-item-actions">
                <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Chỉnh sửa">
                  Sửa
                </button>
                <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${project[COL.P_NAME]}" title="Xóa">
                  Xóa
                </button>
              </div>
            </div>
            
            <div class="gantt-item-timeline">
              <div class="gantt-bar gantt-bar-project ${projectIsOverdue ? 'gantt-bar-overdue' : ''}" style="${projectGanttBarStyle}" data-tooltip="${project[COL.P_NAME]}: ${projectDescription}">
                <div class="gantt-bar-label">${projectFormattedStartDate} - ${projectFormattedEndDate}</div>
                <div class="gantt-progress" style="width: ${projectProgressPercent}%"></div>
              </div>
            </div>
          </div>
          
          <div class="gantt-project-tasks" id="gantt-tasks-${projectId}">
            ${projectTasks.map(task => {
              const taskStartDate = new Date(task[COL.T_START]);
              const taskEndDate = new Date(task[COL.T_DUE]);
              
                const projectEndDate = new Date(project[COL.P_END]);
                const lastDayOfMonth = new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0);

                // Hiển thị tất cả nhiệm vụ nếu dự án kết thúc trong hoặc sau tháng hiện tại
                if (projectEndDate >= firstDay) {
                
                // Tính toán các giá trị Gantt cho task
                const taskGanttBarStyle = calculateGanttBarStyle(taskStartDate, taskEndDate, currentGanttDate, daysInMonth);
                const taskProgressPercent = parseInt(task[COL.T_COMPLETION] || 0);
                const taskIsOverdue = isTaskOverdue(task[COL.T_DUE]) && !(task[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành');
                const taskAssignee = task[COL.T_ASSIGNEE] || 'Chưa gán';
                const taskStatus = task[COL.T_STATUS] || 'Chưa bắt đầu';
                const taskPriority = task[COL.T_PRIORITY] || 'Trung bình';
                const taskFormattedStartDate = formatDateForGantt(task[COL.T_START]);
                const taskFormattedEndDate = formatDateForGantt(task[COL.T_DUE]);
                const taskDescription = task[COL.T_DESC] || 'Không có mô tả';
                
                // Xử lý các link nếu có
                const taskLinks = task[COL.T_RESULT_LINKS] ? task[COL.T_RESULT_LINKS].split('\n').filter(link => link.trim() !== '') : [];
                const hasLinks = taskLinks.length > 0;
                
                return `
                  <div class="gantt-item gantt-task-item" data-id="${task[COL.T_ID]}" data-type="task" data-project-id="${task[COL.T_PID]}">
                    <div class="gantt-item-label">
                      <div class="flex flex-col flex-1 min-w-0">
                        <span class="truncate cursor-pointer hover:text-blue-600 transition-colors duration-200" onclick="openEditModal('task', '${task[COL.T_ID]}')">${task[COL.T_NAME]}</span>
                        <span class="text-xs text-gray-500 truncate">${taskAssignee} - ${taskStatus} - ${taskPriority}</span>
                        
                        ${hasLinks ? `
                          <div class="flex gap-2 mt-1 overflow-x-auto">
                            ${taskLinks.map((link, index) => `
                              <a href="${link}" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center flex-shrink-0">
                                Link ${index + 1}
                              </a>
                            `).join('')}
                          </div>
                        ` : ''}
                      </div>
                      
                      <div class="gantt-item-actions">
                        <button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${task[COL.T_ID]}" data-name="${task[COL.T_NAME]}" title="Xóa">
                          Xóa
                        </button>
                      </div>
                    </div>
                    
                    <div class="gantt-item-timeline">
                      ${isDateInMonth(taskStartDate, currentGanttDate) || 
                        isDateInMonth(taskEndDate, currentGanttDate) || 
                        (taskStartDate < firstDay && taskEndDate > new Date(currentGanttDate.getFullYear(), currentGanttDate.getMonth() + 1, 0)) ?
                        `<div class="gantt-bar gantt-bar-task ${taskIsOverdue ? 'gantt-bar-overdue' : ''}" style="${taskGanttBarStyle}" data-tooltip="${task[COL.T_NAME]}: ${taskDescription}">
                          <div class="gantt-bar-label">${taskFormattedStartDate} - ${taskFormattedEndDate}</div>
                          <div class="gantt-progress" style="width: ${taskProgressPercent}%"></div>
                        </div>` :
                        `<div class="gantt-non-visible-task" style="height: 20px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; font-style: italic;">
                          ${taskFormattedStartDate} - ${taskFormattedEndDate}: Không hiển thị trong tháng này
                        </div>`
                      }
                    </div>
                  </div>
                `;
              }
              return '';
            }).join('')}
          </div>
        </div>
      `;
    }
  });

  // Hiển thị trống nếu không có dữ liệu
  if (itemsHTML === '') {
    itemsHTML = '';
  }
  // Render dữ liệu
  ganttItems.innerHTML = itemsHTML;
  // Thêm sự kiện toggle cho các nút mũi tên
  document.querySelectorAll('.gantt-toggle-btn').forEach(btn => {
    // Xóa event listeners cũ trước khi thêm mới để tránh duplicate
    btn.removeEventListener('click', toggleGanttProject);
    btn.addEventListener('click', toggleGanttProject);
  });

  // Khôi phục trạng thái xổ của các dự án  
  expandedProjects.forEach(projectId => {
    const taskContainer = document.getElementById(`gantt-tasks-${projectId}`);
    const toggleBtn = document.querySelector(`.gantt-toggle-btn[data-project="${projectId}"]`);
    
    if (taskContainer && toggleBtn) {
      taskContainer.classList.remove('hidden');
      toggleBtn.textContent = '∨'; // Mũi tên xuống
    }
  });
}

// Hàm xử lý sự kiện toggle cho các nút mũi tên trong Gantt chart
function toggleGanttProject(event) {
  const projectId = this.dataset.project;
  const taskContainer = document.getElementById(`gantt-tasks-${projectId}`);
  
  // Vì mặc định hiển thị, nên ta toggle ngược lại
  if (taskContainer.classList.contains('hidden')) {
    // Nếu đang ẩn, hiển thị lại
    taskContainer.classList.remove('hidden');
    this.textContent = '∨'; // Mũi tên xuống
    expandedProjects.add(projectId);
  } else {
    // Nếu đang hiển thị, ẩn đi  
    taskContainer.classList.add('hidden');
    this.textContent = '>'; // Mũi tên phải
    expandedProjects.delete(projectId);
  }
}

// Hàm tính toán style cho gantt bar
function calculateGanttBarStyle(startDate, endDate, currentMonth, daysInMonth) {
  // Đảm bảo ngày bắt đầu và kết thúc hợp lệ
  if (!startDate || isNaN(startDate.getTime())) {
    startDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
  }
  
  if (!endDate || isNaN(endDate.getTime())) {
    endDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), daysInMonth);
  }
  
  // Ngày đầu và cuối tháng
  const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
  const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), daysInMonth);
  
  // Nếu cả startDate và endDate đều nằm ngoài tháng hiện tại
  if (startDate < monthStart && endDate > monthEnd) {
    return 'left: 0; width: 100%;';
  }
  
  // Điều chỉnh startDate và endDate trong phạm vi tháng hiện tại
  const effectiveStartDate = startDate < monthStart ? monthStart : startDate;
  const effectiveEndDate = endDate > monthEnd ? monthEnd : endDate;
  
  // Tính toán chính xác hơn
  const startDay = effectiveStartDate.getDate();
  const endDay = effectiveEndDate.getDate();
  
  // Tính vị trí bắt đầu và kết thúc theo phần trăm
  // Mỗi ngày chiếm 1/daysInMonth của chiều rộng
  const dayWidth = 100 / daysInMonth;
  const leftPercent = (startDay - 1) * dayWidth;
  const widthPercent = (endDay - startDay + 1) * dayWidth;
  
  return `left: ${leftPercent}%; width: ${widthPercent}%;`;
}

// Kiểm tra xem một ngày có nằm trong tháng không
function isDateInMonth(date, monthDate) {
  if (!date || isNaN(date.getTime())) return false;
  return date.getMonth() === monthDate.getMonth() && date.getFullYear() === monthDate.getFullYear();
}

// Kiểm tra xem hai ngày có giống nhau không
function isSameDate(date1, date2) {
  return date1.getDate() === date2.getDate() && 
         date1.getMonth() === date2.getMonth() && 
         date1.getFullYear() === date2.getFullYear();
}

// Hàm điều hướng tháng trước/sau
function navigateGanttMonth(direction) {
  const newDate = new Date(currentGanttDate);
  newDate.setMonth(newDate.getMonth() + direction);
  currentGanttDate = newDate;
  renderGanttChart();
  
  // Thêm timeout ngắn để đảm bảo DOM đã được cập nhật trước khi thiết lập lại event listeners
  setTimeout(() => {
    setupGanttEventListeners();
  }, 50);
}

// Hàm tìm kiếm trong Gantt chart
function searchGantt(searchTerm) {
  if (!searchTerm) {
    // Hiển thị lại tất cả các item
    document.querySelectorAll('.gantt-item').forEach(item => {
      item.style.display = 'flex';
    });
    return;
  }
  
  const lowerSearchTerm = searchTerm.toLowerCase();
  
  // Lọc các item theo term tìm kiếm
  document.querySelectorAll('.gantt-item').forEach(item => {
    const itemText = item.querySelector('.gantt-item-label').textContent.toLowerCase();
    const matches = itemText.includes(lowerSearchTerm);
    
    item.style.display = matches ? 'flex' : 'none';
  });
}

// Thêm vào hàm setupEventListeners
function setupGanttEventListeners() {
  console.log('Setting up Gantt event listeners'); // Log để debug
  
  // Điều hướng tháng - gỡ bỏ event listener cũ nếu có
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  
  if (prevMonthBtn) {
    prevMonthBtn.replaceWith(prevMonthBtn.cloneNode(true));
    document.getElementById('prev-month').addEventListener('click', () => navigateGanttMonth(-1));
  }
  
  if (nextMonthBtn) {
    nextMonthBtn.replaceWith(nextMonthBtn.cloneNode(true));
    document.getElementById('next-month').addEventListener('click', () => navigateGanttMonth(1));
  }
  
  // Tìm kiếm - thêm xử lý cho icon button với cleanup
  const searchBtn = document.getElementById('gantt-search-btn');
  const searchInput = document.getElementById('gantt-search');
  if (searchBtn && searchInput) {
    console.log('Setting up search button listener'); // Debug log
    // Cleanup old event listeners by replacing elements
    const newSearchBtn = searchBtn.cloneNode(true);
    searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn);
    
    // Add new event listener
    newSearchBtn.addEventListener('click', (e) => {
      console.log('Search button clicked'); // Debug log
      e.preventDefault();
      e.stopPropagation();
      searchInput.classList.toggle('hidden');
      console.log('Search input hidden class:', searchInput.classList.contains('hidden')); // Debug log
      if (!searchInput.classList.contains('hidden')) {
        setTimeout(() => searchInput.focus(), 100);
      }
    });
    
    // Setup search input listener
    searchInput.removeEventListener('input', handleGanttSearch);
    searchInput.addEventListener('input', handleGanttSearch);
  } else {
    console.log('Search elements not found:', { searchBtn, searchInput }); // Debug log
  }
}

// Thêm hàm mới này để xử lý sự kiện tìm kiếm
function handleGanttSearch(e) {
  searchGantt(e.target.value);
}

function formatDateForGantt(dateInput) {
    if (!dateInput) return '';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return '';
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        
        return `${day}/${month}`;
    } catch (e) {
        return '';
    }
}

function getStatusIcon(status) {
    const statusLower = (status || '').toLowerCase();
    if (statusLower.includes('hoàn thành')) return 'text-green-500';
    if (statusLower.includes('đang')) return 'text-blue-500'; 
    if (statusLower.includes('tạm dừng')) return 'text-yellow-500';
    return 'text-gray-400'; // Chưa bắt đầu
}

// Thêm hàm mới sau các hàm utility
function formatTaskLinks(linksText) {
  if (!linksText) return '';
  
  // Tách các link theo dòng mới
  const links = linksText.split('\n').filter(link => link.trim() !== '');
  
  if (links.length === 0) return '';
  
  // Tạo HTML cho các link
  return links.map(link => {
    const url = link.trim();
    if (!url) return '';
    
    // Xác định loại link và icon
    let icon = 'fas fa-link';
    let domain = '';
    
    try {
      const urlObj = new URL(url);
      domain = urlObj.hostname;
      
      if (domain.includes('drive.google.com')) icon = 'fab fa-google-drive';
      else if (domain.includes('docs.google.com')) icon = 'fas fa-file-alt';
      else if (domain.includes('sheets.google.com')) icon = 'fas fa-table';
      else if (domain.includes('github.com')) icon = 'fab fa-github';
      else if (domain.includes('figma.com')) icon = 'fab fa-figma';
    } catch (e) {
      domain = 'Invalid URL';
    }
    
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" 
               class="result-link" title="${url}">
              <i class="${icon}"></i> ${domain || 'Link'}
            </a>`;
  }).join('');
}

// === SMART SYNC SYSTEM ===

// Initialize sync system
function initializeSyncSystem() {
  if (!isAuthenticated) return;
  
  console.log('🔄 Initializing Smart Sync System');
  
  // Start periodic sync intervals
  startSyncIntervals();
  
  // Setup visibility change handler
  document.addEventListener('visibilitychange', handleVisibilityChange);
  
  // Set initial sync time
  lastSyncTime = new Date();
  updateSyncIndicator();
  
  // Update sync indicator every minute
  setInterval(updateSyncIndicator, 60000);
}

// Start sync intervals
function startSyncIntervals() {
  // Clear existing intervals
  stopSyncIntervals();
  
  // Notification sync (more frequent)
  syncIntervals.notifications = setInterval(() => {
    if (!userIsInteracting && isAuthenticated) {
      performNotificationSync();
    }
  }, SYNC_CONFIG.NOTIFICATION_INTERVAL);
  
  // Data sync (less frequent)
  syncIntervals.data = setInterval(() => {
    if (!userIsInteracting && isAuthenticated) {
      performDataSync();
    }
  }, SYNC_CONFIG.DATA_INTERVAL);
  
  console.log('🔄 Sync intervals started');
}

// Stop sync intervals
function stopSyncIntervals() {
  if (syncIntervals.notifications) {
    clearInterval(syncIntervals.notifications);
    syncIntervals.notifications = null;
  }
  
  if (syncIntervals.data) {
    clearInterval(syncIntervals.data);
    syncIntervals.data = null;
  }
  
  console.log('🔄 Sync intervals stopped');
}

// Setup user interaction detection
function setupUserInteractionDetection() {
  const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
  
  events.forEach(event => {
    document.addEventListener(event, () => {
      userIsInteracting = true;
      
      // Clear previous timeout
      if (interactionTimeout) {
        clearTimeout(interactionTimeout);
      }
      
      // Set timeout to mark user as not interacting
      interactionTimeout = setTimeout(() => {
        userIsInteracting = false;
      }, SYNC_CONFIG.USER_INTERACTION_DELAY);
    });
  });
}

// Handle visibility change (when user switches tabs)
function handleVisibilityChange() {
  if (!document.hidden && isAuthenticated) {
    // User came back to tab, perform immediate sync
    console.log('🔄 User returned, performing immediate sync');
    performImmediateSync();
  }
}

// Manual sync triggered by user
function handleManualSync() {
  if (isSyncing) return;
  
  console.log('🔄 Manual sync triggered');
  performImmediateSync(true); // Pass true for manual sync
}

// Perform immediate sync
async function performImmediateSync(isManual = false) {
  if (isSyncing) return;
  
  setSyncingState(true, isManual);
  
  try {
    await Promise.all([
      performNotificationSync(),
      performDataSync()
    ]);
    
    // Removed success toast - too distracting
    // showSyncToast('Dữ liệu đã được đồng bộ', 'success');
  } catch (error) {
    console.error('Sync error:', error);
    showSyncToast('Lỗi khi đồng bộ dữ liệu', 'error');
  } finally {
    setSyncingState(false, isManual);
  }
}

// Perform notification sync
async function performNotificationSync() {
  try {
    console.log('🔔 Syncing notifications...');
    
    // Set subtle visual indicator for auto sync
    const syncIcon = document.getElementById('sync-icon');
    if (syncIcon) syncIcon.style.color = '#9CA3AF'; // gray-400
    
    const response = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getNotifications();
    });
    
    if (response && response.length !== undefined) {
      const currentCount = allNotifications ? allNotifications.length : 0;
      const newCount = response.length;
      
      // Removed notification toast - too distracting
      // if (newCount > currentCount) {
      //   const newNotifications = newCount - currentCount;
      //   showSyncToast(`${newNotifications} thông báo mới`, 'info');
      // }
      
      // Update global notifications data
      allNotifications = response;
      
      // Only re-render if user is not viewing notifications
      if (currentSection !== 'notifications' && !isNotificationPanelOpen()) {
        renderNotifications(response);
      }
      
      updateNotificationBadge();
    }
    
    // Reset icon color
    if (syncIcon) syncIcon.style.color = '';
  } catch (error) {
    console.error('Notification sync error:', error);
    // Reset icon color on error
    const syncIcon = document.getElementById('sync-icon');
    if (syncIcon) syncIcon.style.color = '';
  }
}

// Perform data sync
async function performDataSync() {
  try {
    console.log('📊 Syncing data...');
    
    // Set subtle visual indicator for auto sync
    const syncIcon = document.getElementById('sync-icon');
    if (syncIcon) syncIcon.style.color = '#9CA3AF'; // gray-400
    
    const response = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getInitialData();
    });
    
    if (response && !response.error) {
      // Compare and update data
      const hasChanges = compareAndUpdateData(response);
      
      if (hasChanges) {
        // Update UI elements that don't disrupt user
        updateBackgroundElements();
      }
      
      lastSyncTime = new Date();
      updateSyncIndicator();
    }
    
    // Reset icon color
    if (syncIcon) syncIcon.style.color = '';
  } catch (error) {
    console.error('Data sync error:', error);
    // Reset icon color on error
    const syncIcon = document.getElementById('sync-icon');
    if (syncIcon) syncIcon.style.color = '';
  }
}

// Compare and update data
function compareAndUpdateData(newData) {
  let hasChanges = false;
  
  // Compare projects
  if (JSON.stringify(allProjects) !== JSON.stringify(newData.projects || [])) {
    allProjects = newData.projects || [];
    hasChanges = true;
  }
  
  // Compare tasks
  if (JSON.stringify(allTasks) !== JSON.stringify(newData.tasks || [])) {
    allTasks = newData.tasks || [];
    hasChanges = true;
  }
  
  // Compare staff
  if (JSON.stringify(allStaff) !== JSON.stringify(newData.staff || [])) {
    allStaff = newData.staff || [];
    hasChanges = true;
  }
  
  return hasChanges;
}

// Update background elements that don't disrupt user
function updateBackgroundElements() {
  // Always safe to update these
  const statsData = calculateStats();
  renderStats(statsData);
  
  // Update charts (they animate smoothly)
  renderChart();
  renderProjectProgressChart();
  renderStaffPerformanceChart();
  
  // Update sections only if user is not viewing them
  if (currentSection !== 'projects') {
    renderProjects();
  }
  
  if (currentSection !== 'tasks') {
    renderTasks();
  }
  
  if (currentSection !== 'staff') {
    renderStaff();
  }
  
  if (currentSection !== 'gantt') {
    // Gantt chart can be updated as it doesn't disrupt scrolling
    renderGanttChart();
  }
  
  // Always safe to update these background elements
  renderProjectTaskTree();
  renderPriorityTasks();
  populateDropdowns();
}

// Set syncing state
function setSyncingState(syncing, isManual = false) {
  isSyncing = syncing;
  const syncBtn = document.getElementById('sync-btn');
  const syncIcon = document.getElementById('sync-icon');
  
  if (syncBtn) {
    if (syncing) {
      if (isManual) {
        // Manual sync - show spinning animation
        syncBtn.classList.add('syncing');
        syncBtn.title = 'Đang đồng bộ...';
      } else {
        // Auto sync - just change color to gray (subtle)
        syncIcon.style.color = '#9CA3AF'; // gray-400
        syncBtn.title = 'Đang đồng bộ ngầm...';
      }
    } else {
      // Reset to normal state
      syncBtn.classList.remove('syncing');
      syncIcon.style.color = ''; // Reset to default color
      syncBtn.title = 'Đồng bộ dữ liệu';
    }
  }
}

// Update sync indicator
function updateSyncIndicator() {
  const syncBtn = document.getElementById('sync-btn');
  
  if (syncBtn && lastSyncTime) {
    const now = new Date();
    const diffMinutes = Math.floor((now - lastSyncTime) / 60000);
    
    // Update tooltip with last sync time
    const timeText = diffMinutes < 1 ? 'vừa xong' : `${diffMinutes} phút trước`;
    syncBtn.title = `Đồng bộ lần cuối: ${timeText}`;
  }
}

// Check if notification panel is open
function isNotificationPanelOpen() {
  // This depends on your notification panel implementation
  // For Alpine.js, you might check the x-data state
  return false; // Placeholder - implement based on your notification panel
}

// Show sync toast notification
function showSyncToast(message, type = 'info') {
  // Remove any existing sync toast
  const existingToast = document.querySelector('.sync-toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = `sync-toast ${type}`;
  
  const iconClass = type === 'success' ? 'fas fa-check-circle text-green-500' :
                   type === 'error' ? 'fas fa-exclamation-circle text-red-500' :
                   'fas fa-info-circle text-blue-500';
  
  toast.innerHTML = `
    <i class="${iconClass}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  // Trigger animation
  setTimeout(() => toast.classList.add('show'), 100);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Start sync system when user logs in
function startSyncSystemForUser() {
  if (isAuthenticated) {
    initializeSyncSystem();
  }
}

// Stop sync system when user logs out
function stopSyncSystemForUser() {
  stopSyncIntervals();
  document.removeEventListener('visibilitychange', handleVisibilityChange);
  console.log('🔄 Sync system stopped');
}

// Calculate stats (helper function)
function calculateStats() {
  // Implement your stats calculation logic here
  // This should return the same format as your current stats
  return {
    totalProjects: allProjects.length,
    completedProjects: allProjects.filter(p => (p[COL.P_STATUS] || '').toLowerCase().includes('hoàn thành')).length,
    totalTasks: allTasks.length,
    completedTasks: allTasks.filter(t => (t[COL.T_STATUS] || '').toLowerCase().includes('hoàn thành')).length,
    // Add other stats as needed
  };
}
</script>